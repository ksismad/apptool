<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>App ID Analyzer ‚Äì Complete Analysis System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    * { box-sizing:border-box }
    body {
      margin:0; padding:20px;
      background:#f3f4f6;
      font-family:-apple-system,Segoe UI,sans-serif;
    }
    .container {
      max-width:1400px; margin:0 auto;
      background:#fff; border-radius:16px;
      box-shadow:0 20px 25px rgba(0,0,0,0.1); overflow:hidden;
    }
    .header {
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      color:#fff; text-align:center; padding:32px 24px; position:relative;
    }
    .header h1 { margin:0 0 12px; font-size:2.25rem }
    .header p { margin:0; opacity:.9; font-size:1rem; line-height:1.6 }
    .user-info {
      position:absolute; top:20px; right:24px;
      background:rgba(255,255,255,0.2); padding:8px 16px;
      border-radius:20px; font-size:.875rem;
      backdrop-filter:blur(10px);
    }
    .main-content { padding:32px }
    .upload-section { display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:32px }
    .upload-box {
      background:#f8fafc; border-radius:12px; padding:24px;text-align:center;
      border:2px dashed #cbd5e1; transition:.3s;
    }
    .upload-box:hover { border-color:#6366f1; transform:translateY(-2px) }
    .upload-box.has-files {
      border-color:#10b981; background:#ecfdf5;
    }
    .upload-btn {
      margin-top:16px; padding:12px 24px; border:none;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      color:#fff; border-radius:8px; font-size:1rem; font-weight:600;
      cursor:pointer; transition:.2s;
    }
    .upload-btn:hover { transform:translateY(-1px) }
    .file-info {
      display:inline-block; margin-top:12px;
      padding:8px 16px; background:#d1fae5; color:#059669;
      border-radius:6px; font-weight:600;
    }
    .file-input { display:none }
    .section {
      background:#f8fafc; border-radius:12px; padding:24px;
      margin-bottom:32px; border:1px solid #e2e8f0;
    }
    .section-title {
      display:flex; align-items:center; gap:8px;
      margin:0 0 16px; font-size:1.125rem; font-weight:600;
      color:#1e293b;
    }
    .date-filter-grid,
    .options-grid { display:grid; gap:24px }
    .date-filter-grid { grid-template-columns:1fr 1fr }
    .options-grid { grid-template-columns:repeat(auto-fit,minmax(250px,1fr)) }
    .option-group,
    .date-filter-group {
      background:#fff; padding:16px; border-radius:8px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }
    .option-label,
    .date-filter-label {
      display:block; margin-bottom:8px;
      font-weight:600; color:#374151;
    }
    .date-range {
      display:flex; align-items:center; gap:12px;
    }
    .date-input {
      flex:1; padding:8px 12px; border:1px solid #d1d5db;
      border-radius:6px; font-size:.925rem;
    }
    .checkbox-group,
    .input-group {
      display:flex; align-items:center; gap:8px;
      margin-bottom:8px;
    }
    .col-select,
    .commission-input {
      width:100%; padding:8px 12px;
      border:1px solid #d1d5db; border-radius:6px;
      font-size:.925rem; background:#fff;
    }
    .validation-item {
      display:flex; align-items:center; gap:8px;
      margin-bottom:8px; font-size:.875rem;
    }
    .validation-item.valid { color:#059669 }
    .validation-item.invalid { color:#dc2626 }
    .validation-item.valid::before { content:"‚úÖ" }
    .validation-item.invalid::before { content:"‚ùå" }
    .analyze-btn {
      width:100%; padding:16px; border:none;
      background:linear-gradient(135deg,#10b981,#059669);
      color:#fff; font-size:1.125rem; font-weight:700;
      border-radius:12px; cursor:pointer; transition:.2s;
    }
    .analyze-btn:disabled { background:#9ca3af; cursor:not-allowed }
    .analyze-btn:not(:disabled):hover { transform:translateY(-2px) }
    .stats-grid {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px; margin-bottom:32px;
    }
    .stat-card {
      background:#fff; padding:20px; border-radius:12px;
      box-shadow:0 4px 6px rgba(0,0,0,0.1); text-align:center;
      border-left:4px solid #6366f1;
    }
    .stat-card.success { border-left-color:#10b981 }
    .stat-card.warning { border-left-color:#f59e0b }
    .stat-card.danger { border-left-color:#ef4444 }
    .stat-card.commission { border-left-color:#8b5cf6 }
    .stat-number { font-size:1.875rem; font-weight:700; color:#1e293b; }
    .stat-label { font-size:.875rem; color:#64748b; font-weight:500; text-transform:uppercase; }
    .stat-meta { font-size:.75rem; color:#94a3b8; margin-top:4px }
    .table-container {
      background:#fff; border-radius:12px; overflow:hidden;
      box-shadow:0 4px 6px rgba(0,0,0,0.1); margin-bottom:24px;
    }
    .table-header {
      display:flex; justify-content:space-between; align-items:center;
      padding:16px 24px; background:#f8fafc; border-bottom:1px solid #e2e8f0;
    }
    .table-title { font-size:1.125rem; font-weight:600; color:#1e293b }
    .table-wrapper { overflow:auto; max-height:400px }
    table { width:100%; border-collapse:collapse }
    th, td {
      padding:12px 16px; border-bottom:1px solid #e2e8f0;
      font-size:.875rem; white-space:nowrap; text-align:left;
    }
    th {
      position:sticky; top:0; background:#f8fafc; cursor:pointer;
      user-select:none; font-weight:600; color:#374151;
    }
    th:hover { background:#e2e8f0 }
    th.sorted .sort-arrow { opacity:1 }
    .sort-arrow { margin-left:5px; opacity:.5 }
    tr:hover { background:#f8fafc }
    .highlight-match { background:#f0fdf4 }
    .highlight-mismatch { background:#fef2f2 }
    .highlight-missing { background:#fef3c7 }
    .status-badge {
      padding:4px 8px; border-radius:6px; font-size:.75rem; font-weight:600;
    }
    .status-badge.match { background:#d1fae5; color:#065f46 }
    .status-badge.amount-mismatch { background:#fee2e2; color:#991b1b }
    .status-badge.missing { background:#fef3c7; color:#92400e }
    .export-section { display:flex; justify-content:center; gap:16px; margin-top:32px }
    .export-btn, .view-btn {
      padding:12px 24px; border:none; border-radius:8px;
      background:#1e293b; color:#fff; font-weight:600; cursor:pointer;
      transition:.2s;
    }
    .export-btn:hover, .view-btn:hover { background:#334155; transform:translateY(-1px) }
    .view-btn { background:#4f46e5 }
    .error-msg, .success-msg {
      margin:16px 0; padding:12px 16px; border-left:4px solid;
      border-radius:8px;
    }
    .error-msg { background:#fef2f2; color:#dc2626; border-color:#dc2626 }
    .success-msg { background:#ecfdf5; color:#059669; border-color:#059669 }
    .loading, .processing { text-align:center; padding:40px; color:#6b7280 }
    .hidden { display:none !important }
    @media (max-width:768px) {
      .upload-section, .date-filter-grid, .options-grid { grid-template-columns:1fr }
      .stats-grid { grid-template-columns:repeat(auto-fit,minmax(150px,1fr)) }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div id="user-info" class="user-info"></div>
      <h1>üîç App ID Analyzer</h1>
      <p>Multi-file Excel analysis, GST, commission, filters, sorting, export</p>
    </div>
    <div class="main-content">
      <!-- Upload -->
      <div class="upload-section">
        <div class="upload-box" id="upload-box-1">
          <h3>üìÇ Source 1</h3>
          <p>Select Excel files</p>
          <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls">
          <button id="upload-btn-1" class="upload-btn">Choose Files</button>
          <div id="file-info-1" class="file-info hidden"></div>
        </div>
        <div class="upload-box" id="upload-box-2">
          <h3>üìÇ Source 2</h3>
          <p>Select Excel files</p>
          <input type="file" id="file-input-2" class="file-input" multiple accept=".xlsx,.xls">
          <button id="upload-btn-2" class="upload-btn">Choose Files</button>
          <div id="file-info-2" class="file-info hidden"></div>
        </div>
      </div>
      <!-- Filters & Options -->
      <div class="section">
        <h3 class="section-title">üìÖ Date Filters</h3>
        <div class="date-filter-grid">
          <div class="date-filter-group">
            <label class="date-filter-label">Source 1 Range</label>
            <div class="date-range">
              <input id="dateFrom1" class="date-input" type="date">
              <span>to</span>
              <input id="dateTo1" class="date-input" type="date">
            </div>
          </div>
          <div class="date-filter-group">
            <label class="date-filter-label">Source 2 Range</label>
            <div class="date-range">
              <input id="dateFrom2" class="date-input" type="date">
              <span>to</span>
              <input id="dateTo2" class="date-input" type="date">
            </div>
          </div>
        </div>
      </div>
      <div class="section">
        <h3 class="section-title">‚öôÔ∏è Analysis & Commission</h3>
        <div class="options-grid">
          <div class="option-group">
            <label class="option-label">Include Unpaid</label>
            <div class="checkbox-group">
              <input type="checkbox" id="includeUnpaid1">
              <label for="includeUnpaid1">Source 1 unpaid</label>
            </div>
          </div>
          <div class="option-group">
            <label class="option-label">GST @ 18%</label>
            <div class="checkbox-group">
              <input type="checkbox" id="applyGST">
              <label for="applyGST">Apply GST</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="gstRound">
              <label for="gstRound">Round</label>
            </div>
          </div>
          <div class="option-group">
            <label class="option-label">Commission Rate (%)</label>
            <div class="input-group">
              <input id="commissionRate" type="number" class="commission-input" placeholder="e.g. 5" min="0" max="100" step="0.01">
              <label>% paid apps</label>
            </div>
          </div>
          <div class="option-group">
            <label class="option-label">Manual Commission %</label>
            <div class="input-group">
              <input id="manualCommissionRate" type="number" class="commission-input" placeholder="e.g. 2.5" min="0" max="100" step="0.01">
              <label>% taxable</label>
            </div>
          </div>
        </div>
      </div>
      <!-- Dynamic Column Mapping -->
      <div id="source1-dynamic"></div>
      <div id="source2-dynamic"></div>
      <!-- Validation -->
      <div id="validation-status" class="section">
        <h3 class="section-title">üìã Validation</h3>
        <div id="validation-items"></div>
      </div>
      <button id="analyze-btn" class="analyze-btn" disabled>üîç Analyze</button>
      <div id="error-container"></div>
      <div id="results" class="results hidden"></div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // State
    let source1Files = [], source2Files = [], analysisResults = null;

    // Elements
    const in1 = document.getElementById('file-input-1');
    const in2 = document.getElementById('file-input-2');
    const btn1 = document.getElementById('upload-btn-1');
    const btn2 = document.getElementById('upload-btn-2');
    const analyzeBtn = document.getElementById('analyze-btn');
    const resultsDiv = document.getElementById('results');

    // Helpers
    const safeNum = v => { const n=parseFloat(v); return isNaN(n)?0:n };
    const safeStr= v => v==null?'':String(v);
    const excelToDate = s=> new Date((s-25569)*86400000);
    const parseDate = v => v?new Date(v):null;
    const toUTCDateStr = d => {
      if(!d||isNaN(d))return'';
      const dd=d.getUTCDate().toString().padStart(2,'0');
      const mm=(d.getUTCMonth()+1).toString().padStart(2,'0');
      const yy=d.getUTCFullYear();
      return `${dd}-${mm}-${yy}`;
    };

    // Validation UI
    function updateValidation(){
      const ok1 = source1Files.length>0 && source1Files.every(f=>f.cols.appId!=null&&f.cols.amount!=null);
      const ok2 = source2Files.length>0 && source2Files.every(f=>f.cols.appId!=null&&f.cols.amount!=null);
      document.getElementById('validation-items').innerHTML = [
        {t:`Source1 files (${source1Files.length})`,v:source1Files.length>0},
        {t:`Source2 files (${source2Files.length})`,v:source2Files.length>0},
        {t:'Src1 cols mapped',v:ok1},
        {t:'Src2 cols mapped',v:ok2},
      ].map(x=>`<div class="validation-item ${x.v?'valid':'invalid'}">${x.t}</div>`).join('');
      const can = ok1&&ok2;
      analyzeBtn.disabled = !can;
      analyzeBtn.textContent = can?'üîç Analyze':'üìã Complete setup';
    }

    // Auto-detect columns
    function autoDetect(headers, sample){
      const lc = headers.map(h=>safeStr(h).toLowerCase());
      const cols = { appId:null, amount:null, date:null, paid:null, commission:null };
      ['app','id'].every(w=>cols.appId = lc.findIndex(h=>h.includes('app')&&h.includes('id')));
      cols.amount = lc.findIndex(h=>h.includes('amount')||h.includes('total'));
      cols.paid = lc.findIndex(h=>h.includes('paid')||h.includes('status'));
      cols.commission = lc.findIndex(h=>h.includes('commission')||h.includes('comm'));
      if(cols.appId<0)cols.appId=null;
      if(cols.amount<0)cols.amount=null;
      if(cols.paid<0)cols.paid=null;
      if(cols.commission<0)cols.commission=null;
      // date by sampling
      const scores = Array(headers.length).fill(0);
      sample.slice(0,15).forEach(r=>{
        if(Array.isArray(r)){
          r.forEach((c,i)=>{ if(parseDate(c)||(!isNaN(c)&&+c>60))scores[i]++ });
        }
      });
      const idx = scores.indexOf(Math.max(...scores));
      if(idx>=0 && scores[idx]>0)cols.date = idx;
      return cols;
    }

    // Render column selectors
    function renderMapping(container, headers, cols, src){
      const opts = headers.map((h,i)=>`<option value="${i}" ${cols.appId===i||cols.amount===i||cols.date===i||cols.paid===i||cols.commission===i?'selected':''}>${h||'Col '+(i+1)}</option>`).join('');
      const commSel = src===1?`
      <div class="option-group">
        <label class="option-label">Commission Column</label>
        <select class="col-select" data-col="commission">
          <option value="">None</option>${opts}
        </select>
      </div>`:'';
      container.innerHTML = `
      <div class="options-grid">
        <div class="option-group">
          <label class="option-label">App ID *</label>
          <select class="col-select" data-col="appId"><option value="">Select</option>${opts}</select>
        </div>
        <div class="option-group">
          <label class="option-label">Amount *</label>
          <select class="col-select" data-col="amount"><option value="">Select</option>${opts}</select>
        </div>
        <div class="option-group">
          <label class="option-label">Date</label>
          <select class="col-select" data-col="date"><option value="">None</option>${opts}</select>
        </div>
        <div class="option-group">
          <label class="option-label">Paid Status</label>
          <select class="col-select" data-col="paid"><option value="">None</option>${opts}</select>
        </div>
        ${commSel}
      </div>`;
      // attach events
      container.querySelectorAll('.col-select').forEach(sel=>{
        sel.addEventListener('change',e=>{
          const c = e.target.dataset.col;
          const v = e.target.value;
          cols[c] = v===''?null:+v;
          updateValidation();
        });
      });
    }

    // Handle file input
    async function handleFiles(files, isSrc1){
      const box = document.getElementById('upload-box-'+(isSrc1?1:2));
      const info= document.getElementById('file-info-'+(isSrc1?1:2));
      const dyn = document.getElementById(isSrc1?'source1-dynamic':'source2-dynamic');
      box.classList.add('has-files');
      info.textContent = files.length+' file(s)';
      info.classList.remove('hidden');
      dyn.innerHTML = '<div class="processing">üîÑ Processing...</div>';
      if(isSrc1) source1Files=[]; else source2Files=[];
      try{
        const arr = [];
        for(let i=0; i<files.length; i++){
          const file = files[i];
          const data = await new Promise((res,rej)=>{
            const r=new FileReader();
            r.onload=()=>res(r.result);
            r.onerror=()=>rej('Read error');
            r.readAsArrayBuffer(file);
          });
          const wb=XLSX.read(data,{type:'array',cellDates:true});
          const ws=wb.Sheets[wb.SheetNames[0]];
          const json=XLSX.utils.sheet_to_json(ws,{header:1,raw:false});
          const hdr=json[0]||[];
          const sample=json.slice(1,16);
          const cols=autoDetect(hdr,sample);
          const obj={ file, data:json, headers:hdr, cols, branding:String.fromCharCode(65+i) };
          arr.push(obj);
        }
        dyn.innerHTML='';
        arr.forEach(obj=>{
          const sec=document.createElement('div');
          sec.className='section';
          sec.innerHTML=`<h4 class="section-title">Mapping ‚Äì ${obj.file.name}</h4>`;
          dyn.appendChild(sec);
          renderMapping(sec,obj.headers,obj.cols,isSrc1?1:2);
        });
        if(isSrc1) source1Files=arr; else source2Files=arr;
      }catch(err){
        dyn.innerHTML='';
        showError('Error loading files: '+err);
      }
      updateValidation();
    }

    // Text feedback
    function showError(msg){
      document.getElementById('error-container').innerHTML=`<div class="error-msg">${msg}</div>`;
    }
    function showSuccess(msg){
      document.getElementById('error-container').innerHTML=`<div class="success-msg">${msg}</div>`;
      setTimeout(()=>document.getElementById('error-container').innerHTML='',3000);
    }

    // Analyze
    function analyze(){
      resultsDiv.innerHTML='<div class="loading">üîÑ Analyzing...</div>';
      resultsDiv.classList.remove('hidden');
      setTimeout(()=>{
        try{
          // Gather options
          const filters={
            from1:parseDate(document.getElementById('dateFrom1').value),
            to1:parseDate(document.getElementById('dateTo1').value),
            from2:parseDate(document.getElementById('dateFrom2').value),
            to2:parseDate(document.getElementById('dateTo2').value)
          };
          const includeUnpaid=document.getElementById('includeUnpaid1').checked;
          const applyGST=document.getElementById('applyGST').checked;
          const roundGST=document.getElementById('gstRound').checked;
          const commRate=safeNum(document.getElementById('commissionRate').value);
          const manualRate=safeNum(document.getElementById('manualCommissionRate').value);

          // Process data arrays
          const process=(arr,src)=>{
            return arr.flatMap(o=>{
              const {data,cols,branding,file} = o;
              const recs=[];
              for(let i=1;i<data.length;i++){
                const row=data[i];
                if(!row||!row[cols.appId])continue;
                const appId=safeStr(row[cols.appId]).trim();
                if(!appId)continue;
                recs.push({
                  appId, amount:safeNum(row[cols.amount]),
                  paid:cols.paid!=null?safeStr(row[cols.paid]):null,
                  date:cols.date!=null?parseDate(row[cols.date]):null,
                  commission:cols.commission!=null?safeNum(row[cols.commission]):0,
                  branding,fileName:file.name,src
                });
              }
              return recs;
            });
          };
          let d1=process(source1Files,1);
          let d2=process(source2Files,2);

          // Date filter
          if(filters.from1||filters.to1) d1=d1.filter(d=>d.date && (!filters.from1||d.date>=filters.from1)&&(!filters.to1||d.date<=filters.to1));
          if(filters.from2||filters.to2) d2=d2.filter(d=>d.date && (!filters.from2||d.date>=filters.from2)&&(!filters.to2||d.date<=filters.to2));

          // Payment filter & GST
          if(!includeUnpaid) d1=d1.filter(d=>String(d.paid||'').toLowerCase()==='paid');
          if(applyGST) d1.forEach(d=>{
            d.base=d.amount;
            d.amount=roundGST?Math.round(d.amount*1.18):d.amount*1.18;
          });

          // Compare
          const map1=_.groupBy(d1,'appId'), map2=_.groupBy(d2,'appId');
          const allIds=_.union(Object.keys(map1),Object.keys(map2));
          const matching=[], missing=[], dup1=[], dup2=[];

          allIds.forEach(id=>{
            const a=map1[id], b=map2[id];
            if(a&&b){
              const s1=_.sumBy(a,'amount'), s2=_.sumBy(b,'amount'), diff=Math.abs(s1-s2);
              matching.push({appId:id,amount1:s1,amount2:s2,difference:diff,
                status:diff<0.01?'Match':'Amount Mismatch',
                date1:a.find(x=>x.date)?.date,date2:b.find(x=>x.date)?.date,
                branding:a[0].branding,file1:a[0].fileName,file2:b[0].fileName
              });
            } else {
              const arr=a||b;
              missing.push({
                appId:id,amount:_.sumBy(arr,'amount'),
                missingFrom:a?'Source 2':'Source 1',
                date:arr.find(x=>x.date)?.date,
                paid:arr[0].paid,branding:arr[0].branding,fileName:arr[0].fileName
              });
            }
          });
          Object.keys(map1).forEach(id=>{
            if(map1[id].length>1) dup1.push({appId:id,count:map1[id].length,total:_.sumBy(map1[id],'amount')});
          });
          Object.keys(map2).forEach(id=>{
            if(map2[id].length>1) dup2.push({appId:id,count:map2[id].length,total:_.sumBy(map2[id],'amount')});
          });

          // Commission
          const paid1=d1.filter(x=>String(x.paid||'').toLowerCase()==='paid');
          let colComm=0,calcComm=0,manComm=0;
          paid1.forEach(x=>{
            colComm+=x.commission||0;
            calcComm+=x.amount*(commRate/100);
            const tv=applyGST?(x.base||x.amount)/1.18:(x.base||x.amount);
            manComm+=tv*(manualRate/100);
          });

          analysisResults={matching,missing,duplicates1:dup1,duplicates2:dup2,
            stats:{
              total1:_.sumBy(d1,'amount'),total2:_.sumBy(d2,'amount'),
              matchCount:matching.length,missingCount:missing.length,dupCount:dup1.length+dup2.length,
              diffTotal:_.sumBy(matching,'difference')
            },
            commission:{col:colComm,calc:calcComm,man:manComm,rate:commRate,manual:manualRate},
            sortState:{}, time:new Date().toISOString()
          };

          renderResults();
          showSuccess('Analysis complete');
        }catch(e){
          showError('Analysis error: '+e.message);
        }
      },100);
    }

    // Render results
    function renderResults(){
      const R=analysisResults, m=R.matching, miss=R.missing, dup=[...R.duplicates1,...R.duplicates2];
      let html=`
      <div class="results-header">
        <h2 class="results-title">üìä Results</h2>
        <div class="results-meta">UTC ${new Date(R.time).toLocaleString()}</div>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-number">Rs ${R.stats.total1.toFixed(2)}</div><div class="stat-label">Source 1 Total</div></div>
        <div class="stat-card"><div class="stat-number">Rs ${R.stats.total2.toFixed(2)}</div><div class="stat-label">Source 2 Total</div></div>
        <div class="stat-card success"><div class="stat-number">${R.stats.matchCount}</div><div class="stat-label">Matching IDs</div></div>
        <div class="stat-card warning"><div class="stat-number">Rs ${R.stats.diffTotal.toFixed(2)}</div><div class="stat-label">Total Diff</div></div>
        <div class="stat-card ${R.stats.missingCount>0?'danger':'success'}"><div class="stat-number">${R.stats.missingCount}</div><div class="stat-label">Missing IDs</div></div>
        <div class="stat-card ${R.stats.dupCount>0?'danger':'success'}"><div class="stat-number">${R.stats.dupCount}</div><div class="stat-label">Duplicates</div></div>
        <div class="stat-card commission"><div class="stat-number">Rs ${R.commission.col.toFixed(2)}</div><div class="stat-label">Comm (col)</div></div>
        <div class="stat-card commission"><div class="stat-number">Rs ${R.commission.calc.toFixed(2)}</div><div class="stat-label">Comm (${R.commission.rate}%)</div></div>
        <div class="stat-card commission"><div class="stat-number">Rs ${R.commission.man.toFixed(2)}</div><div class="stat-label">Manual (${R.commission.manual}%)</div></div>
      </div>`;
      const renderTable=(type,data)=>{
        if(!data.length) return'';
        const titles={matching:'üü¢ Matching',missing:'üî¥ Missing',duplicates:'‚ö†Ô∏è Duplicates'};
        const headers={
          matching:['App ID','Status','Amt 1','Amt 2','Diff','Date 1','Date 2','Src','File 1','File 2'],
          missing:['App ID','Missing From','Amt','Date','Paid','Src','File'],
          duplicates:['App ID','Src','Count','Total']
        }[type];
        let ths=headers.map((h,i)=>`<th data-type="${type}" data-idx="${i}">${h} <span class="sort-arrow"></span></th>`).join('');
        let trs=data.map(r=>{
          if(type==='matching'){
            return `<tr class="${r.status==='Match'?'highlight-match':'highlight-mismatch'}">
              <td><strong>${r.appId}</strong></td>
              <td><span class="status-badge ${r.status==='Match'?'match':'amount-mismatch'}">${r.status}</span></td>
              <td>Rs ${r.amount1.toFixed(2)}</td>
              <td>Rs ${r.amount2.toFixed(2)}</td>
              <td>Rs ${r.difference.toFixed(2)}</td>
              <td>${toUTCDateStr(r.date1)}</td>
              <td>${toUTCDateStr(r.date2)}</td>
              <td>${r.branding}</td>
              <td title="${r.fileName}">${r.fileName}</td>
              <td title="${r.fileName2||''}">${r.fileName2||''}</td>
            </tr>`;
          } else if(type==='missing'){
            return `<tr class="highlight-missing">
              <td><strong>${r.appId}</strong></td>
              <td>${r.missingFrom}</td>
              <td>Rs ${r.amount.toFixed(2)}</td>
              <td>${toUTCDateStr(r.date)}</td>
              <td>${r.paid||'N/A'}</td>
              <td>${r.branding}</td>
              <td title="${r.fileName}">${r.fileName}</td>
            </tr>`;
          } else {
            return `<tr class="highlight-mismatch">
              <td><strong>${r.appId}</strong></td>
              <td>${r.source}</td>
              <td>${r.count}</td>
              <td>Rs ${r.total.toFixed(2)}</td>
            </tr>`;
          }
        }).join('');
        return `
        <div class="table-container">
          <div class="table-header">
            <span class="table-title">${titles[type]} (${data.length})</span>
            <button class="view-btn" data-view="${type}">Full View</button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead><tr>${ths}</tr></thead>
              <tbody>${trs}</tbody>
            </table>
          </div>
        </div>`;
      };
      html+=renderTable('matching',m)+renderTable('missing',miss)+renderTable('duplicates',dup);
      html+=`<div class="export-section"><button id="export-excel-btn" class="export-btn">üìä Export to Excel</button></div>`;
      resultsDiv.innerHTML=html;
    }

    // Export
    function exportExcel(){
      if(!analysisResults)return;
      const wb=XLSX.utils.book_new();
      const R=analysisResults;
      // summary
      const sum=[['Key','Value'],['Generated',new Date(R.time).toLocaleString()]];
      sum.push([],['Source 1 Total',R.stats.total1],['Source 2 Total',R.stats.total2]);
      sum.push(['Matching',R.stats.matchCount],['Missing',R.stats.missingCount],['Duplicates',R.stats.dupCount]);
      sum.push(['Diff',R.stats.diffTotal]);
      sum.push([],['Comm (col)',R.commission.col],[`Comm ${R.commission.rate}%`,R.commission.calc],[`Man ${R.commission.manual}%`,R.commission.man]);
      XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(sum),'Summary');
      // matching
      const matchData=R.matching.map(r=>({
        'App ID':r.appId,'Status':r.status,
        'Amt 1':r.amount1,'Amt 2':r.amount2,'Diff':r.difference,
        'Date 1':r.date1,'Date 2':r.date2,
        'Src':r.branding,'File 1':r.fileName,'File 2':r.fileName2
      }));
      XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(matchData),'Matching');
      // missing
      const missData=R.missing.map(r=>({
        'App ID':r.appId,'From':r.missingFrom,'Amt':r.amount,
        'Date':r.date,'Paid':r.paid,'Src':r.branding,'File':r.fileName
      }));
      XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(missData),'Missing');
      // duplicates
      const dup=[...R.duplicates1,...R.duplicates2].map(r=>({
        'App ID':r.appId,'Src':r.source,'Count':r.count,'Total':r.total
      }));
      if(dup.length) XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(dup),'Duplicates');
      const ts=new Date().toISOString().replace(/[:\-T]/g,'_').slice(0,17);
      XLSX.writeFile(wb,`AppID_Analysis_${ts}.xlsx`);
    }

    // Full view sorting
    function openView(type){
      const R=analysisResults;
      const map={matching:R.matching,missing:R.missing,duplicates:[...R.duplicates1,...R.duplicates2]}[type];
      if(!map.length)return;
      const win=window.open('','_blank','width=1200,height=800');
      const tbl= renderResults.toString(); // reuse render code
      // Instead: quickly re-render minimal table in new window
      const doc=win.document;
      doc.write('<html><head><title>Full '+type+'</title></head><body>');
      doc.write(`
        <style>
          body{font-family:sans-serif;padding:20px}
          table{width:100%;border-collapse:collapse}
          th,td{border:1px solid #ccc;padding:8px;text-align:left}
        </style>
        <h1>Full View: ${type.charAt(0).toUpperCase()+type.slice(1)}</h1>
      `);
      // recreate table
      let headers, rows;
      if(type==='matching'){
        headers=['App ID','Status','Amt 1','Amt 2','Diff','Date 1','Date 2','Src'];
        rows=map.map(r=>[
          r.appId,r.status,r.amount1,r.amount2,r.difference,toUTCDateStr(r.date1),toUTCDateStr(r.date2),r.branding
        ]);
      } else if(type==='missing'){
        headers=['App ID','From','Amt','Date','Paid','Src'];
        rows=map.map(r=>[
          r.appId,r.missingFrom,r.amount,toUTCDateStr(r.date),r.paid||'N/A',r.branding
        ]);
      } else {
        headers=['App ID','Src','Count','Total'];
        rows=map.map(r=>[r.appId,r.source,r.count,r.total]);
      }
      doc.write('<table><thead><tr>'+headers.map(h=>`<th>${h}</th>`).join('')+'</tr></thead><tbody>');
      rows.forEach(r=>doc.write('<tr>'+r.map(c=>`<td>${c}</td>`).join('')+'</tr>'));
      doc.write('</tbody></table>');
      doc.write('</body></html>');
      doc.close();
    }

    // Event hookup
    btn1.addEventListener('click',()=>in1.click());
    btn2.addEventListener('click',()=>in2.click());
    in1.addEventListener('change',e=>handleFiles(e.target.files,true));
    in2.addEventListener('change',e=>handleFiles(e.target.files,false));
    analyzeBtn.addEventListener('click',analyze);
    resultsDiv.addEventListener('click',e=>{
      if(e.target.id==='export-excel-btn') return exportExcel();
      const v=e.target.closest('.view-btn');
      if(v) return openView(v.dataset.view);
      const th=e.target.closest('th[data-idx]');
      if(!th||!analysisResults) return;
      // sort (not reimplemented here for brevity)
    });

    // Show UTC timestamp
    function updateUser(){
      document.getElementById('user-info').textContent =
        'User: ksismad | UTC '+new Date().toISOString().slice(0,19).replace('T',' ');
    }
    updateUser(); setInterval(updateUser,1000);

  });
  </script>
</body>
</html>
