<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Reconciliation & Analysis Suite (ksismad)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #4C51BF; --primary-dark: #434190;
            --secondary-color: #38A169; --secondary-dark: #2F855A;
            --light-gray: #f7fafc; --medium-gray: #e2e8f0;
            --dark-gray: #2d3748; --text-color: #4a5568;
            --white: #fff; --danger-color: #c53030; --warning-color: #dd6b20;
        }
        html, body { 
            background: #f3f4f6; color: var(--text-color); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0; padding: 0; line-height: 1.6;
        }
        .container { 
            max-width: 1400px; margin: 30px auto; background: var(--white); 
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #5A67D8 0%, #7F5AD5 100%); 
            color: var(--white); padding: 30px 40px; position: relative;
        }
        .header h1 { margin: 0; font-size: 2.5rem; font-weight: 700; }
        .user-info {
            position: absolute; top: 20px; right: 30px; background: rgba(255,255,255,0.2);
            padding: 8px 16px; border-radius: 99px; font-size: 0.9rem; font-weight: 500;
        }
        .main-content { padding: 30px 40px; }
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .upload-box {
            background: var(--light-gray); border: 2px dashed var(--medium-gray);
            border-radius: 12px; padding: 25px; transition: all 0.2s ease;
        }
        .upload-box:hover { border-color: #c3dafe; background: #f1f5f9; }
        .upload-box h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.25rem; color: var(--dark-gray); }
        .file-input { display: none; }
        .upload-btn {
            background: var(--primary-color); color: var(--white); border: none; 
            padding: 10px 20px; border-radius: 8px; cursor: pointer; 
            font-weight: 600; transition: background 0.2s ease;
        }
        .upload-btn:hover { background: var(--primary-dark); }
        .file-info {
            margin-top: 15px; padding: 10px; background: #e6fffa; color: #2c7a7b; 
            border-radius: 6px; font-weight: 500; display: none; word-break: break-all;
        }
        .file-info.show { display: block; }
        .options-section, .column-mapping, .commission-section {
            background: var(--light-gray); border-radius: 12px;
            padding: 25px; margin-bottom: 30px;
        }
        .options-section h3, .column-mapping h3, .commission-section h3 { margin-top: 0; margin-bottom: 20px; color: var(--dark-gray); }
        .options-grid, .mapping-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        .mapping-box h4 { margin: 0 0 10px 0; font-size: 1.1rem; color: var(--dark-gray); }
        .mapping-row { display: flex; align-items: center; margin-bottom: 12px; }
        .mapping-label { flex: 1; font-weight: 600; padding-right: 10px;}
        .mapping-select, .commission-input {
            flex: 2; padding: 8px; border: 1px solid #cbd5e1;
            border-radius: 6px; background: var(--white);
        }
        .analyze-btn {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%);
            color: var(--white); border: none; border-radius: 12px; font-size: 1.25rem; 
            font-weight: 700; cursor: pointer; transition: all 0.2s ease;
        }
        .analyze-btn:hover { box-shadow: 0 4px 15px rgba(47, 133, 90, 0.4); }
        .analyze-btn:disabled { background: #a0aec0; cursor: not-allowed; box-shadow: none; }
        .results { margin-top: 30px; display: none; }
        .results.show { display: block; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .result-box {
            background: var(--white); border: 1px solid var(--medium-gray);
            border-radius: 12px; display: flex; flex-direction: column;
        }
        .result-header {
            padding: 15px 20px; background: var(--light-gray);
            border-bottom: 1px solid var(--medium-gray); display: flex;
            justify-content: space-between; align-items: center;
        }
        .result-header h3 { margin: 0; color: var(--dark-gray); }
        .view-full-btn {
            background: none; border: 1px solid #cbd5e1; color: var(--text-color);
            padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
        }
        .view-full-btn:hover { background: #edf2f7; }
        .table-container { overflow: auto; height: 400px; flex-grow: 1; }
        .results-table { width: 100%; border-collapse: collapse; }
        .results-table th, .results-table td {
            padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--medium-gray);
            white-space: nowrap;
        }
        .results-table th { background: var(--light-gray); font-weight: 600; position: sticky; top: 0; z-index: 1;}
        .results-table th.sortable { cursor: pointer; }
        .results-table th.sortable:hover { background: #edf2f7; }
        .result-footer {
            padding: 10px 20px; background: var(--light-gray); font-weight: 600;
            border-top: 1px solid var(--medium-gray); text-align: right;
        }
        .status-match { color: var(--secondary-dark); font-weight: 600; }
        .status-mismatch { color: var(--danger-color); font-weight: 600; }
        .status-missing-in-source-2, .status-missing-in-source-1 { color: var(--warning-color); font-weight: 600; }
        .commission-table { width: 100%; border-collapse: collapse; }
        .commission-table td { padding: 8px; border-bottom: 1px solid var(--medium-gray); vertical-align: middle; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.85); display: flex; align-items: center;
            justify-content: center; z-index: 9999; display: none;
        }
        .loading-overlay.show { display: flex; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info" id="user-info"></div>
            <h1>Professional Reconciliation & Analysis Suite</h1>
            <p>Intelligently compare, analyze, and export financial data with ease.</p>
        </div>
        
        <div class="main-content">
            <div class="upload-section">
                <div class="upload-box">
                    <h3>Source 1 (Master Data)</h3>
                    <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls,.csv">
                    <button class="upload-btn" onclick="document.getElementById('file-input-1').click()">Choose Master File(s)</button>
                    <div id="file-info-1" class="file-info"></div>
                </div>
                <div class="upload-box">
                    <h3>Source 2 (Comparison Data)</h3>
                    <input type="file" id="file-input-2" class="file-input" accept=".xlsx,.xls,.csv">
                    <button class="upload-btn" onclick="document.getElementById('file-input-2').click()">Choose Comparison File</button>
                    <div id="file-info-2" class="file-info"></div>
                </div>
            </div>

            <div id="column-mapping-section" class="column-mapping" style="display: none;">
                <h3>Column Mapping</h3>
                <p>Please verify the automatically detected columns. Fields marked with * are required for analysis.</p>
                <div class="mapping-grid">
                    <div id="source1-mappings"></div>
                    <div id="source2-mappings"></div>
                </div>
            </div>
            
            <div id="commission-control-section" class="commission-section" style="display: none;">
                <h3>Commission & Financial Control Center</h3>
                <p>Manage file-specific commission, TDS, and additional amounts before analysis.</p>
                <div id="commission-controls"></div>
            </div>

            <div class="options-section">
                <h3>Global Filters & Options</h3>
                <div class="options-grid">
                    <div>
                        <label for="date1-from" class="mapping-label">Source 1 Date Range</label>
                        <input type="date" id="date1-from"> to <input type="date" id="date1-to">
                    </div>
                    <div>
                        <label for="date2-from" class="mapping-label">Source 2 Date Range</label>
                        <input type="date" id="date2-from"> to <input type="date" id="date2-to">
                    </div>
                    <div>
                        <label for="status-filter" class="mapping-label">Filter Source 1 by Status</label>
                        <select id="status-filter" class="mapping-select">
                            <option value="all">All Records</option>
                            <option value="paid">Paid</option>
                            <option value="unpaid">Unpaid</option>
                        </select>
                    </div>
                     <div>
                        <label for="apply-gst" class="mapping-label">Apply 18% GST to Source 1</label>
                        <input type="checkbox" id="apply-gst">
                    </div>
                    <div>
                        <label for="round-off" class="mapping-label">Round Off Source 1 Amount</label>
                        <input type="checkbox" id="round-off">
                    </div>
                </div>
            </div>
            
            <button id="analyze-btn" class="analyze-btn" disabled>Upload & Map Files to Begin</button>
            
            <div id="results" class="results">
                <h2>Analysis Results</h2>
                <div class="results-grid">
                    <div id="matches-box" class="result-box"></div>
                    <div id="mismatches-box" class="result-box"></div>
                    <div id="missing1-box" class="result-box"></div>
                    <div id="missing2-box" class="result-box"></div>
                </div>
                 <button id="export-btn" class="upload-btn" style="margin-top: 20px; display: none;">Export Spectacular Report</button>
            </div>
        </div>
    </div>
    
    <div id="loading-overlay" class="loading-overlay"><div class="spinner"></div></div>
    
    <script>
        const STATE = {
            source1: { files: new Map(), data: [], headers: [], mappings: {}, financialControls: {} },
            source2: { files: new Map(), data: [], headers: [], mappings: {} },
            analysisResults: null
        };

        const COLUMN_CONFIG = {
            appId: { label: 'Application ID', patterns: [/app.*id/i, /application.*id/i, /id/i], required: true },
            amount: { label: 'Amount', patterns: [/amount/i, /total/i, /value/i, /fee/i], required: true },
            date: { label: 'Date', patterns: [/date/i, /timestamp/i, /created/i], required: false },
            status: { label: 'Status', patterns: [/status/i, /state/i], required: false },
            commission: { label: 'Commission', patterns: [/commission/i, /comm/i], required: false }
        };
        const DOM = {
            analyzeBtn: document.getElementById('analyze-btn'),
            userInfo: document.getElementById('user-info'),
            columnMappingSection: document.getElementById('column-mapping-section'),
            commissionControlSection: document.getElementById('commission-control-section'),
            resultsSection: document.getElementById('results'),
            exportBtn: document.getElementById('export-btn'),
            loadingOverlay: document.getElementById('loading-overlay')
        };
        
        async function processFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: "" });
                        resolve(jsonData);
                    } catch (err) { reject(new Error(`Could not process file ${file.name}: ${err.message}`)); }
                };
                reader.onerror = () => reject(new Error(`Could not read file ${file.name}`));
                reader.readAsArrayBuffer(file);
            });
        }

        function generateFileSignature(data) {
            const headers = data[0] || [];
            const appIdIndex = headers.findIndex(h => COLUMN_CONFIG.appId.patterns.some(p => p.test(h)));
            if (appIdIndex === -1) return headers.join(',');
            return data.slice(1, 6).map(row => row[appIdIndex]).join(',');
        }

        async function handleFileSelection(files, sourceNum) {
            if (!files.length) return;
            showLoading();
            
            const sourceKey = `source${sourceNum}`;
            const stateObj = STATE[sourceKey];

            try {
                let headers = stateObj.headers.length ? stateObj.headers : (await processFile(files[0]))[0];
                stateObj.headers = headers;

                if (sourceNum === 2) { 
                    stateObj.files.clear();
                    stateObj.data = [];
                }

                for (const file of files) {
                    const fileData = await processFile(file);
                    if (fileData.length < 2) continue;
                    const signature = generateFileSignature(fileData);
                    if (stateObj.files.has(signature)) {
                        alert(`Skipping duplicate file: ${file.name}`);
                        continue;
                    }
                    stateObj.files.set(signature, file.name);
                    const records = fileData.slice(1).map(row => ({ __filename: file.name, data: row }));
                    stateObj.data.push(...records);
                }
                
                stateObj.mappings = detectColumnMappings(stateObj.headers);
                updateFileInfo(sourceNum);
                createColumnMappingUI(sourceNum);

                if (sourceNum === 1 && stateObj.files.size > 0) {
                    initializeFinancialControls();
                    renderFinancialControls();
                    DOM.commissionControlSection.style.display = 'block';
                }

            } catch (err) {
                alert(`Error: ${err.message}`);
            } finally {
                if (STATE.source1.files.size > 0 && STATE.source2.files.size > 0) {
                    DOM.columnMappingSection.style.display = 'block';
                }
                hideLoading();
                updateAnalyzeButton();
            }
        }
        
        function runAnalysis() {
            showLoading();
            setTimeout(() => {
                try {
                    if (checkForDuplicates()) return;

                    const { appId: s1AppIdCol, amount: s1AmountCol } = STATE.source1.mappings;
                    const { appId: s2AppIdCol, amount: s2AmountCol } = STATE.source2.mappings;
                    const applyGst = document.getElementById('apply-gst').checked;
                    const roundOff = document.getElementById('round-off').checked;

                    const s1Filtered = getFilteredData(1);
                    const s2Filtered = getFilteredData(2);
                    
                    const s1Map = new Map();
                    s1Filtered.forEach(item => {
                        const appId = item.data[s1AppIdCol];
                        if (appId) s1Map.set(appId.toString(), item);
                    });

                    const results = { matches: [], mismatches: [], missingInSource2: [], missingInSource1: [] };

                    s2Filtered.forEach(s2item => {
                        const s2row = s2item.data;
                        const s2AppId = s2row[s2AppIdCol]?.toString();
                        const s1item = s1Map.get(s2AppId);
                        
                        let s1Amount = 0, commission = 0, tds = 0;
                        let s2Amount = parseFloat(s2row[s2AmountCol]) || 0;
                        let status = '', filename1 = 'N/A', date1 = null, date2 = null;

                        if (s1item) {
                            const s1row = s1item.data;
                            filename1 = s1item.__filename;
                            const controls = STATE.source1.financialControls[filename1];
                            
                            date1 = parseDate(s1row[STATE.source1.mappings.date]);
                            date2 = parseDate(s2row[STATE.source2.mappings.date]);
                            s1Amount = parseFloat(s1row[s1AmountCol]) || 0;
                            if (applyGst) s1Amount *= 1.18;
                            if (roundOff) s1Amount = Math.round(s1Amount);
                            
                            commission = parseFloat(s1row[STATE.source1.mappings.commission]) || 0;
                            commission += controls.mergedCommission;
                            tds = commission * (controls.tdsPercent / 100);
                            
                            status = Math.abs(s1Amount - s2Amount) < 0.01 ? 'Match' : 'Mismatch';
                            results[status.toLowerCase() + 'es'].push({ appId: s2AppId, amount1: s1Amount, amount2: s2Amount, commission, tds, status, filename1, date1, date2 });
                            s1Map.delete(s2AppId);
                        } else {
                            status = 'Missing in Source 1';
                            date2 = parseDate(s2row[STATE.source2.mappings.date]);
                            results.missingInSource1.push({ appId: s2AppId, amount1: 0, amount2: s2Amount, commission: 0, tds: 0, status, filename1: 'N/A', date1: null, date2 });
                        }
                    });

                    s1Map.forEach(s1item => {
                        const s1row = s1item.data;
                        const controls = STATE.source1.financialControls[s1item.__filename];
                        let amount1 = parseFloat(s1row[s1AmountCol]) || 0;
                        if (applyGst) amount1 *= 1.18;
                        if (roundOff) amount1 = Math.round(amount1);
                        let commission = parseFloat(s1row[STATE.source1.mappings.commission]) || 0;
                        commission += controls.mergedCommission;
                        const tds = commission * (controls.tdsPercent / 100);
                        results.missingInSource2.push({ appId: s1row[s1AppIdCol], amount1, amount2: 0, commission, tds, status: 'Missing in Source 2', filename1: s1item.__filename, date1: parseDate(s1row[STATE.source1.mappings.date]), date2: null });
                    });
                    
                    STATE.analysisResults = results;
                    displayResults(STATE.analysisResults);
                } catch (error) {
                    alert('An error occurred during analysis: ' + error.message);
                } finally {
                    hideLoading();
                }
            }, 50);
        }
        
        function displayResults(results) {
            buildResultTable('matches', 'Matches', ['App ID', 'Amount', 'Date', 'Filename'], results.matches);
            buildResultTable('mismatches', 'Mismatches', ['App ID', 'S1 Amount', 'S2 Amount', 'Diff', 'Commission', 'TDS', 'S1 Date', 'S2 Date', 'Filename'], results.mismatches);
            buildResultTable('missing2', 'Missing in Source 2', ['App ID', 'Amount', 'Commission', 'TDS', 'Date', 'Filename'], results.missingInSource2);
            buildResultTable('missing1', 'Missing in Source 1', ['App ID', 'Amount', 'Date'], results.missingInSource1);
            
            DOM.resultsSection.classList.add('show');
            DOM.exportBtn.style.display = 'inline-block';
        }

        function buildResultTable(id, title, headers, data) {
            const container = document.getElementById(`${id}-box`);
            let totalAmount1 = 0, totalAmount2 = 0;
            
            let tableHTML = `<div class="result-header"><h3>${title}</h3><button class="view-full-btn">View Full</button></div>
                             <div class="table-container"><table class="results-table"><thead><tr>`;
            headers.forEach(h => tableHTML += `<th class="sortable" data-sort-key="${h.toLowerCase().replace(/ /g, '')}">${h}</th>`);
            tableHTML += `</tr></thead><tbody>`;

            data.forEach(item => {
                totalAmount1 += item.amount1 || 0;
                totalAmount2 += item.amount2 || 0;
                tableHTML += '<tr>';
                if (id === 'matches') tableHTML += `<td>${item.appId}</td><td>${item.amount1.toFixed(2)}</td><td>${formatDate(item.date1)}</td><td>${item.filename1}</td>`;
                else if (id === 'mismatches') tableHTML += `<td>${item.appId}</td><td>${item.amount1.toFixed(2)}</td><td>${item.amount2.toFixed(2)}</td><td>${(item.amount1 - item.amount2).toFixed(2)}</td><td>${item.commission.toFixed(2)}</td><td>${item.tds.toFixed(2)}</td><td>${formatDate(item.date1)}</td><td>${formatDate(item.date2)}</td><td>${item.filename1}</td>`;
                else if (id === 'missing2') tableHTML += `<td>${item.appId}</td><td>${item.amount1.toFixed(2)}</td><td>${item.commission.toFixed(2)}</td><td>${item.tds.toFixed(2)}</td><td>${formatDate(item.date1)}</td><td>${item.filename1}</td>`;
                else if (id === 'missing1') tableHTML += `<td>${item.appId}</td><td>${item.amount2.toFixed(2)}</td><td>${formatDate(item.date2)}</td>`;
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table></div>';
            
            const total = id.includes('1') ? totalAmount2 : totalAmount1;
            tableHTML += `<div class="result-footer"><span>Records: ${data.length}</span> | <span>Total Amount: ${total.toFixed(2)}</span></div>`;
            
            container.innerHTML = tableHTML;
            makeTableSortable(container.querySelector('table'), data, headers, id, title);
            container.querySelector('.view-full-btn').addEventListener('click', () => openFullView(title, container.querySelector('table').outerHTML));
        }
        
        function makeTableSortable(table, data, headers, id, title) {
            const headerCells = Array.from(table.querySelectorAll('th'));
            headerCells.forEach((header) => {
                header.addEventListener('click', () => {
                    const isAsc = !header.classList.contains('asc');
                    headerCells.forEach(h => h.classList.remove('asc', 'desc'));
                    header.classList.toggle(isAsc ? 'asc' : 'desc');
                    
                    const keyMap = {
                        'appid': 'appId', 'amount': 'amount1', 's1amount': 'amount1', 's2amount': 'amount2',
                        'diff': item => item.amount1 - item.amount2, 'commission': 'commission', 'tds': 'tds',
                        'date': 'date1', 's1date': 'date1', 's2date': 'date2', 'filename': 'filename1'
                    };
                    const key = keyMap[header.dataset.sortKey];

                    data.sort((a, b) => {
                        const valA = typeof key === 'function' ? key(a) : a[key];
                        const valB = typeof key === 'function' ? key(b) : b[key];
                        if (valA === null || valA === undefined) return 1;
                        if (valB === null || valB === undefined) return -1;
                        if (typeof valA === 'string') return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                        if (valA instanceof Date) return isAsc ? valA - valB : valB - valA;
                        return isAsc ? valA - valB : valB - valA;
                    });
                    
                    buildResultTable(id, title, headers.map(h => h.innerText), data);
                });
            });
        }
        
        function openFullView(title, tableHTML) {
            const newWindow = window.open("");
            newWindow.document.write(`<html><head><title>${title}</title><style>body{font-family:sans-serif;padding:20px} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ccc;padding:8px} th{background:#f0f0f0;text-align:left}</style></head><body><h1>${title}</h1>${tableHTML}</body></html>`);
            newWindow.document.close();
        }
        
        function renderFinancialControls() {
            const container = document.getElementById('commission-controls');
            const fileNames = Array.from(STATE.source1.files.values());
            let html = '<table class="commission-table"><thead><tr><th>Filename</th><th>Original Commission</th><th>TDS %</th><th>Additional Received</th><th>Merge To</th></tr></thead><tbody>';
            
            for (const fileName of fileNames) {
                const controls = STATE.source1.financialControls[fileName];
                let options = fileNames.filter(f => f !== fileName).map(f => `<option value="${f}" ${controls.mergedInto === f ? 'selected' : ''}>${f}</option>`).join('');
                
                html += `<tr>
                    <td>${fileName}</td>
                    <td>${controls.originalCommission.toFixed(2)}</td>
                    <td><input type="number" class="commission-input" data-file="${fileName}" data-field="tdsPercent" value="${controls.tdsPercent}"></td>
                    <td><input type="number" class="commission-input" data-file="${fileName}" data-field="additionalAmount" value="${controls.additionalAmount}"></td>
                    <td><select class="mapping-select merge-target" data-from-file="${fileName}" ${fileNames.length < 2 ? 'disabled' : ''}><option value="">-- No Merge --</option>${options}</select></td>
                </tr>`;
            }
            html += '</tbody></table>';
            container.innerHTML = html;

            container.querySelectorAll('.commission-input, .merge-target').forEach(el => {
                el.addEventListener('change', e => {
                    const fileName = e.target.dataset.file || e.target.dataset.fromFile;
                    if (e.target.classList.contains('merge-target')) {
                        updateCommissionMerge(fileName, e.target.value);
                    } else {
                        STATE.source1.financialControls[fileName][e.target.dataset.field] = parseFloat(e.target.value) || 0;
                    }
                });
            });
        }
        
        function initializeFinancialControls() {
            const { data, mappings, financialControls } = STATE.source1;
            if (mappings.commission === undefined) return;

            for (const item of data) {
                const fileName = item.__filename;
                if (!financialControls[fileName]) {
                    financialControls[fileName] = { originalCommission: 0, mergedCommission: 0, tdsPercent: 2, additionalAmount: 0, mergedInto: null };
                }
                financialControls[fileName].originalCommission += parseFloat(item.data[mappings.commission]) || 0;
            }
        }
        
        function updateCommissionMerge(fromFile, toFile) {
            const { financialControls } = STATE.source1;
            // Reset previous merge if exists
            const oldTarget = financialControls[fromFile].mergedInto;
            if(oldTarget) {
                financialControls[oldTarget].mergedCommission -= financialControls[fromFile].originalCommission;
            }
            // Apply new merge
            financialControls[fromFile].mergedInto = toFile;
            if(toFile) {
                financialControls[toFile].mergedCommission += financialControls[fromFile].originalCommission;
            }
        }
        
        function getFilteredData(sourceNum) {
            const { data, mappings } = STATE[`source${sourceNum}`];
            const dateFrom = document.getElementById(`date${sourceNum}-from`).valueAsDate;
            const dateTo = document.getElementById(`date${sourceNum}-to`).valueAsDate;
            const dateCol = mappings.date;

            let filteredData = data;
            if ((dateFrom || dateTo) && dateCol !== undefined) {
                filteredData = filteredData.filter(item => {
                    const dateVal = parseDate(item.data[dateCol]);
                    if (!dateVal) return false;
                    const fromOK = !dateFrom || dateVal >= dateFrom;
                    const toOK = !dateTo || dateVal <= new Date(dateTo.getTime() + 86400000);
                    return fromOK && toOK;
                });
            }
            if (sourceNum === 1) {
                const statusFilter = document.getElementById('status-filter').value;
                const statusCol = mappings.status;
                if (statusFilter !== 'all' && statusCol !== undefined) {
                    filteredData = filteredData.filter(item => (item.data[statusCol]?.toString().toLowerCase() || '') === statusFilter);
                }
            }
            return filteredData;
        }
        
        function checkForDuplicates() {
            const checkSource = (sourceNum) => {
                const { data, mappings } = STATE[`source${sourceNum}`];
                const appIdCol = mappings.appId;
                if (appIdCol === undefined) return [];
                
                const appIds = new Set();
                const duplicates = new Set();
                data.forEach(item => {
                    const appId = item.data[appIdCol];
                    if(appId) {
                        if(appIds.has(appId)) duplicates.add(appId);
                        else appIds.add(appId);
                    }
                });
                return Array.from(duplicates);
            };

            const s1Dups = checkSource(1);
            const s2Dups = checkSource(2);

            if(s1Dups.length > 0 || s2Dups.length > 0) {
                let message = "Duplicate App IDs found! Analysis may be incorrect.\n";
                if(s1Dups.length > 0) message += `\nSource 1 Duplicates: ${s1Dups.join(', ')}`;
                if(s2Dups.length > 0) message += `\nSource 2 Duplicates: ${s2Dups.join(', ')}`;
                alert(message);
                return true;
            }
            return false;
        }

        function updateFileInfo(sourceNum) {
            const filesMap = STATE[`source${sourceNum}`].files;
            document.getElementById(`file-info-${sourceNum}`).innerHTML = `<b>${filesMap.size} file(s)</b> selected, <b>${STATE[`source${sourceNum}`].data.length} records</b> found.`;
            document.getElementById(`file-info-${sourceNum}`).classList.add('show');
        }

        function createColumnMappingUI(sourceNum) {
            const sourceKey = `source${sourceNum}`;
            const { headers, mappings } = STATE[sourceKey];
            const container = document.getElementById(`${sourceKey}-mappings`);
            let html = `<h4>Source ${sourceNum}</h4>`;
            for (const [key, config] of Object.entries(COLUMN_CONFIG)) {
                const options = headers.map((h, i) => `<option value="${i}" ${mappings[key] === i ? 'selected' : ''}>${h || `Column ${i+1}`}</option>`).join('');
                html += `<div class="mapping-row"><label class="mapping-label">${config.label}${config.required ? ' *' : ''}</label><select class="mapping-select" data-source="${sourceNum}" data-key="${key}"><option value="">-- Select --</option>${options}</select></div>`;
            }
            container.innerHTML = html;
            container.querySelectorAll('select').forEach(sel => sel.addEventListener('change', e => {
                const val = e.target.value;
                STATE[`source${e.target.dataset.source}`].mappings[e.target.dataset.key] = val ? parseInt(val, 10) : undefined;
                updateAnalyzeButton();
            }));
        }
        
        function updateAnalyzeButton() {
            const s1Ready = STATE.source1.files.size > 0;
            const s2Ready = STATE.source2.files.size > 0;
            let mappingsReady = false;
            if (s1Ready && s2Ready) {
                const s1Mappings = STATE.source1.mappings;
                const s2Mappings = STATE.source2.mappings;
                mappingsReady = Object.entries(COLUMN_CONFIG).every(([key, config]) => 
                    !config.required || (s1Mappings[key] !== undefined && s2Mappings[key] !== undefined)
                );
            }
            DOM.analyzeBtn.disabled = !mappingsReady;
            if (mappingsReady) DOM.analyzeBtn.textContent = 'Run Analysis';
            else if (!s1Ready || !s2Ready) DOM.analyzeBtn.textContent = 'Upload & Map Files to Begin';
            else DOM.analyzeBtn.textContent = 'Please map required columns (*)';
        }
        
        function exportResults() {
            const { matches, mismatches, missingInSource1, missingInSource2 } = STATE.analysisResults;
            const wb = XLSX.utils.book_new();

            const summaryData = [
                ["Matches", matches.length, matches.reduce((s,r)=>s+r.amount1,0), matches.reduce((s,r)=>s+r.amount2,0)],
                ["Mismatches", mismatches.length, mismatches.reduce((s,r)=>s+r.amount1,0), mismatches.reduce((s,r)=>s+r.amount2,0)],
                ["Missing in Source 2", missingInSource2.length, missingInSource2.reduce((s,r)=>s+r.amount1,0), 0],
                ["Missing in Source 1", missingInSource1.length, 0, missingInSource1.reduce((s,r)=>s+r.amount2,0)],
            ];
            const ws_summary = XLSX.utils.aoa_to_sheet([["Reconciliation Summary"],[],...summaryData]);
            XLSX.utils.book_append_sheet(wb, ws_summary, "Summary");

            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(matches.map(r => ({'App ID':r.appId, 'Amount':r.amount1, 'Date': formatDate(r.date1), 'Source 1 Filename': r.filename1}))), "Matches");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(mismatches.map(r => ({'App ID':r.appId, 'S1 Amount':r.amount1, 'S2 Amount':r.amount2, 'Difference': r.amount1 - r.amount2, 'S1 Commission': r.commission, 'TDS': r.tds, 'S1 Date': formatDate(r.date1), 'S2 Date': formatDate(r.date2), 'S1 Filename': r.filename1}))), "Mismatches");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(missingInSource2.map(r => ({'App ID':r.appId, 'S1 Amount':r.amount1, 'S1 Commission': r.commission, 'TDS': r.tds, 'S1 Date': formatDate(r.date1), 'S1 Filename': r.filename1}))), "Missing in Source 2");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(missingInSource1.map(r => ({'App ID':r.appId, 'S2 Amount':r.amount2, 'S2 Date': formatDate(r.date2)}))), "Missing in Source 1");
            
            const s1RawData = getFilteredData(1).map(r => {
                const taxableValue = r.data[STATE.source1.mappings.amount];
                const commission = r.data[STATE.source1.mappings.commission];
                const commissionRate = (taxableValue && commission) ? (commission / taxableValue) * 100 : 0;
                return {...Object.fromEntries(STATE.source1.headers.map((h, i) => [h, r.data[i]])), __filename: r.__filename, 'Commission Rate (%)': commissionRate.toFixed(2)};
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(s1RawData), "Processed Raw Data (S1)");
            
            const commissionSummary = s1RawData.reduce((acc, row) => {
                const rate = row['Commission Rate (%)'];
                if(!acc[rate]) acc[rate] = { rate, count: 0, totalTaxable: 0, totalCommission: 0 };
                acc[rate].count++;
                acc[rate].totalTaxable += parseFloat(row[STATE.source1.headers[STATE.source1.mappings.amount]]) || 0;
                acc[rate].totalCommission += parseFloat(row[STATE.source1.headers[STATE.source1.mappings.commission]]) || 0;
                return acc;
            }, {});
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(Object.values(commissionSummary)), "Commission Rate Summary");

            XLSX.writeFile(wb, `Reconciliation_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function parseDate(date) {
            if (date instanceof Date && !isNaN(date)) return date;
            if (typeof date === 'number') {
                const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                return new Date(excelEpoch.getTime() + date * 86400000);
            }
            if (typeof date === 'string') {
                const parsed = new Date(date);
                if (!isNaN(parsed)) return parsed;
            }
            return null;
        }

        function formatDate(date) {
            if (!(date instanceof Date) || isNaN(date)) return 'N/A';
            return date.toISOString().split('T')[0];
        }
        
        function showLoading() { DOM.loadingOverlay.classList.add('show'); }
        function hideLoading() { DOM.loadingOverlay.classList.remove('show'); }

        function initialize() {
            DOM.userInfo.textContent = `User: ksismad | UTC 2025-06-19 19:40:13`;
            document.getElementById('file-input-1').addEventListener('change', e => handleFileSelection(e.target.files, 1));
            document.getElementById('file-input-2').addEventListener('change', e => handleFileSelection(e.target.files, 2));
            DOM.analyzeBtn.addEventListener('click', runAnalysis);
            DOM.exportBtn.addEventListener('click', exportResults);
        }
        
        function detectColumnMappings(headers) {
            const mappings = {};
            for (const [key, config] of Object.entries(COLUMN_CONFIG)) {
                const foundIndex = headers.findIndex(h => h && config.patterns.some(p => p.test(h)));
                if (foundIndex !== -1) mappings[key] = foundIndex;
            }
            return mappings;
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
