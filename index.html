<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>App ID Analyzer (Bird's Eye Red Alert Suite)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {background:#f3f4f6;color:#1e293b;font-family:'Segoe UI',sans-serif;}
        .container {max-width:1200px;margin:40px auto;background:#fff;border-radius:16px;box-shadow:0 4px 20px #ccc;}
        .header {background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);color:#fff;padding:32px;position:relative;}
        .user-info {position:absolute;top:24px;right:40px;background:rgba(255,255,255,0.15);border-radius:16px;padding:6px 18px;}
        .upload-section {display:flex;gap:28px;padding:32px;}
        .upload-box {flex:1;min-width:300px;background:#f8fafc;border:2px dashed #cbd5e1;border-radius:12px;padding:24px;}
        .file-info {margin-top:12px;background:#d1fae5;color:#059669;border-radius:6px;padding:8px 16px;display:none;}
        .file-info.show {display:block;}
        .upload-btn {background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;}
        .options-section {padding:0 32px;}
        .option-group {margin-bottom:18px;}
        .option-label {font-weight:600;margin-bottom:8px;}
        .analyze-btn {width:calc(100% - 64px);margin:32px;padding:16px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;border:none;border-radius:12px;font-size:1.2rem;font-weight:700;cursor:pointer;}
        .analyze-btn:disabled {background:#9ca3af;cursor:not-allowed;}
        .results {margin:32px;display:none;}
        .results.show {display:block;}
        .table-container {overflow-x:auto;background:#fff;border-radius:12px;box-shadow:0 2px 4px #eee;}
        table {width:100%;border-collapse:collapse;}
        th, td {padding:12px;text-align:left;border-bottom:1px solid #e2e8f0;}
        th {background:#f8fafc;font-weight:600;}
        .red-row td {background:#fed7d7;}
        .pivot-summary {margin:24px 0;}
        .export-btn {margin-top:24px;}
        .loading-overlay {position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.9);display:none;align-items:center;justify-content:center;z-index:1000;}
        .loading-overlay.show {display:flex;}
        .spinner {width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;}
        @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        .commission-table th, .commission-table td {padding:6px 8px;}
        .big-number {font-size:2.6em;font-weight:700;color:#c53030;}
        .dashboard-cards {display:flex;gap:24px;margin:24px 0;}
        .dashboard-card {background:#f8fafc;border-radius:10px;padding:28px 22px;box-shadow:0 1px 3px #eee;flex:1;text-align:center;}
        .dashboard-card h2 {margin:0 0 12px 0;}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="user-info" id="user-info"></div>
        <h1>üîç App ID Analyzer & Bird's Eye Red Alert Suite</h1>
        <p>Perfect bird's-eye reconciliation, financial pivot, and export</p>
    </div>
    <div class="upload-section">
        <div class="upload-box">
            <h3>Source 1 Files</h3>
            <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls">
            <button class="upload-btn" id="upload-btn-1">Choose Files</button>
            <div id="file-info-1" class="file-info"></div>
        </div>
        <div class="upload-box">
            <h3>Source 2 File</h3>
            <input type="file" id="file-input-2" class="file-input" accept=".xlsx,.xls">
            <button class="upload-btn" id="upload-btn-2">Choose File</button>
            <div id="file-info-2" class="file-info"></div>
        </div>
    </div>
    <div class="options-section">
        <div class="option-group">
            <span class="option-label">Commission % (Expected)</span>
            <input type="number" id="expected-commission" value="0" style="width:70px;"> %
        </div>
        <div class="option-group">
            <label><input type="checkbox" id="apply-gst"> Apply 18% GST</label>
            <label style="margin-left:18px;"><input type="checkbox" id="round-off"> Round Off S1 Amount</label>
        </div>
    </div>
    <div class="commission-section" id="commission-section" style="padding:0 32px 24px 32px;">
        <h3>Financial Control Center</h3>
        <div id="commission-controls"></div>
    </div>
    <button id="analyze-btn" class="analyze-btn" disabled>Analyze Data</button>
    <div id="results" class="results"></div>
</div>
<div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
</div>
<script>
const STATE = {
    s1Files: [], s2File: null,
    s1Rows: [], s2Rows: [],
    s1Headers: [], s2Headers: [],
    s1Cols: {}, s2Cols: {},
    s1Fin: {},
    userInfo: {login:'ksismad', currentUTC: ''}
};
const DOM = {
    fileInput1: document.getElementById('file-input-1'),
    fileInput2: document.getElementById('file-input-2'),
    uploadBtn1: document.getElementById('upload-btn-1'),
    uploadBtn2: document.getElementById('upload-btn-2'),
    fileInfo1: document.getElementById('file-info-1'),
    fileInfo2: document.getElementById('file-info-2'),
    analyzeBtn: document.getElementById('analyze-btn'),
    results: document.getElementById('results'),
    loadingOverlay: document.getElementById('loading-overlay'),
    userInfo: document.getElementById('user-info'),
    commissionControls: document.getElementById('commission-controls')
};
function showLoading() { DOM.loadingOverlay.classList.add('show'); }
function hideLoading() { DOM.loadingOverlay.classList.remove('show'); }
function updateUserInfo() {
    const now = new Date();
    const utcString = now.toISOString().replace('T',' ').slice(0,19);
    STATE.userInfo.currentUTC = utcString;
    DOM.userInfo.textContent = `User: ${STATE.userInfo.login} | UTC ${utcString}`;
}
document.addEventListener('DOMContentLoaded', function() {
    updateUserInfo();
    setInterval(updateUserInfo, 15000);
});
DOM.uploadBtn1.onclick = ()=>DOM.fileInput1.click();
DOM.uploadBtn2.onclick = ()=>DOM.fileInput2.click();
DOM.fileInput1.onchange = (e)=>handleS1Files(e.target.files);
DOM.fileInput2.onchange = (e)=>handleS2File(e.target.files);
function handleS1Files(files) {
    showLoading();
    STATE.s1Files = [];
    STATE.s1Fin = {};
    let loaded = 0;
    STATE.s1Rows = [];
    for (const file of files) {
        processExcelFile(file, (err, data)=>{
            if(!err && data.length>1){
                STATE.s1Files.push({file,data});
                if (STATE.s1Headers.length === 0) STATE.s1Headers = data[0];
                STATE.s1Rows.push(...data.slice(1).map(row=>({filename:file.name, row})));
            }
            loaded++;
            if(loaded === files.length){
                initFinancialControls();
                renderFinancialControls();
                hideLoading(); updateFileInfo(1,files); updateAnalyzeButton();
            }
        });
    }
}
function handleS2File(files) {
    showLoading();
    const file = files[0];
    processExcelFile(file, (err, data)=>{
        if(!err && data.length>1){
            STATE.s2File = {file,data};
            STATE.s2Headers = data[0];
            STATE.s2Rows = data.slice(1).map(row=>({filename:file.name, row}));
        }
        hideLoading(); updateFileInfo(2,[file]);
        updateAnalyzeButton();
    });
}
function processExcelFile(file, cb) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            cb(null, jsonData);
        } catch (err) { cb(err); }
    };
    reader.onerror = function(err) { cb(err); };
    reader.readAsArrayBuffer(file);
}
function updateFileInfo(src, files) {
    const info = src===1?DOM.fileInfo1:DOM.fileInfo2;
    info.textContent = Array.from(files).map(f=>f.name).join(', ');
    info.classList.add('show');
}
function updateAnalyzeButton() {
    const ready = STATE.s1Files.length > 0 && STATE.s2File;
    DOM.analyzeBtn.disabled = !ready;
}
DOM.analyzeBtn.onclick = runAnalysis;
function getColIdx(headers, patterns) {
    for (let i=0;i<headers.length;i++) {
        const h = headers[i]||'';
        for (const p of patterns)
            if (p.test(h)) return i;
    }
    return -1;
}
//--- financial controls ---
function initFinancialControls() {
    STATE.s1Fin = {};
    for(const f of STATE.s1Files) {
        if(!STATE.s1Fin[f.file.name])
            STATE.s1Fin[f.file.name] = {tds:2, additional:0, mergedTo:'', origComm:0};
    }
    const commIdx = getColIdx(STATE.s1Headers,[/commission/i]);
    if(commIdx>=0) {
        for(const f of STATE.s1Files) {
            let sum = 0;
            for(const r of STATE.s1Rows) if(r.filename===f.file.name) sum+=parseFloat(r.row[commIdx])||0;
            STATE.s1Fin[f.file.name].origComm = sum;
        }
    }
}
function renderFinancialControls() {
    let html = `<table class="commission-table"><thead><tr><th>Filename</th><th>Orig. Comm</th><th>TDS %</th><th>Additional</th><th>Merge To</th></tr></thead><tbody>`;
    for(const k in STATE.s1Fin) {
        html += `<tr>
            <td>${k}</td>
            <td>${STATE.s1Fin[k].origComm.toFixed(2)}</td>
            <td><input type="number" style="width:50px" value="${STATE.s1Fin[k].tds}" onchange="STATE.s1Fin['${k}'].tds=this.value"></td>
            <td><input type="number" style="width:70px" value="${STATE.s1Fin[k].additional}" onchange="STATE.s1Fin['${k}'].additional=this.value"></td>
            <td><select onchange="STATE.s1Fin['${k}'].mergedTo=this.value"><option value="">--No Merge--</option>${Object.keys(STATE.s1Fin).filter(f=>f!==k).map(f=>`<option value="${f}">${f}</option>`).join('')}</select></td>
        </tr>`;
    }
    html += '</tbody></table>';
    DOM.commissionControls.innerHTML = html;
}
//--- main analysis ---
function runAnalysis() {
    showLoading();
    setTimeout(()=>{
        analyzeAndDisplay();
        hideLoading();
    },50);
}
function analyzeAndDisplay() {
    const s1h = STATE.s1Headers, s2h = STATE.s2Headers;
    STATE.s1Cols = {
        appId: getColIdx(s1h,[/app.*id|application.*id|id/i]),
        amount: getColIdx(s1h,[/amount|total/i]),
        status: getColIdx(s1h,[/status|state/i]),
        commission: getColIdx(s1h,[/commission/i])
    };
    STATE.s2Cols = {
        appId: getColIdx(s2h,[/app.*id|application.*id|id/i]),
        amount: getColIdx(s2h,[/amount|total/i])
    };
    const S1_ALL = {}, S1_PAID = {}, S1_UNPAID = {};
    for (const item of STATE.s1Rows) {
        const appId = (item.row[STATE.s1Cols.appId]||"").toString().trim();
        const status = (STATE.s1Cols.status>=0? (item.row[STATE.s1Cols.status]||"").toLowerCase().trim() : "paid");
        S1_ALL[appId] = item;
        if(status==="paid") S1_PAID[appId]=item;
        else if(status==="unpaid") S1_UNPAID[appId]=item;
    }
    const S2 = {};
    for (const item of STATE.s2Rows) {
        const appId = (item.row[STATE.s2Cols.appId]||"").toString().trim();
        S2[appId]=item;
    }
    const s1dups = findDuplicates(STATE.s1Rows.map(r=>r.row[STATE.s1Cols.appId]));
    const s2dups = findDuplicates(STATE.s2Rows.map(r=>r.row[STATE.s2Cols.appId]));
    const redAlerts = [], matches=[], mismatches=[], allComparisons=[];
    for(const id of s1dups) redAlerts.push({appId:id,amount:0,reason:'Duplicate in Source 1'});
    for(const id of s2dups) redAlerts.push({appId:id,amount:0,reason:'Duplicate in Source 2'});
    for(const appId in S2) {
        if(!S1_ALL[appId]) redAlerts.push({appId,amount:getAmount(S2[appId],STATE.s2Cols.amount),"reason":"Paid in S2, missing in S1"});
    }
    for(const appId in S1_PAID) {
        if(!S2[appId]) redAlerts.push({appId,amount:getAmount(S1_PAID[appId],STATE.s1Cols.amount),"reason":"Paid in S1, missing in S2"});
    }
    for(const appId in S2) {
        if(S1_ALL[appId]) {
            const s1item = S1_ALL[appId], s2item = S2[appId];
            const status = (STATE.s1Cols.status>=0? (s1item.row[STATE.s1Cols.status]||"").toLowerCase().trim() : "paid");
            let s1amt = getAmount(s1item,STATE.s1Cols.amount);
            let s2amt = getAmount(s2item,STATE.s2Cols.amount);
            if(document.getElementById('apply-gst').checked) s1amt*=1.18;
            s1amt += getFileFin(s1item.filename).additional||0;
            if(document.getElementById('round-off').checked) s1amt = Math.round(s1amt);
            const amtMatch = Math.abs(s1amt - s2amt) < 0.01;
            allComparisons.push({
                appId, s1filename:s1item.filename, s2filename:s2item.filename, s1amt, s2amt, status
            });
            if(status==="unpaid" && !amtMatch) {
                redAlerts.push({appId,amount:s2amt,reason:"Paid in S2, Unpaid in S1 & Amount Mismatch"});
                mismatches.push({appId, s1amt, s2amt, s1filename:s1item.filename, s2filename:s2item.filename, status, scenario:"5"});
            }
            else if(status==="unpaid") {
                redAlerts.push({appId,amount:s2amt,reason:"Paid in S2, Unpaid in S1"});
                mismatches.push({appId, s1amt, s2amt, s1filename:s1item.filename, s2filename:s2item.filename, status, scenario:"3"});
            }
            else if(status==="paid" && !amtMatch) {
                redAlerts.push({appId,amount:s2amt,reason:`Paid in S2 & S1, Amount Mismatch (S1:${s1amt}, S2:${s2amt})`});
                mismatches.push({appId, s1amt, s2amt, s1filename:s1item.filename, s2filename:s2item.filename, status, scenario:"4/8"});
            }
            else matches.push({appId, s1amt, s2amt, s1filename:s1item.filename, s2filename:s2item.filename, status});
        }
    }
    const expectedComm = parseFloat(document.getElementById('expected-commission').value)/100 || 0;
    const commDevs = [];
    if(STATE.s1Cols.commission>=0 && expectedComm>0){
        for(const appId in S1_PAID){
            const s1item = S1_PAID[appId];
            const taxableValue = parseFloat(s1item.row[STATE.s1Cols.amount])||0;
            const actualComm = parseFloat(s1item.row[STATE.s1Cols.commission])||0;
            const expected = taxableValue*expectedComm;
            if(Math.abs(actualComm-expected) > 0.01){
                commDevs.push({
                    appId,
                    filename:getMergedFilename(s1item.filename),
                    taxableValue,
                    actualComm,
                    expected,
                    dev:actualComm-expected,
                    devPerc: expected===0?0:((actualComm-expected)/expected*100).toFixed(2)
                });
            }
        }
    }
    const mergedFin = {};
    for(const fname in STATE.s1Fin) {
        let netComm = STATE.s1Fin[fname].origComm;
        let tdsPerc = parseFloat(STATE.s1Fin[fname].tds)||0;
        let addl = parseFloat(STATE.s1Fin[fname].additional)||0;
        for(const k in STATE.s1Fin) if(STATE.s1Fin[k].mergedTo===fname) netComm += STATE.s1Fin[k].origComm;
        const tds = netComm*tdsPerc/100;
        mergedFin[fname] = {
            filename:fname,
            netCommission:netComm,
            tds:tds,
            additional:addl,
            netPayable:netComm-tds+addl
        };
    }
    // Bird's Eye Dashboard
    const totalRedAlerts = redAlerts.length, totalCommDev = commDevs.length, totalDuplicates = s1dups.length+s2dups.length;
    const totalPotentialLoss = redAlerts.reduce((sum, x)=>sum+Number(x.amount||0),0) + commDevs.reduce((sum,x)=>sum+Number(x.dev||0),0);
    let html = `<div class="dashboard-cards">
        <div class="dashboard-card"><h2>Total Red Alerts</h2><div class="big-number">${totalRedAlerts}</div></div>
        <div class="dashboard-card"><h2>Commission Deviations</h2><div class="big-number">${totalCommDev}</div></div>
        <div class="dashboard-card"><h2>Duplicates</h2><div class="big-number">${totalDuplicates}</div></div>
        <div class="dashboard-card"><h2>Potential Loss</h2><div class="big-number">${totalPotentialLoss.toFixed(2)}</div></div>
    </div>`;
    html += `<h3>Red Alerts</h3>
        <div class="table-container"><table><thead><tr><th>App ID</th><th>Amount</th><th>Reason</th></tr></thead><tbody>`;
    for(const r of redAlerts)
        html += `<tr class="red-row"><td>${r.appId}</td><td>${r.amount}</td><td>${r.reason}</td></tr>`;
    html += `</tbody></table></div>`;
    html += `<h3>Commission Deviation (S1 Paid)</h3>
        <div class="table-container"><table><thead><tr><th>App ID</th><th>Merged File</th><th>Taxable Value</th><th>Actual</th><th>Expected</th><th>Dev</th><th>Dev %</th></tr></thead><tbody>`;
    for(const c of commDevs)
        html += `<tr><td>${c.appId}</td><td>${c.filename}</td><td>${c.taxableValue}</td><td>${c.actualComm}</td><td>${c.expected}</td><td>${c.dev}</td><td>${c.devPerc}%</td></tr>`;
    html += `</tbody></table></div>`;
    html += `<h3>Merged Filename-wise Net Commission</h3>
        <div class="table-container pivot-summary"><table><thead><tr><th>Filename</th><th>Net Commission</th><th>TDS</th><th>Additional</th><th>Net Payable</th></tr></thead><tbody>`;
    for(const k in mergedFin){
        const f = mergedFin[k];
        html += `<tr><td>${f.filename}</td><td>${f.netCommission.toFixed(2)}</td><td>${f.tds.toFixed(2)}</td><td>${f.additional.toFixed(2)}</td><td>${f.netPayable.toFixed(2)}</td></tr>`;
    }
    html += `</tbody></table></div>`;
    html += `<h3>Matches</h3>
        <div class="table-container"><table><thead><tr><th>App ID</th><th>S1 Amount</th><th>S2 Amount</th><th>S1 Filename</th><th>Status</th></tr></thead><tbody>`;
    for(const m of matches)
        html += `<tr><td>${m.appId}</td><td>${m.s1amt}</td><td>${m.s2amt}</td><td>${m.s1filename}</td><td>${m.status}</td></tr>`;
    html += `</tbody></table></div>`;
    html += `<h3>Mismatches</h3>
        <div class="table-container"><table><thead><tr><th>App ID</th><th>S1 Amount</th><th>S2 Amount</th><th>S1 Filename</th><th>Status</th><th>Scenario</th></tr></thead><tbody>`;
    for(const m of mismatches)
        html += `<tr><td>${m.appId}</td><td>${m.s1amt}</td><td>${m.s2amt}</td><td>${m.s1filename}</td><td>${m.status}</td><td>${m.scenario}</td></tr>`;
    html += `</tbody></table></div>`;
    html += `<h3>All S1-S2 Comparisons</h3>
        <div class="table-container"><table><thead><tr><th>App ID</th><th>S1 Amount</th><th>S2 Amount</th><th>S1 Filename</th><th>S2 Filename</th><th>Status</th></tr></thead><tbody>`;
    for(const m of allComparisons)
        html += `<tr><td>${m.appId}</td><td>${m.s1amt}</td><td>${m.s2amt}</td><td>${m.s1filename}</td><td>${m.s2filename}</td><td>${m.status}</td></tr>`;
    html += `</tbody></table></div>`;
    html += `<button class="upload-btn export-btn" id="export-btn">Export Full Excel Report</button>`;
    DOM.results.innerHTML = html;
    DOM.results.classList.add('show');
    document.getElementById('export-btn').onclick = ()=>exportExcel(redAlerts,commDevs,mergedFin,matches,mismatches,allComparisons);
}
function getAmount(item, idx) {
    let v = parseFloat(item.row[idx]);
    return isFinite(v)?v:0;
}
function getFileFin(fname) {
    let t = fname;
    for(let loop=0;loop<10;loop++) {
        const mt = STATE.s1Fin[t]&&STATE.s1Fin[t].mergedTo;
        if(mt && mt!==t) t = mt; else break;
    }
    return STATE.s1Fin[t]||{tds:2,additional:0,origComm:0};
}
function getMergedFilename(fname) {
    let t = fname;
    for(let loop=0;loop<10;loop++) {
        const mt = STATE.s1Fin[t]&&STATE.s1Fin[t].mergedTo;
        if(mt && mt!==t) t = mt; else break;
    }
    return t;
}
function findDuplicates(arr) {
    const seen = new Set(), dups = new Set();
    for(const x of arr){
        const v = (x||"").toString().trim();
        if(seen.has(v)) dups.add(v);
        else seen.add(v);
    }
    dups.delete("");
    return Array.from(dups);
}
// Excel Export
function exportExcel(redAlerts,commDevs,mergedFin,matches,mismatches,allComparisons){
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(redAlerts),"Red Alerts");
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(commDevs),"Commission Deviations");
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(Object.values(mergedFin)),"Merged Net Commission");
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(matches),"Matches");
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(mismatches),"Mismatches");
    XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(allComparisons),"All Comparisons");
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([["Filename",...STATE.s1Headers],...STATE.s1Rows.map(r=>[getMergedFilename(r.filename),...r.row])]),"Raw Source 1");
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([["Filename",...STATE.s2Headers],...STATE.s2Rows.map(r=>[r.filename,...r.row])]),"Raw Source 2");
    XLSX.writeFile(wb,`Reconciliation_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>
</body>
</html>
