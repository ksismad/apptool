<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App ID Analyzer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    html, body { background: #f3f4f6; color: #1e293b; font-family: 'Segoe UI', Arial, sans-serif; margin:0; padding:0;}
    .container { max-width: 1100px; margin: 36px auto 20px auto; background: #fff; border-radius: 18px; box-shadow: 0 8px 32px rgba(60,60,100,0.11); overflow: hidden; padding: 0 0 32px 0;}
    .header { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; text-align: left; padding: 32px 32px 20px 32px; position: relative; border-radius: 0 0 20px 20px; }
    .header h1 { margin: 0 0 8px 0; font-size: 2.25rem; display: flex; align-items: center; gap: 10px;}
    .header p { margin: 0; opacity: 0.95; font-size: 1.10rem; line-height: 1.5; }
    .user-info { position: absolute; top: 16px; right: 32px; background: rgba(255,255,255,0.15); padding: 7px 16px; border-radius: 20px; font-size: 0.93rem; }
    .main-content { padding: 32px; display: flex; flex-direction: column; gap: 28px;}
    .upload-section { display: flex; gap: 24px; flex-wrap: wrap;}
    .upload-box { background: #f8fafc; border-radius: 12px; padding: 24px; flex: 1 1 355px; min-width: 280px; border: 2px dashed #cbd5e1; position: relative;}
    .upload-box:hover { border-color: #6366f1; }
    .upload-box h3 { font-size: 1.13rem; font-weight: 600; margin: 0 0 6px 0; display: flex; gap: 8px; align-items: center;}
    .file-info { margin-top: 10px; color: #059669; font-weight: 600; padding: 8px 16px; background: #d1fae5; border-radius: 6px; display: inline-block; font-size: 0.98rem;}
    .file-input { display: none; }
    .file-input-wrapper { position: relative; overflow: visible; display: inline-block; margin-top: 8px;}
    .upload-btn { border: none; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; border-radius: 8px; padding: 10px 18px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-left: 0; }
    .upload-btn:focus { outline: 2px solid #6366f1; }
    .upload-btn:hover { background: linear-gradient(135deg,#4f46e5 0%, #a78bfa 100%);}
    .section { background: #f8fafc; border-radius: 12px; padding: 18px 22px 22px 22px; margin-bottom: 0; border: 1px solid #e2e8f0;}
    .section-title { font-size: 1.09rem; font-weight: 600; color: #4f46e5; margin: 0 0 14px 0; display: flex; align-items: center; gap: 8px;}
    .options-grid { display: flex; gap: 38px; flex-wrap: wrap; margin-top: 9px;}
    .option-group { display: flex; flex-direction: column; gap: 4px; min-width: 200px;}
    .option-label { font-weight: 600; color: #374151; font-size: 0.97rem; margin-bottom: 1px;}
    .col-select, .date-filter { width: 100%; padding: 7px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.98rem; background: #fff;}
    .checkbox-group { display: flex; align-items: center; gap: 8px; margin: 5px 0 0 0;}
    .validation-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-size: 1.01rem;}
    .validation-item.valid { color: #059669; }
    .validation-item.invalid { color: #dc2626; }
    .validation-item.valid::before { content: "‚úÖ"; }
    .validation-item.invalid::before { content: "‚ùå"; }
    .analyze-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 12px; font-size: 1.13rem; font-weight: 700; cursor: pointer; margin-top: 5px; }
    .analyze-btn:focus { outline: 2px solid #10b981; }
    .analyze-btn:hover:not(:disabled) { background: linear-gradient(135deg, #059669 0%, #10b981 100%);}
    .analyze-btn:disabled { background: #9ca3af; cursor: not-allowed;}
    .results { margin-top: 28px; }
    .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding: 16px; background: #f8fafc; border-radius: 8px;}
    .results-title { font-size: 1.32rem; font-weight: 700; color: #1e293b; margin: 0;}
    .results-meta { font-size: 0.89rem; color: #6b7280; text-align: right;}
    .stats-grid { display: flex; flex-wrap: wrap; gap: 18px; margin-bottom: 18px; margin-top: 6px;}
    .stat-card { background: #fff; padding: 16px 18px; border-radius: 12px; box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.08); text-align: center; border-left: 4px solid #6366f1; flex: 1 1 140px; min-width: 130px;}
    .stat-card.success { border-left-color: #10b981; }
    .stat-card.warning { border-left-color: #f59e0b; }
    .stat-card.danger { border-left-color: #ef4444; }
    .table-container { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 6px -1px rgba(0, 0, 0, 0.09); margin-bottom: 24px;}
    .table-header { background: #f8fafc; padding: 12px 18px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;}
    .table-title { font-size: 1.05rem; font-weight: 600; color: #1e293b;}
    .table-wrapper { overflow-x: auto; max-height: 350px; overflow-y: auto;}
    table { width: 100%; border-collapse: collapse; font-size: 0.97rem;}
    th, td { padding: 10px 13px; text-align: left; border-bottom: 1px solid #e2e8f0; white-space: nowrap;}
    th { background: #f8fafc; font-weight: 600; color: #374151; position: sticky; top: 0;}
    tr:hover { background: #f1f5f9; }
    .highlight-warning { background: #fef3c7; }
    .highlight-danger { background: #fee2e2; }
    .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;}
    .status-badge.match { background: #d1fae5; color: #065f46; }
    .status-badge.amount-mismatch { background: #fee2e2; color: #991b1b; }
    .error-msg, .success-msg { padding: 11px 15px; border-radius: 8px; margin: 13px 0; border-left-width: 4px; border-left-style: solid;}
    .error-msg { color: #dc2626; background: #fef2f2; border-color: #dc2626; }
    .success-msg { color: #059669; background: #ecfdf5; border-color: #059669; }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.25s;}
    .loading-overlay.hidden { opacity: 0; pointer-events: none; visibility: hidden;}
    .loading-spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;}
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .export-section { display: flex; gap: 16px; justify-content: center; margin-top: 32px; flex-wrap: wrap;}
    .export-btn, .fullview-btn { padding: 12px 24px; background: #059669; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;}
    .export-btn:hover, .fullview-btn:hover { background: #047857; transform: translateY(-1px);}
    .fullview-btn { background: #6366f1; margin-right: 8px;}
    .fullview-btn:hover { background: #4338ca; }
    .date-pickers { display: flex; gap: 10px; align-items: center; margin-top:4px;}
    .date-filter { min-width: 140px; }
    @media (max-width: 950px) { .main-content { padding: 18px 4vw; } .container { margin-top: 15px; } }
    @media (max-width: 700px) { .upload-section { flex-direction: column; } .main-content { padding: 8px 2vw; } .header { padding: 22px 10px 12px 10px; } .user-info { right: 10px; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="user-info" id="user-info"></div>
      <h1><span style="font-size:1.5em;">üîç</span> App ID Analyzer</h1>
      <p>Advanced multi-file Excel analysis with sorting, full-view, and comprehensive reporting.</p>
    </div>
    <div class="main-content">
      <div class="upload-section">
        <div class="upload-box" id="upload-box-1">
          <h3><span style="font-size:1.2em;">üìÅ</span> Source 1 Files</h3>
          <p>Select one or more Excel files</p>
          <div class="file-input-wrapper">
            <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls">
            <button class="upload-btn" id="upload-btn-1" type="button" tabindex="0">Choose Source 1 Files</button>
          </div>
          <div id="file-info-1" class="file-info hidden"></div>
          <div class="date-pickers">
            <label class="option-label">Date Filter:</label>
            <input type="date" id="date1-from" class="date-filter">
            <span>to</span>
            <input type="date" id="date1-to" class="date-filter">
          </div>
        </div>
        <div class="upload-box" id="upload-box-2">
          <h3><span style="font-size:1.2em;">üìÅ</span> Source 2 File</h3>
          <p>Select a single Excel file</p>
          <div class="file-input-wrapper">
            <input type="file" id="file-input-2" class="file-input" accept=".xlsx,.xls">
            <button class="upload-btn" id="upload-btn-2" type="button" tabindex="0">Choose Source 2 File</button>
          </div>
          <div id="file-info-2" class="file-info hidden"></div>
          <div class="date-pickers">
            <label class="option-label">Date Filter:</label>
            <input type="date" id="date2-from" class="date-filter">
            <span>to</span>
            <input type="date" id="date2-to" class="date-filter">
          </div>
        </div>
      </div>
      <div class="section" style="margin-bottom:0;">
        <div class="section-title">‚öôÔ∏è Options</div>
        <div class="options-grid">
          <div class="option-group">
            <label class="option-label" for="source1-paid-filter">Paid/Unpaid Filter <span style="color:#64748b;font-weight:400;font-size:0.93em;">(Source 1)</span></label>
            <select id="source1-paid-filter" class="col-select">
              <option value="all">Include All</option>
              <option value="paid">Only Paid</option>
              <option value="unpaid">Only Unpaid</option>
            </select>
          </div>
          <div class="option-group">
            <label class="option-label" for="apply-gst">GST Adjustment <span style="color:#64748b;font-weight:400;font-size:0.93em;">(Source 1)</span></label>
            <div class="checkbox-group">
              <input type="checkbox" id="apply-gst">
              <label for="apply-gst">Apply 18% GST to Source 1 Amount</label>
            </div>
            <div style="font-size:0.92em;color:#4b5563;margin-top:2px;">
              (When checked, all Source 1 Amounts will include GST in analysis and export)
            </div>
          </div>
        </div>
      </div>
      <div id="dynamic-cols-1"></div>
      <div id="dynamic-cols-2"></div>
      <div id="validation-status" class="section">
        <h3 class="section-title"><span style="font-size:1.1em;">üìù</span> Validation Status</h3>
        <div id="validation-items"></div>
      </div>
      <button id="analyze-btn" class="analyze-btn" disabled>Please complete setup</button>
      <div id="error-container"></div>
      <div id="results" class="results hidden"></div>
      <div class="export-section hidden" id="export-section">
        <button class="fullview-btn" id="fullview-btn">Open Full View (New Tab)</button>
        <button class="export-btn" id="export-excel-btn">Export Report (Excel)</button>
      </div>
    </div>
  </div>
  <div id="loading-overlay" class="loading-overlay hidden">
    <div class="loading-spinner" aria-label="Loading..."></div>
    <p>Processing data, please wait...</p>
  </div>
  <script>
    // File selection: always trigger file input!
    document.getElementById('upload-btn-1').onclick = function() {
      document.getElementById('file-input-1').value = '';
      document.getElementById('file-input-1').click();
    };
    document.getElementById('upload-btn-2').onclick = function() {
      document.getElementById('file-input-2').value = '';
      document.getElementById('file-input-2').click();
    };
    document.getElementById('upload-btn-1').onkeydown = function(e) {
      if (e.key === ' ' || e.key === 'Enter') document.getElementById('upload-btn-1').click();
    };
    document.getElementById('upload-btn-2').onkeydown = function(e) {
      if (e.key === ' ' || e.key === 'Enter') document.getElementById('upload-btn-2').click();
    };

    // (The rest of the script is exactly as in the previous expanded answer, see above for the complete logic.)
    // If you want the full script again pasted below, just say "continue" and I will paste all code in smaller chunks.
  </script>
</body>
</html>
