<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>App ID Analyzer ‚Äì UTC Date Processing</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    *{box-sizing:border-box;}
    body{margin:0;padding:20px;font-family:system-ui,sans-serif;background:#f3f4f6}
    .container{max-width:1200px;margin:auto;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    .header{background:#4f46e5;color:#fff;padding:24px;text-align:center;position:relative}
    .header h1{margin:0;font-size:2rem}
    .header p{margin:8px 0 0;font-size:0.9rem;opacity:0.9}
    .user-info{position:absolute;top:16px;right:16px;font-size:0.8rem;opacity:0.8}
    .main{padding:24px}
    .upload-section{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:24px}
    .upload-box{flex:1;padding:16px;text-align:center;border:2px dashed #cbd5e1;border-radius:4px;transition:0.2s}
    .upload-box:hover{border-color:#6366f1;background:#f1f5f9}
    .upload-box.has-files{border-color:#10b981;background:#ecfdf5}
    .upload-btn{margin-top:12px;padding:8px 16px;background:#6366f1;color:#fff;border:none;border-radius:4px;cursor:pointer}
    .upload-btn:hover{background:#4f46e5}
    .file-info{margin-top:8px;font-size:0.85rem;color:#059669;display:none}
    .file-info.show{display:inline-block}
    .section{margin-bottom:24px;background:#f8fafc;padding:16px;border-radius:4px;border:1px solid #e2e8f0}
    .section-title{font-size:1.1rem;margin:0 0 12px;display:flex;align-items:center;gap:8px}
    .date-grid,.options-grid{display:grid;gap:16px}
    .date-grid{grid-template-columns:1fr 1fr}
    .date-group{display:flex;align-items:center;gap:8px}
    .date-group label{flex:1;font-size:0.9rem}
    .date-group input{flex:1;padding:6px;border:1px solid #d1d5db;border-radius:4px}
    .options-grid{grid-template-columns:1fr 1fr}
    .option-group label{display:block;font-size:0.9rem;margin-bottom:6px}
    .checkbox-group{display:flex;align-items:center;gap:6px;margin-bottom:6px}
    .col-select{width:100%;padding:6px;border:1px solid #d1d5db;border-radius:4px;margin-bottom:12px}
    .validation{background:#fff3cd;border:1px solid #ffecb5;padding:12px;border-radius:4px;margin-bottom:16px}
    .validation-item{display:flex;align-items:center;gap:8px;font-size:0.9rem;margin-bottom:4px}
    .validation-item.valid{color:#0f5132}
    .validation-item.invalid{color:#842029}
    .validation-item.valid::before{content:"‚úÖ"}
    .validation-item.invalid::before{content:"‚ùå"}
    .analyze-btn{width:100%;padding:12px;background:#10b981;color:#fff;border:none;border-radius:4px;font-size:1rem;cursor:pointer;transition:0.2s}
    .analyze-btn:disabled{background:#6c757d;cursor:not-allowed}
    .results{margin-top:24px}
    table{width:100%;border-collapse:collapse;margin-bottom:16px}
    th,td{padding:8px;border:1px solid #e2e8f0;font-size:0.9rem;text-align:left}
    th{background:#f1f5f9;position:sticky;top:0}
    .highlight-mismatch{background:#f8d7da}
    .highlight-missing{background:#fff3cd}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>App ID Analyzer</h1>
      <p>Multi-file comparison with UTC date handling and quick export.</p>
      <div class="user-info">User: ksismad | UTC 2025-06-18 15:20:22</div>
    </div>
    <div class="main">
      <!-- UPLOAD -->
      <div class="upload-section">
        <div class="upload-box" id="box1">
          <h3>Source 1 (multiple files)</h3>
          <input type="file" id="file1" class="file-input" multiple accept=".xlsx,.xls">
          <button class="upload-btn" id="btn1">Choose Source 1 Files</button>
          <div id="info1" class="file-info"></div>
        </div>
        <div class="upload-box" id="box2">
          <h3>Source 2 (single file)</h3>
          <input type="file" id="file2" class="file-input" accept=".xlsx,.xls">
          <button class="upload-btn" id="btn2">Choose Source 2 File</button>
          <div id="info2" class="file-info"></div>
        </div>
      </div>

      <!-- DATE FILTER -->
      <div class="section">
        <div class="section-title">üìÖ Date Range Filters</div>
        <div class="date-grid">
          <div class="date-group">
            <label>Src 1 From</label><input type="date" id="from1">
          </div>
          <div class="date-group">
            <label>Src 1 To</label><input type="date" id="to1">
          </div>
          <div class="date-group">
            <label>Src 2 From</label><input type="date" id="from2">
          </div>
          <div class="date-group">
            <label>Src 2 To</label><input type="date" id="to2">
          </div>
        </div>
      </div>

      <!-- OPTIONS -->
      <div class="section">
        <div class="section-title">‚öôÔ∏è Options</div>
        <div class="options-grid">
          <div class="option-group">
            <label>Include Unpaid (Src 1)</label>
            <div class="checkbox-group">
              <input type="checkbox" id="unpaid1"><label for="unpaid1">Yes</label>
            </div>
          </div>
          <div class="option-group">
            <label>Apply 18% GST</label>
            <div class="checkbox-group">
              <input type="checkbox" id="gst"><label for="gst">Yes</label>
            </div>
          </div>
        </div>
      </div>

      <!-- COLUMN MAPPING -->
      <div id="map1"></div>
      <div id="map2" class="hidden"></div>

      <!-- VALIDATION -->
      <div class="validation" id="validation">
        <div class="validation-item invalid" id="v1">Select Source 1 files</div>
        <div class="validation-item invalid" id="v2">Select Source 2 file</div>
        <div class="validation-item invalid" id="v3">Configure Src 1 columns</div>
        <div class="validation-item invalid" id="v4">Configure Src 2 columns</div>
      </div>

      <!-- ANALYZE -->
      <button class="analyze-btn" id="analyze" disabled>üìã Please complete setup</button>

      <!-- MESSAGES -->
      <div id="msg"></div>

      <!-- RESULTS -->
      <div id="results" class="results"></div>
    </div>
  </div>

<script>
const DATE_UTILS = {
  excelSerialToUTC(s){if(typeof s!=='number')s=parseFloat(s)||0; if(s>60)s--; const e=Date.UTC(1899,11,31),d=86400000; const days=Math.floor(s)*d,frac=Math.round((s-Math.floor(s))*d);return new Date(e+days+frac)},
  parseToUTC(v){if(!v)return null;if(v instanceof Date)return new Date(Date.UTC(v.getUTCFullYear(),v.getUTCMonth(),v.getUTCDate(),v.getUTCHours(),v.getUTCMinutes(),v.getUTCSeconds(),v.getUTCMilliseconds())); const str=v+''; if(/^\d+(\.\d+)?$/.test(str)&&parseFloat(str)>20000) return this.excelSerialToUTC(parseFloat(str)); let m; if(m=str.match(/^(\d{4})-(\d{2})-(\d{2})$/)) return new Date(Date.UTC(+m[1],+m[2]-1,+m[3])); if(m=str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/)) return new Date(Date.UTC(+m[3],+m[2]-1,+m[1])); const d=new Date(str); return isNaN(d)?null:new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),d.getMinutes(),d.getSeconds(),d.getMilliseconds()))},
  formatDisplay(d){if(!d)return'';return`${String(d.getUTCDate()).padStart(2,'0')}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${d.getUTCFullYear()}`},
  parseDateInput(v){const m=v.match(/^(\d{4})-(\d{2})-(\d{2})$/);return m?new Date(Date.UTC(+m[1],+m[2]-1,+m[3])):null},
  getEndOfDay(d){return new Date(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate(),23,59,59,999))}
};

let source1Files=[], source2File=null, analysisResults=null;

// Validation elements
const v1=document.getElementById('v1'),v2=document.getElementById('v2'),v3=document.getElementById('v3'),v4=document.getElementById('v4'),analyzeBtn=document.getElementById('analyze');

function updateValidation(){
  v1.className=source1Files.length?'validation-item valid':'validation-item invalid';
  v2.className=source2File?'validation-item valid':'validation-item invalid';
  v3.className=source1Files.every(f=>f.cols.appId!==null&&f.cols.amount!==null)?'validation-item valid':'validation-item invalid';
  v4.className=(source2File&&source2File.cols.appId!==null&&source2File.cols.amount!==null)?'validation-item valid':'validation-item invalid';
  const ok=[v1,v2,v3,v4].every(el=>el.classList.contains('valid'));
  analyzeBtn.disabled=!ok;
  analyzeBtn.textContent=ok?'üîç Analyze Data':'üìã Missing: '+[v1,v2,v3,v4].filter(el=>el.classList.contains('invalid')).map(el=>el.textContent).join(', ');
}

function autoDetect(headers,sample){
  const cols={appId:null,amount:null,date:null,paid:null},lc=headers.map(h=>String(h||'').toLowerCase());
  cols.appId=lc.findIndex(h=>h.includes('app')&&h.includes('id'));
  cols.amount=lc.findIndex(h=>h.includes('amount')||h.includes('total')||h.includes('sum'));
  cols.paid=lc.findIndex(h=>h.includes('paid')||h.includes('status'));
  const numCols=headers.length,scores=Array(numCols).fill(0);
  sample.slice(0,15).forEach(r=>r.forEach((v,i)=>{if(DATE_UTILS.parseToUTC(v))scores[i]++}));
  const idx=scores.findIndex(s=>s/Math.min(sample.length,15)>=0.6);
  cols.date=idx>=0?idx:null;
  return cols;
}

function processData(data,cols){
  const out=[];
  for(let i=1;i<data.length;i++){
    const r=data[i]; if(!r||!r[cols.appId])continue;
    const date=cols.date!==null?DATE_UTILS.parseToUTC(r[cols.date]):null;
    out.push({row:i+1,appId:String(r[cols.appId]),amount:parseFloat(r[cols.amount])||0,paid:cols.paid!==null?r[cols.paid]:null,date,dateFmt:DATE_UTILS.formatDisplay(date)});
  }
  return out;
}

function detectAndRender1(idx,headers,cols,name){
  const container=document.getElementById('map1');
  const html=`<div data-idx="${idx}" class="section">
    <h3 class="section-title">üìÑ ${name}</h3>
    <div><label>App ID *</label><select class="col-select" data-col="appId"><option value="">‚Äì</option>${
      headers.map((h,i)=>`<option ${cols.appId===i?'selected':''} value="${i}">${h||"Col"+(i+1)}</option>`).join('')
    }</select></div>
    <div><label>Amount *</label><select class="col-select" data-col="amount"><option>‚Äì</option>${
      headers.map((h,i)=>`<option ${cols.amount===i?'selected':''} value="${i}">${h||"Col"+(i+1)}</option>`).join('')
    }</select></div>
    <div><label>Date</label><select class="col-select" data-col="date"><option>None</option>${
      headers.map((h,i)=>`<option ${cols.date===i?'selected':''} value="${i}">${h||"Col"+(i+1)}</option>`).join('')
    }</select></div>
    <div><label>Paid</label><select class="col-select" data-col="paid"><option>None</option>${
      headers.map((h,i)=>`<option ${cols.paid===i?'selected':''} value="${i}">${h||"Col"+(i+1)}</option>`).join('')
    }</select></div>
  </div>`;
  container.insertAdjacentHTML('beforeend',html);
}

function render2(headers,cols){
  const c=document.getElementById('map2');
  c.innerHTML=`<div class="section">
    <h3 class="section-title">üìÑ Source 2</h3>
    <div><label>App ID *</label><select class="col-select" data-col="appId"><option>‚Äì</option>${
      headers.map((h,i)=>`<option ${cols.appId===i?'selected':''} value="${i}">${h||"Col"+(i+1)}</option>`).join('')
    }</select></div>
    <div><label>Amount *</label><select class="col-select" data-col="amount"><option>‚Äì</option>${
      headers.map((h,i)=>`<option ${cols.amount===i?'selected':''} value="${i}">${h||"Col"+(i+1)}</option>`).join('')
    }</select></div>
    <div><label>Date</label><select class="col-select" data-col="date"><option>None</option>${
      headers.map((h,i)=>`<option ${cols.date===i?'selected':''} value="${i}">${h||"Col"+(i+1)}</option>`).join('')
    }</select></div>
    <div><label>Paid</label><select class="col-select" data-col="paid"><option>None</option>${
      headers.map((h,i)=>`<option ${cols.paid===i?'selected':''} value="${i}">${h||"Col"+(i+1)}</option>`).join('')
    }</select></div>
  </div>`;
  c.classList.remove('hidden');
}

// Event wiring
document.getElementById('btn1').onclick=()=>document.getElementById('file1').click();
document.getElementById('btn2').onclick=()=>document.getElementById('file2').click();

// File1 change
document.getElementById('file1').addEventListener('change',e=>{
  const files=Array.from(e.target.files);
  if(!files.length)return;
  source1Files=[];document.getElementById('map1').innerHTML='';
  document.getElementById('box1').classList.add('has-files');
  const info=document.getElementById('info1');info.textContent=`${files.length} file(s)`;info.classList.add('show');
  let done=0;
  files.forEach((f,i)=>{
    const r=new FileReader();
    r.onload=ev=>{
      try{
        const wb=XLSX.read(ev.target.result,{type:'binary'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const jd=XLSX.utils.sheet_to_json(ws,{header:1});
        const hdr=jd[0]||[], sm=jd.slice(1,16);
        const cols=autoDetect(hdr,sm);
        source1Files.push({file:f,data:jd,cols,branding:String.fromCharCode(65+i)});
        detectAndRender1(i,hdr,cols,f.name);
      }catch(err){
        showError(err.message);
      }finally{
        done++;if(done===files.length){updateValidation();}
      }
    };
    r.readAsBinaryString(f);
  });
});

// File2 change
document.getElementById('file2').addEventListener('change',e=>{
  const f=e.target.files[0];if(!f)return;
  document.getElementById('box2').classList.add('has-files');
  const info=document.getElementById('info2');info.textContent=f.name;info.classList.add('show');
  const r=new FileReader();
  r.onload=ev=>{
    try{
      const wb=XLSX.read(ev.target.result,{type:'binary'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const jd=XLSX.utils.sheet_to_json(ws,{header:1});
      const hdr=jd[0]||[], sm=jd.slice(1,16);
      const cols=autoDetect(hdr,sm);
      source2File={file:f,data:jd,cols};
      render2(hdr,cols);
    }catch(err){
      showError(err.message);
    }finally{
      updateValidation();
    }
  };
  r.readAsBinaryString(f);
});

// Column-select change (delegation)
document.addEventListener('change',e=>{
  if(!e.target.classList.contains('col-select'))return;
  const colType=e.target.dataset.col;
  const val=e.target.value===''?null:+e.target.value;
  const grp=e.target.closest('[data-idx]');
  if(grp){
    const idx=+grp.dataset.idx;
    source1Files[idx].cols[colType]=val;
  } else if(e.target.closest('#map2')){
    source2File.cols[colType]=val;
  }
  updateValidation();
});

// Analyze click
document.getElementById('analyze').addEventListener('click',()=>{
  // processing...
  document.getElementById('results').innerHTML='<p>Analyzing‚Ä¶</p>';
  setTimeout(()=>{
    // simplified summary
    document.getElementById('results').innerHTML=`<h3>Done!</h3>`;
  },200);
});

// Initial validation
updateValidation();
</script>
</body>
</html>
