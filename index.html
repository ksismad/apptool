<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>App ID Analyzer (ksismad)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    html, body { background: #f3f4f6; color: #1e293b; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; }
    .container { max-width: 1200px; margin: 36px auto; background: #fff; border-radius: 18px; box-shadow: 0 8px 32px rgba(60,60,100,0.11); overflow: hidden; }
    .header { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; padding: 32px; position: relative; }
    .header h1 { margin: 0 0 8px; font-size: 2.25rem; }
    .user-info { position: absolute; top: 16px; right: 32px; background: rgba(255,255,255,0.15); padding: 7px 16px; border-radius: 20px; font-size: 0.93rem; }

    .upload-section { display: flex; gap: 24px; padding: 32px; flex-wrap: wrap; }
    .upload-box { flex: 1; min-width: 300px; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 12px; padding: 24px; position: relative; transition: border-color .2s, background .2s; }
    .upload-box.source2 { border-color: #059669; background: #f0fdf4; }
    .upload-box.source2::after { content: "(Paid Source)"; color: #059669; font-size: .875rem; display: block; margin-top:8px; }
    .upload-box.dragover { border-color: #6366f1; background: #eef4ff; }
    .file-input { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
    .upload-btn { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .upload-btn.source2 { background: linear-gradient(135deg, #059669, #10b981); }
    .file-info { margin-top: 12px; padding:8px 16px; background: #d1fae5; color: #059669; border-radius:6px; display:none; }
    .file-info.show { display:inline-block; }

    .column-mappings, .options-section, .results { padding: 0 32px; }
    .mapping-group, .option-group { margin-bottom: 24px; }
    select, input[type="number"] { padding:8px 12px; border:1px solid #cbd5e1; border-radius:6px; }
    .analyze-btn { width: calc(100% - 64px); margin:32px; padding:16px; background: linear-gradient(135deg, #10b981, #059669); color:#fff; border:none; border-radius:12px; font-size:1.2rem; font-weight:600; cursor:pointer; }
    .analyze-btn:disabled { background:#9ca3af; cursor:not-allowed; }

    .results-header, .stats-grid, .table-section { margin-bottom:24px; }
    .stat-card { background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:12px 16px; border-bottom:1px solid #e2e8f0; }
    th { background:#f8fafc; }
    .amount-cell { text-align:right; font-family:monospace; }
    .amount-cell.paid::after { content:" ‚úì"; color:#059669; }
    .variance-cell { text-align:right; font-family:monospace; font-weight:600; }
    .positive-variance { color:#dc2626; }
    .negative-variance { color:#059669; }

    .loading-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.9); display:flex; align-items:center; justify-content:center; z-index:1000; visibility:hidden; opacity:0; transition:opacity .2s; }
    .loading-overlay.show { visibility:visible; opacity:1; }
    .spinner { width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; animation:spin 1s linear infinite; }

    .error-message { margin:16px 32px; padding:12px 16px; background:#fee2e2; color:#b91c1c; border-radius:8px; display:none; }
    .error-message.show { display:block; }

    @keyframes spin { 0%{transform:rotate(0);}100%{transform:rotate(360deg);} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="user-info" id="user-info">User: ksismad | UTC 2025-06-20 14:53:32</div>
      <h1>üîç App ID Analyzer</h1>
      <p>Compare and analyze app transaction data</p>
    </div>

    <div class="upload-section">
      <div class="upload-box" id="drop1">
        <h3>Source 1 Files</h3>
        <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls">
        <button class="upload-btn" id="upload-btn-1">Choose Files</button>
        <div id="file-info-1" class="file-info"></div>
      </div>
      <div class="upload-box source2" id="drop2">
        <h3>Source 2 File (Paid)</h3>
        <input type="file" id="file-input-2" class="file-input" accept=".xlsx,.xls">
        <button class="upload-btn source2" id="upload-btn-2">Choose File</button>
        <div id="file-info-2" class="file-info"></div>
      </div>
    </div>

    <div id="column-mappings" class="column-mappings"></div>

    <div class="options-section">
      <div class="option-group">
        <label>Analysis Type:</label>
        <select id="analysis-type">
          <option value="all">All Records</option>
          <option value="mismatches">Only Mismatches</option>
          <option value="missing">Only Missing Records</option>
        </select>
        <label><input type="checkbox" id="include-commission"> Include Commission Analysis</label>
        <label><input type="checkbox" id="apply-gst"> Apply 18% GST</label>
      </div>
      <div class="option-group">
        <label>Variance Threshold:</label>
        <input type="number" id="variance-threshold" value="0.01" step="0.01" min="0">
      </div>
    </div>

    <div id="error-message" class="error-message"></div>
    <button id="analyze-btn" class="analyze-btn" disabled>Analyze Data</button>
    <div id="results" class="results"></div>
  </div>

  <div id="loading-overlay" class="loading-overlay"><div class="spinner"></div></div>

  <script>
    // Helper for selector
    function $(sel) { return document.querySelectorAll(sel); }

    // STATE
    const STATE = {
      source1Files: [], source2File: null, columnMappings: {},
      analysisOptions: { type:'all', includeCommission:false, applyGST:false, varianceThreshold:0.01 }
    };
    // DOM
    const DOM = {
      fileInput1: $('#file-input-1')[0],
      fileInput2: $('#file-input-2')[0],
      uploadBtn1: $('#upload-btn-1')[0],
      uploadBtn2: $('#upload-btn-2')[0],
      drop1: $('#drop1')[0],
      drop2: $('#drop2')[0],
      fileInfo1: $('#file-info-1')[0],
      fileInfo2: $('#file-info-2')[0],
      columnMappings: $('#column-mappings')[0],
      analysisType: $('#analysis-type')[0],
      includeCommission: $('#include-commission')[0],
      applyGST: $('#apply-gst')[0],
      varianceThreshold: $('#variance-threshold')[0],
      analyzeBtn: $('#analyze-btn')[0],
      results: $('#results')[0],
      loadingOverlay: $('#loading-overlay')[0],
      errorMessage: $('#error-message')[0],
      userInfo: $('#user-info')[0]
    };

    // UTIL
    function showLoading() { DOM.loadingOverlay.classList.add('show'); }
    function hideLoading() { DOM.loadingOverlay.classList.remove('show'); }
    function showError(msg) {
      DOM.errorMessage.textContent = msg;
      DOM.errorMessage.classList.add('show');
      setTimeout(()=>DOM.errorMessage.classList.remove('show'),5000);
    }
    function updateUserInfo() {
      const now=new Date().toISOString().replace('T',' ').slice(0,19);
      DOM.userInfo.textContent=`User: ksismad | UTC ${now}`;
    }

    // FILE HANDLERS
    function initFileHandlers() {
      // click ‚Üí input
      DOM.uploadBtn1.onclick = e=>{e.preventDefault(); DOM.fileInput1.value=''; DOM.fileInput1.click();};
      DOM.uploadBtn2.onclick = e=>{e.preventDefault(); DOM.fileInput2.value=''; DOM.fileInput2.click();};
      // drag & drop
      [ {drop:DOM.drop1,src:1}, {drop:DOM.drop2,src:2} ].forEach(o=>{
        o.drop.ondragover = e=>{e.preventDefault(); o.drop.classList.add('dragover');};
        o.drop.ondragleave= e=>{e.preventDefault(); o.drop.classList.remove('dragover');};
        o.drop.ondrop     = e=>{
          e.preventDefault();
          o.drop.classList.remove('dragover');
          const files=e.dataTransfer.files;
          if(files.length) handleFileSelection(o.src===1?files:[files[0]],o.src);
        };
      });
      // change
      DOM.fileInput1.onchange = e=>{ if(e.target.files.length) handleFileSelection(e.target.files,1); };
      DOM.fileInput2.onchange = e=>{ if(e.target.files.length) handleFileSelection([e.target.files[0]],2); };
    }

    // PROCESS
    function handleFileSelection(files,src){
      if(!files.length){ showError('No files'); return;}
      showLoading();
      if(src===1){
        STATE.source1Files=[]; 
        let processed = 0;
        Array.from(files).forEach((f,i)=>{
          processExcelFile(f,(err,data)=>{
            if(!err){
              STATE.source1Files.push({file:f,headers:data[0],records:data.slice(1)});
              DOM.fileInfo1.textContent=Array.from(files).map(x=>x.name).join(', ');
              DOM.fileInfo1.classList.add('show');
            } else { showError(err.message); }
            processed++;
            if(processed===files.length){ hideLoading(); setupColumnMappings(); updateAnalyzeBtn();}
          });
        });
      } else {
        const f=files[0];
        processExcelFile(f,(err,data)=>{
          if(!err){
            STATE.source2File={file:f,headers:data[0],records:data.slice(1).map(r=>({...r,isPaid:true}))};
            DOM.fileInfo2.textContent=f.name; DOM.fileInfo2.classList.add('show');
            setupColumnMappings(); updateAnalyzeBtn();
          } else showError(err.message);
          hideLoading();
        });
      }
    }
    function processExcelFile(file,cb){
      const rd=new FileReader();
      rd.onload=e=>{
        try{
          const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
          const js=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
          if(js.length<2) return cb(new Error('No data rows'));
          cb(null,js);
        }catch(er){cb(er);}
      };
      rd.onerror=()=>cb(new Error('Read error'));
      rd.readAsArrayBuffer(file);
    }

    // COLUMN MAP
    function setupColumnMappings(){
      const h1=STATE.source1Files[0]?.headers||[],h2=STATE.source2File?.headers||[];
      if(!h1.length||!h2.length) return;
      const cols=[{id:'appId',lbl:'App ID',patt:[/app.*id/i,/id/i]},
                  {id:'amount',lbl:'Amount',patt:[/amount/i,/total/i]},
                  {id:'date',lbl:'Date',patt:[/date/i,/timestamp/i]},
                  {id:'status',lbl:'Status',patt:[/status/i,/state/i]}];
      let html=`<div class="mapping-group"><strong>Column Mappings</strong>`;
      cols.forEach(c=>{
        html+=`<div><label>${c.lbl}:</label>
                <select id="ms1-${c.id}"><option value="">Select S1</option>${
                  h1.map((h,i)=>`<option value="${i}">${h}</option>`).join('')
                }</select>
                <select id="ms2-${c.id}"><option value="">Select S2</option>${
                  h2.map((h,i)=>`<option value="${i}">${h}</option>`).join('')
                }</select></div>`;
      });
      html+=`</div>`;
      DOM.columnMappings.innerHTML=html;
      cols.forEach(c=>{
        const s1=document.getElementById(`ms1-${c.id}`),
              s2=document.getElementById(`ms2-${c.id}`);
        const auto1=findMatch(h1,c.patt), auto2=findMatch(h2,c.patt);
        if(auto1!=='') s1.value=auto1; if(auto2!=='') s2.value=auto2;
        [s1,s2].forEach(el=>el.onchange=updateColumnMappings);
      });
      updateColumnMappings();
    }
    function findMatch(h,p){
      for(let r of p){
        const idx=h.findIndex(x=>x&&r.test(x));
        if(idx!==-1) return idx;
      }
      return '';
    }
    function updateColumnMappings(){
      STATE.columnMappings={};
      ['appId','amount','date','status'].forEach(k=>{
        STATE.columnMappings[k]={
          source1:document.getElementById(`ms1-${k}`).value,
          source2:document.getElementById(`ms2-${k}`).value
        };
      });
      updateAnalyzeBtn();
    }

    // ANALYZE BUTTON
    function updateAnalyzeBtn(){
      const ok=STATE.source1Files.length>0 && STATE.source2File &&
               Object.values(STATE.columnMappings).every(m=>m.source1!=="" && m.source2!=="");
      DOM.analyzeBtn.disabled=!ok;
      DOM.analyzeBtn.textContent=ok?'Analyze Data':'Please select & map columns';
    }

    // ANALYSIS
    function analyzeData(){
      const d1=STATE.source1Files.flatMap(f=>f.records),
            d2=STATE.source2File.records,
            m=STATE.columnMappings,
            thr=parseFloat(DOM.varianceThreshold.value)||0.01,
            includeCommission = DOM.includeCommission.checked,
            applyGST = DOM.applyGST.checked,
            analysisType = DOM.analysisType.value;
      let res={matches:0,mismatches:[],missing:[],redAlerts:[],commissionDeviations:[]};
      const map2=new Map();
      d2.forEach(r=>{ 
        const id=r[m.appId.source2]; 
        if(id !== undefined && id !== null && id !== "") map2.set(id.toString(),r); 
      });
      d1.forEach(r1=>{
        const id=r1[m.appId.source1];
        if(id === undefined || id === null || id === "") return;
        const r2=map2.get(id.toString());
        if(r2){
          let a1=parseFloat(r1[m.amount.source1])||0, a2=parseFloat(r2[m.amount.source2])||0;
          if(applyGST){a1*=1.18;a2*=1.18;}
          const varc=a2-a1, absVar=Math.abs(varc);
          if(absVar<=thr){
            if(analysisType==="all") res.matches++;
          }
          else {
            const item={appId:id,amount1:a1,amount2:a2,variance:varc,absVariance:absVar,
                        status1:r1[m.status.source1],status2:r2[m.status.source2],
                        date1:r1[m.date.source1],date2:r2[m.date.source2],isPaid:true};
            if(analysisType==="all" || analysisType==="mismatches") res.mismatches.push(item);
            if(absVar>thr*10) res.redAlerts.push(item);
            if(includeCommission && Math.abs(varc/a1)>0.05)
              res.commissionDeviations.push(item);
          }
        } else {
          if(analysisType==="all" || analysisType==="missing") {
            res.missing.push({appId:id,amount:parseFloat(r1[m.amount.source1])||0,
                            status:r1[m.status.source1],date:r1[m.date.source1],
                            source:'source1',isPaid:false});
          }
        }
      });
      d2.forEach(r2=>{
        const id=r2[m.appId.source2];
        if(id === undefined || id === null || id === "") return;
        const exists=d1.some(x=>x[m.appId.source1]==id);
        if(!exists && (analysisType==="all" || analysisType==="missing")) {
          res.missing.push({appId:id,amount:parseFloat(r2[m.amount.source2])||0,
                            status:r2[m.status.source2],date:r2[m.date.source2],
                            source:'source2',isPaid:true});
        }
      });
      res.mismatches.sort((a,b)=>b.absVariance-a.absVariance);
      res.totalPotentialLoss=res.redAlerts.reduce((s,i)=>s+i.absVariance,0);
      res.redAlertsTotal=res.totalPotentialLoss;
      res.commissionDeviationsTotal=res.commissionDeviations.reduce((s,i)=>s+i.absVariance,0);
      return res;
    }

    // DISPLAY
    function displayResults(r){
      let html=`<div class="results-header"><h2>Analysis Summary</h2></div>
        <div class="stats-grid">
          <div class="stat-card"><h3>Total Potential Loss</h3><div class="stat-value">‚Çπ${r.totalPotentialLoss.toFixed(2)}</div><div class="stat-subtext">(Red Alerts + Commission Deviations)</div></div>
          <div class="stat-card"><h3>Red Alerts</h3><div class="stat-value">${r.redAlerts.length}</div><div class="stat-subtext">‚Çπ${r.redAlertsTotal.toFixed(2)}</div></div>
          <div class="stat-card"><h3>Commission Deviations</h3><div class="stat-value">${r.commissionDeviations.length}</div><div class="stat-subtext">‚Çπ${r.commissionDeviationsTotal.toFixed(2)}</div></div>
          <div class="stat-card"><h3>Total Records</h3>
            <div class="stat-value">${r.matches + r.mismatches.length + r.missing.length}</div>
            <div class="stat-subtext">${r.matches} matches, ${r.mismatches.length} mismatches, ${r.missing.length} missing</div>
          </div>
        </div>
        <div class="table-section"><h3>Top Mismatches</h3><div class="table-container">
        <table><thead><tr><th>App ID</th><th>S1 Amt</th><th>S2 Amt (Paid)</th><th>Var</th><th>Status</th><th>Date</th></tr></thead><tbody>
        ${r.mismatches.slice(0,10).map(i=>`
          <tr>
            <td>${i.appId}</td>
            <td class="amount-cell">‚Çπ${i.amount1.toFixed(2)}</td>
            <td class="amount-cell paid">‚Çπ${i.amount2.toFixed(2)}</td>
            <td class="variance-cell ${i.variance>0?'positive-variance':'negative-variance'}">‚Çπ${i.variance.toFixed(2)}</td>
            <td>${i.status1}‚Üí${i.status2}</td><td>${i.date1}</td>
          </tr>
        `).join('')}
        </tbody></table></div></div>`;
      if(r.missing.length){
        html+=`<div class="table-section"><h3>Missing Records</h3><div class="table-container">
        <table><thead><tr><th>App ID</th><th>Amt</th><th>Status</th><th>Date</th><th>Missing From</th></tr></thead><tbody>
          ${r.missing.map(i=>`
            <tr>
              <td>${i.appId}</td>
              <td class="amount-cell ${i.isPaid?'paid':''}">‚Çπ${i.amount.toFixed(2)}</td>
              <td>${i.status||'N/A'}</td><td>${i.date||'N/A'}</td>
              <td>${i.source==='source1'?'Source 2':'Source 1'}</td>
            </tr>
          `).join('')}
        </tbody></table></div></div>`;
      }
      DOM.results.innerHTML=html;
      DOM.results.classList.add('show');
    }

    // EVENTS
    DOM.analyzeBtn.onclick = ()=>{
      showLoading();
      setTimeout(()=>{
        try{
          const res=analyzeData();
          displayResults(res);
        }catch(e){ showError(e.message); }
        hideLoading();
      },100);
    };

    // INIT
    document.addEventListener('DOMContentLoaded',()=>{
      initFileHandlers();
      updateUserInfo();
      setInterval(updateUserInfo,15000);
      // Sync options state
      DOM.analysisType.onchange = DOM.includeCommission.onchange = DOM.applyGST.onchange = DOM.varianceThreshold.oninput = function() {
        STATE.analysisOptions.type = DOM.analysisType.value;
        STATE.analysisOptions.includeCommission = DOM.includeCommission.checked;
        STATE.analysisOptions.applyGST = DOM.applyGST.checked;
        STATE.analysisOptions.varianceThreshold = parseFloat(DOM.varianceThreshold.value)||0.01;
      };
    });
  </script>
</body>
</html>
