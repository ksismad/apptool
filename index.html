<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Reconciliation Tool (ksismad)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #4C51BF; --primary-dark: #434190;
            --secondary-color: #38A169; --secondary-dark: #2F855A;
            --light-gray: #f7fafc; --medium-gray: #e2e8f0;
            --dark-gray: #2d3748; --text-color: #4a5568;
            --white: #fff; --danger-color: #c53030; --warning-color: #dd6b20;
        }
        html, body { 
            background: #f3f4f6; color: var(--text-color); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0; padding: 0; line-height: 1.6;
        }
        .container { 
            max-width: 1300px; margin: 30px auto; background: var(--white); 
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #5A67D8 0%, #7F5AD5 100%); 
            color: var(--white); padding: 30px 40px; position: relative;
        }
        .header h1 { margin: 0; font-size: 2.5rem; font-weight: 700; }
        .user-info {
            position: absolute; top: 20px; right: 30px; background: rgba(255,255,255,0.2);
            padding: 8px 16px; border-radius: 99px; font-size: 0.9rem; font-weight: 500;
        }
        .main-content { padding: 30px 40px; }
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .upload-box {
            background: var(--light-gray); border: 2px dashed var(--medium-gray);
            border-radius: 12px; padding: 25px; transition: all 0.2s ease;
        }
        .upload-box:hover { border-color: #c3dafe; background: #f1f5f9; }
        .upload-box h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.25rem; color: var(--dark-gray); }
        .file-input { display: none; }
        .upload-btn {
            background: var(--primary-color); color: var(--white); border: none; 
            padding: 10px 20px; border-radius: 8px; cursor: pointer; 
            font-weight: 600; transition: background 0.2s ease;
        }
        .upload-btn:hover { background: var(--primary-dark); }
        .file-info {
            margin-top: 15px; padding: 10px; background: #e6fffa; color: #2c7a7b; 
            border-radius: 6px; font-weight: 500; display: none; word-break: break-all;
        }
        .file-info.show { display: block; }
        .options-section, .column-mapping {
            background: var(--light-gray); border-radius: 12px;
            padding: 25px; margin-bottom: 30px;
        }
        .options-section h3, .column-mapping h3 { margin-top: 0; margin-bottom: 20px; color: var(--dark-gray); }
        .options-grid, .mapping-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
        }
        .mapping-box h4 { margin: 0 0 10px 0; font-size: 1.1rem; color: var(--dark-gray); }
        .mapping-row { display: flex; align-items: center; margin-bottom: 12px; }
        .mapping-label { flex: 1; font-weight: 600; padding-right: 10px;}
        .mapping-select {
            flex: 2; padding: 8px; border: 1px solid #cbd5e1;
            border-radius: 6px; background: var(--white);
        }
        .analyze-btn {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--secondary-dark) 100%);
            color: var(--white); border: none; border-radius: 12px; font-size: 1.25rem; 
            font-weight: 700; cursor: pointer; transition: all 0.2s ease;
        }
        .analyze-btn:hover { box-shadow: 0 4px 15px rgba(47, 133, 90, 0.4); }
        .analyze-btn:disabled { background: #a0aec0; cursor: not-allowed; box-shadow: none; }
        .results { margin-top: 30px; display: none; }
        .results.show { display: block; }
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .result-box {
            background: var(--white);
            border: 1px solid var(--medium-gray);
            border-radius: 12px;
            overflow: hidden;
        }
        .result-header {
            padding: 15px 20px;
            background: var(--light-gray);
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-header h3 { margin: 0; color: var(--dark-gray); }
        .view-full-btn {
            background: none; border: 1px solid #cbd5e1; color: var(--text-color);
            padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
        }
        .view-full-btn:hover { background: #edf2f7; }
        .table-container { overflow-x: auto; max-height: 400px; }
        .results-table { width: 100%; border-collapse: collapse; }
        .results-table th, .results-table td {
            padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--medium-gray);
            white-space: nowrap;
        }
        .results-table th { background: var(--light-gray); font-weight: 600; position: sticky; top: 0; }
        .results-table th.sortable { cursor: pointer; }
        .results-table th.sortable:hover { background: #edf2f7; }
        .status-match { color: var(--secondary-dark); font-weight: 600; }
        .status-mismatch { color: var(--danger-color); font-weight: 600; }
        .status-missing-in-source-2, .status-missing-in-source-1 { color: var(--warning-color); font-weight: 600; }
        .summary-box {
            padding: 20px; background: var(--light-gray); border-radius: 12px;
            margin-bottom: 30px; text-align: center;
        }
        .summary-box h3 { margin: 0 0 10px 0; }
        .summary-box .total { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); }
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.85); display: flex; align-items: center;
            justify-content: center; z-index: 9999; display: none;
        }
        .loading-overlay.show { display: flex; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info" id="user-info"></div>
            <h1>Professional Reconciliation Tool</h1>
            <p>Intelligently compare, analyze, and export financial data with ease.</p>
        </div>
        
        <div class="main-content">
            <div class="upload-section">
                <div class="upload-box">
                    <h3>Source 1 (Master Data)</h3>
                    <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls,.csv">
                    <button class="upload-btn" onclick="document.getElementById('file-input-1').click()">Choose Master File(s)</button>
                    <div id="file-info-1" class="file-info"></div>
                </div>
                <div class="upload-box">
                    <h3>Source 2 (Comparison Data)</h3>
                    <input type="file" id="file-input-2" class="file-input" accept=".xlsx,.xls,.csv">
                    <button class="upload-btn" onclick="document.getElementById('file-input-2').click()">Choose Comparison File</button>
                    <div id="file-info-2" class="file-info"></div>
                </div>
            </div>

            <div id="column-mapping-section" class="column-mapping" style="display: none;">
                <h3>Column Mapping</h3>
                <p>Please verify the automatically detected columns. Fields marked with * are required for analysis.</p>
                <div class="mapping-grid">
                    <div id="source1-mappings"></div>
                    <div id="source2-mappings"></div>
                </div>
            </div>

            <div class="options-section">
                <h3>Filters & Options</h3>
                <div class="options-grid">
                    <div>
                        <label for="date1-from" class="mapping-label">Source 1 Date Range</label>
                        <input type="date" id="date1-from"> to <input type="date" id="date1-to">
                    </div>
                    <div>
                        <label for="date2-from" class="mapping-label">Source 2 Date Range</label>
                        <input type="date" id="date2-from"> to <input type="date" id="date2-to">
                    </div>
                    <div>
                        <label for="status-filter" class="mapping-label">Filter Source 1 by Status</label>
                        <select id="status-filter" class="mapping-select">
                            <option value="all">All Records</option>
                            <option value="paid">Paid</option>
                            <option value="unpaid">Unpaid</option>
                        </select>
                    </div>
                     <div>
                        <label for="apply-gst" class="mapping-label">Apply 18% GST to Source 1</label>
                        <input type="checkbox" id="apply-gst">
                    </div>
                    <div>
                        <label for="round-off" class="mapping-label">Round Off Source 1 Amount</label>
                        <input type="checkbox" id="round-off">
                    </div>
                </div>
            </div>
            
            <button id="analyze-btn" class="analyze-btn" disabled>Upload files to begin</button>
            
            <div id="results" class="results">
                <h2>Analysis Results</h2>
                <div id="summary-box" class="summary-box" style="display:none;"></div>
                <div class="results-grid">
                    <div id="matches-box" class="result-box"></div>
                    <div id="mismatches-box" class="result-box"></div>
                    <div id="missing1-box" class="result-box"></div>
                    <div id="missing2-box" class="result-box"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loading-overlay" class="loading-overlay"><div class="spinner"></div></div>
    
    <script>
        const STATE = {
            source1: { files: new Map(), data: [], headers: [], mappings: {} },
            source2: { file: null, data: [], headers: [], mappings: {} },
            analysisResults: null
        };

        const COLUMN_CONFIG = {
            appId: { label: 'Application ID', patterns: [/app.*id/i, /application.*id/i, /id/i], required: true },
            amount: { label: 'Amount', patterns: [/amount/i, /total/i, /value/i, /fee/i], required: true },
            date: { label: 'Date', patterns: [/date/i, /timestamp/i, /created/i], required: false },
            status: { label: 'Status', patterns: [/status/i, /state/i], required: false },
            commission: { label: 'Commission', patterns: [/commission/i, /comm/i], required: false }
        };
        const DOM = {
            analyzeBtn: document.getElementById('analyze-btn'),
            userInfo: document.getElementById('user-info'),
            columnMappingSection: document.getElementById('column-mapping-section'),
            resultsSection: document.getElementById('results'),
            loadingOverlay: document.getElementById('loading-overlay')
        };

        function generateFileSignature(data) {
            // Create a signature from the first 5 App IDs to detect duplicates
            const { appId } = detectColumnMappings(data[0]);
            if (appId === undefined) return data[0].join(','); // Fallback for no App ID
            return data.slice(1, 6).map(row => row[appId]).join(',');
        }

        async function handleFileSelection(files, sourceNum) {
            if (!files.length) return;
            showLoading();
            
            const sourceKey = `source${sourceNum}`;
            const stateObj = STATE[sourceKey];

            try {
                let allData = [];
                let headers = [];
                
                if (sourceNum === 1) {
                    headers = stateObj.headers.length ? stateObj.headers : (await processFile(files[0]))[0];
                    stateObj.headers = headers;
                } else {
                    stateObj.files.clear();
                    const fileData = await processFile(files[0]);
                    headers = fileData[0] || [];
                    allData = fileData.slice(1);
                    stateObj.headers = headers;
                }

                for (const file of files) {
                    const fileData = await processFile(file);
                    const signature = generateFileSignature(fileData);
                    if (stateObj.files.has(signature)) {
                        alert(`Skipping duplicate file: ${file.name}`);
                        continue;
                    }
                    stateObj.files.set(signature, file.name);
                    const records = fileData.slice(1).map(row => ({ __filename: file.name, data: row }));
                    if (sourceNum === 1) {
                        allData.push(...records);
                    } else {
                        allData = records; // Source 2 only has one file
                    }
                }
                
                stateObj.data = allData;
                stateObj.mappings = detectColumnMappings(stateObj.headers);
                updateFileInfo(sourceNum);
                createColumnMappingUI(sourceNum);
            } catch (err) {
                alert(`Error: ${err.message}`);
            } finally {
                if (STATE.source1.files.size > 0 && STATE.source2.files.size > 0) {
                    DOM.columnMappingSection.style.display = 'block';
                }
                hideLoading();
                updateAnalyzeButton();
            }
        }
        
        function runAnalysis() {
            showLoading();
            setTimeout(() => {
                try {
                    const { appId: s1AppIdCol, amount: s1AmountCol, commission: s1CommissionCol } = STATE.source1.mappings;
                    const { appId: s2AppIdCol, amount: s2AmountCol } = STATE.source2.mappings;
                    const applyGst = document.getElementById('apply-gst').checked;
                    const roundOff = document.getElementById('round-off').checked;

                    const s1Filtered = getFilteredData(1);
                    const s2Filtered = getFilteredData(2);
                    
                    const s1Map = new Map();
                    let totalCommission = 0;
                    s1Filtered.forEach(item => {
                        const appId = item.data[s1AppIdCol];
                        if (appId) s1Map.set(appId.toString(), item);
                        if (s1CommissionCol !== undefined) totalCommission += parseFloat(item.data[s1CommissionCol]) || 0;
                    });

                    const results = { matches: [], mismatches: [], missingInSource2: [], missingInSource1: [] };

                    s2Filtered.forEach(s2item => {
                        const s2row = s2item.data;
                        const s2AppId = s2row[s2AppIdCol]?.toString();
                        const s1item = s1Map.get(s2AppId);
                        
                        let s1Amount = 0, commission = 0;
                        let s2Amount = parseFloat(s2row[s2AmountCol]) || 0;
                        let status = '', s1row = null, filename1 = '', date1 = null, date2 = null;

                        if (s1item) {
                            s1row = s1item.data;
                            filename1 = s1item.__filename;
                            date1 = s1row[STATE.source1.mappings.date];
                            date2 = s2row[STATE.source2.mappings.date];
                            s1Amount = parseFloat(s1row[s1AmountCol]) || 0;
                            if (applyGst) s1Amount *= 1.18;
                            if (roundOff) s1Amount = Math.round(s1Amount);
                            
                            commission = (s1CommissionCol !== undefined) ? (parseFloat(s1row[s1CommissionCol]) || 0) : 0;
                            status = Math.abs(s1Amount - s2Amount) < 0.01 ? 'Match' : 'Mismatch';
                            results[status.toLowerCase() + 'es'].push({ appId: s2AppId, amount1: s1Amount, amount2: s2Amount, commission, status, filename1, date1, date2 });
                            s1Map.delete(s2AppId);
                        } else {
                            status = 'Missing in Source 1';
                            date2 = s2row[STATE.source2.mappings.date];
                            results.missingInSource1.push({ appId: s2AppId, amount1: 0, amount2: s2Amount, commission: 0, status, filename1: 'N/A', date1: null, date2 });
                        }
                    });

                    s1Map.forEach(s1item => {
                        const s1row = s1item.data;
                        let amount1 = parseFloat(s1row[s1AmountCol]) || 0;
                        if (applyGst) amount1 *= 1.18;
                        if (roundOff) amount1 = Math.round(amount1);
                        const commission = (s1CommissionCol !== undefined) ? (parseFloat(s1row[s1CommissionCol]) || 0) : 0;
                        results.missingInSource2.push({ appId: s1row[s1AppIdCol], amount1, amount2: 0, commission, status: 'Missing in Source 2', filename1: s1item.__filename, date1: s1row[STATE.source1.mappings.date], date2: null });
                    });
                    
                    STATE.analysisResults = results;
                    STATE.analysisResults.totalCommission = totalCommission;
                    displayResults(STATE.analysisResults);
                } catch (error) {
                    alert('An error occurred during analysis: ' + error.message);
                } finally {
                    hideLoading();
                }
            }, 50);
        }

        function displayResults(results) {
            document.getElementById('summary-box').innerHTML = `<h3>Total Commission (Source 1)</h3><div class="total">${results.totalCommission.toFixed(2)}</div>`;
            document.getElementById('summary-box').style.display = 'block';

            buildResultTable('matches', 'Matches', ['App ID', 'Amount', 'Date', 'Filename'], results.matches);
            buildResultTable('mismatches', 'Mismatches', ['App ID', 'S1 Amount', 'S2 Amount', 'Diff', 'Commission', 'S1 Date', 'S2 Date', 'Filename'], results.mismatches);
            buildResultTable('missing2', 'Missing in Source 2', ['App ID', 'Amount', 'Commission', 'Date', 'Filename'], results.missingInSource2);
            buildResultTable('missing1', 'Missing in Source 1', ['App ID', 'Amount', 'Date'], results.missingInSource1);
            
            DOM.resultsSection.classList.add('show');
        }

        function buildResultTable(id, title, headers, data) {
            const container = document.getElementById(`${id}-box`);
            let tableHTML = `<div class="result-header"><h3>${title} (${data.length})</h3><button class="view-full-btn">View Full</button></div>
                             <div class="table-container"><table class="results-table"><thead><tr>`;
            headers.forEach(h => tableHTML += `<th class="sortable">${h}</th>`);
            tableHTML += `</tr></thead><tbody>`;

            data.forEach(item => {
                tableHTML += '<tr>';
                if (id === 'matches') tableHTML += `<td>${item.appId}</td><td>${item.amount1.toFixed(2)}</td><td>${formatDate(item.date1)}</td><td>${item.filename1}</td>`;
                else if (id === 'mismatches') tableHTML += `<td>${item.appId}</td><td>${item.amount1.toFixed(2)}</td><td>${item.amount2.toFixed(2)}</td><td>${(item.amount1 - item.amount2).toFixed(2)}</td><td>${item.commission.toFixed(2)}</td><td>${formatDate(item.date1)}</td><td>${formatDate(item.date2)}</td><td>${item.filename1}</td>`;
                else if (id === 'missing2') tableHTML += `<td>${item.appId}</td><td>${item.amount1.toFixed(2)}</td><td>${item.commission.toFixed(2)}</td><td>${formatDate(item.date1)}</td><td>${item.filename1}</td>`;
                else if (id === 'missing1') tableHTML += `<td>${item.appId}</td><td>${item.amount2.toFixed(2)}</td><td>${formatDate(item.date2)}</td>`;
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;

            const table = container.querySelector('table');
            makeTableSortable(table, data);
            container.querySelector('.view-full-btn').addEventListener('click', () => openFullView(title, table.innerHTML));
        }

        function makeTableSortable(table, data) {
            const headers = Array.from(table.querySelectorAll('th'));
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const isAsc = !header.classList.contains('asc');
                    headers.forEach(h => h.classList.remove('asc', 'desc'));
                    header.classList.toggle(isAsc ? 'asc' : 'desc');
                    
                    const keyMap = {
                        'App ID': 'appId', 'Amount': 'amount1', 'S1 Amount': 'amount1', 'S2 Amount': 'amount2',
                        'Diff': item => item.amount1 - item.amount2, 'Commission': 'commission',
                        'Date': 'date1', 'S1 Date': 'date1', 'S2 Date': 'date2', 'Filename': 'filename1'
                    };
                    const key = keyMap[header.innerText];

                    data.sort((a, b) => {
                        const valA = typeof key === 'function' ? key(a) : a[key];
                        const valB = typeof key === 'function' ? key(b) : b[key];
                        if (valA === null || valA === undefined) return 1;
                        if (valB === null || valB === undefined) return -1;
                        return valA > valB ? (isAsc ? 1 : -1) : (isAsc ? -1 : 1);
                    });
                    
                    const parentId = table.closest('.result-box').id.replace('-box', '');
                    buildResultTable(parentId, table.closest('.result-box').querySelector('h3').innerText.split('(')[0].trim(), headers.map(h => h.innerText), data);
                });
            });
        }
        
        function openFullView(title, tableHTML) {
            const newWindow = window.open("");
            newWindow.document.write(`<html><head><title>${title}</title><style>body{font-family:sans-serif} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ccc;padding:8px} th{background:#f0f0f0}</style></head><body><h1>${title}</h1>${tableHTML}</body></html>`);
            newWindow.document.close();
        }

        function getFilteredData(sourceNum) {
            const { data, mappings } = STATE[`source${sourceNum}`];
            const dateFrom = document.getElementById(`date${sourceNum}-from`).valueAsDate;
            const dateTo = document.getElementById(`date${sourceNum}-to`).valueAsDate;
            const dateCol = mappings.date;

            let filteredData = data;
            if ((dateFrom || dateTo) && dateCol !== undefined) {
                filteredData = filteredData.filter(item => {
                    const dateVal = item.data[dateCol];
                    if (!(dateVal instanceof Date)) return true;
                    const fromOK = !dateFrom || dateVal >= dateFrom;
                    const toOK = !dateTo || dateVal <= new Date(dateTo.getTime() + 86400000);
                    return fromOK && toOK;
                });
            }
            if (sourceNum === 1) {
                const statusFilter = document.getElementById('status-filter').value;
                const statusCol = mappings.status;
                if (statusFilter !== 'all' && statusCol !== undefined) {
                    filteredData = filteredData.filter(item => (item.data[statusCol]?.toString().toLowerCase() || '') === statusFilter);
                }
            }
            return filteredData;
        }

        function updateFileInfo(sourceNum) {
            const filesMap = STATE[`source${sourceNum}`].files;
            document.getElementById(`file-info-${sourceNum}`).innerHTML = `<b>${filesMap.size} file(s)</b> selected, <b>${STATE[`source${sourceNum}`].data.length} records</b> found.`;
            document.getElementById(`file-info-${sourceNum}`).classList.add('show');
        }

        function createColumnMappingUI(sourceNum) {
            const sourceKey = `source${sourceNum}`;
            const { headers, mappings } = STATE[sourceKey];
            const container = document.getElementById(`${sourceKey}-mappings`);
            let html = `<h4>Source ${sourceNum}</h4>`;
            for (const [key, config] of Object.entries(COLUMN_CONFIG)) {
                const options = headers.map((h, i) => `<option value="${i}" ${mappings[key] === i ? 'selected' : ''}>${h || `Column ${i+1}`}</option>`).join('');
                html += `<div class="mapping-row"><label class="mapping-label">${config.label}${config.required ? ' *' : ''}</label><select class="mapping-select" data-source="${sourceNum}" data-key="${key}"><option value="">-- Select --</option>${options}</select></div>`;
            }
            container.innerHTML = html;
            container.querySelectorAll('select').forEach(sel => sel.addEventListener('change', e => {
                const val = e.target.value;
                STATE[`source${e.target.dataset.source}`].mappings[e.target.dataset.key] = val ? parseInt(val, 10) : undefined;
                updateAnalyzeButton();
            }));
        }
        
        function updateAnalyzeButton() {
            const s1Ready = STATE.source1.files.size > 0;
            const s2Ready = STATE.source2.files.size > 0;
            let mappingsReady = false;
            if (s1Ready && s2Ready) {
                const s1Mappings = STATE.source1.mappings;
                const s2Mappings = STATE.source2.mappings;
                mappingsReady = Object.entries(COLUMN_CONFIG).every(([key, config]) => 
                    !config.required || (s1Mappings[key] !== undefined && s2Mappings[key] !== undefined)
                );
            }
            DOM.analyzeBtn.disabled = !mappingsReady;
            if (mappingsReady) DOM.analyzeBtn.textContent = 'Run Analysis';
            else if (!s1Ready || !s2Ready) DOM.analyzeBtn.textContent = 'Upload files to begin';
            else DOM.analyzeBtn.textContent = 'Please map required columns (*)';
        }

        function formatDate(date) {
            if (!(date instanceof Date)) return 'N/A';
            return date.toISOString().split('T')[0];
        }
        
        function showLoading() { DOM.loadingOverlay.classList.add('show'); }
        function hideLoading() { DOM.loadingOverlay.classList.remove('show'); }

        function initialize() {
            DOM.userInfo.textContent = `User: ksismad | UTC 2025-06-19 19:04:01`;
            document.getElementById('file-input-1').addEventListener('change', e => handleFileSelection(e.target.files, 1));
            document.getElementById('file-input-2').addEventListener('change', e => handleFileSelection(e.target.files, 2));
            DOM.analyzeBtn.addEventListener('click', runAnalysis);
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
