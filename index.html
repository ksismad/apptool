<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App ID Analyzer - Complete Analysis System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f3f4f6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            text-align: center;
            padding: 32px 24px;
            position: relative;
        }
        .header h1 { margin: 0 0 12px 0; font-size: 2.25rem; }
        .header p { margin: 0; opacity: 0.9; font-size: 1rem; line-height: 1.6; }
        .user-info { position: absolute; top: 20px; right: 24px; background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 0.875rem; backdrop-filter: blur(10px); }
        .main-content { padding: 32px; }
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }
        .upload-box { background: #f8fafc; border-radius: 12px; padding: 24px; text-align: center; border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        .upload-box:hover { border-color: #6366f1; transform: translateY(-2px); }
        .upload-box.has-files { border-color: #10b981; background: #ecfdf5; }
        .upload-btn { margin-top: 16px; border: none; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; border-radius: 8px; padding: 12px 24px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        .upload-btn:hover { transform: translateY(-1px); }
        .file-info { margin-top: 12px; color: #059669; font-weight: 600; padding: 8px 16px; background: #d1fae5; border-radius: 6px; display: inline-block; }
        .file-input { display: none; }
        .section { background: #f8fafc; border-radius: 12px; padding: 24px; margin-bottom: 32px; border: 1px solid #e2e8f0; }
        .section-title { font-size: 1.125rem; font-weight: 600; color: #1e293b; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px; }
        .date-filter-grid, .options-grid { display: grid; gap: 24px; }
        .date-filter-grid { grid-template-columns: 1fr 1fr; }
        .options-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .option-group, .date-filter-group { background: #fff; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .option-label, .date-filter-label { font-weight: 600; color: #374151; margin-bottom: 8px; display: block; }
        .date-range { display: flex; align-items: center; gap: 12px; }
        .date-input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.925rem; flex: 1; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .input-group { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .col-select, .commission-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.925rem; background: #fff; }
        .commission-input { max-width: 150px; }
        .validation-title { font-weight: 600; color: #374151; margin-bottom: 12px; }
        .validation-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 0.875rem; }
        .validation-item.valid { color: #059669; }
        .validation-item.invalid { color: #dc2626; }
        .validation-item.valid::before { content: "‚úÖ"; }
        .validation-item.invalid::before { content: "‚ùå"; }
        .analyze-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 12px; font-size: 1.125rem; font-weight: 700; cursor: pointer; transition: transform 0.2s; }
        .analyze-btn:hover:not(:disabled) { transform: translateY(-2px); }
        .analyze-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .results { margin-top: 32px; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding: 16px; background: #f8fafc; border-radius: 8px; }
        .results-title { font-size: 1.5rem; font-weight: 700; color: #1e293b; margin: 0; }
        .results-meta { font-size: 0.875rem; color: #6b7280; text-align: right; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); text-align: center; border-left: 4px solid #6366f1; }
        .stat-card.success { border-left-color: #10b981; }
        .stat-card.warning { border-left-color: #f59e0b; }
        .stat-card.danger { border-left-color: #ef4444; }
        .stat-card.commission { border-left-color: #8b5cf6; }
        .stat-number { font-size: 1.875rem; font-weight: 700; color: #1e293b; margin-bottom: 4px; }
        .stat-label { font-size: 0.875rem; color: #64748b; font-weight: 500; text-transform: uppercase; }
        .stat-meta { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }
        .table-container { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 24px; }
        .table-header { background: #f8fafc; padding: 16px 24px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .table-title { font-size: 1.125rem; font-weight: 600; color: #1e293b; }
        .table-wrapper { overflow-x: auto; max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.875rem; white-space: nowrap; }
        th { background: #f8fafc; font-weight: 600; color: #374151; position: sticky; top: 0; cursor: pointer; user-select: none; }
        th:hover { background: #e2e8f0; }
        th .sort-arrow { display: inline-block; margin-left: 5px; opacity: 0.5; }
        th.sorted .sort-arrow { opacity: 1; }
        tr:hover { background: #f8fafc; }
        .highlight-mismatch { background: #fef2f2; }
        .highlight-missing { background: #fef3c7; }
        .highlight-match { background: #f0fdf4; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-badge.match { background: #d1fae5; color: #065f46; }
        .status-badge.amount-mismatch { background: #fee2e2; color: #991b1b; }
        .status-badge.missing { background: #fef3c7; color: #92400e; }
        .export-section { display: flex; gap: 16px; justify-content: center; margin-top: 32px; flex-wrap: wrap; }
        .export-btn, .view-btn { padding: 12px 24px; background: #1e293b; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .export-btn:hover, .view-btn:hover { background: #334155; transform: translateY(-1px); }
        .view-btn { background: #4f46e5; }
        .error-msg, .success-msg { padding: 12px 16px; border-radius: 8px; margin: 16px 0; border-left-width: 4px; border-left-style: solid; }
        .error-msg { color: #dc2626; background: #fef2f2; border-color: #dc2626; }
        .success-msg { color: #059669; background: #ecfdf5; border-color: #059669; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .processing { text-align: center; padding: 20px; color: #6366f1; font-weight: 600; }
        .hidden { display: none !important; }
        @media (max-width: 768px) {
            .upload-section, .date-filter-grid, .options-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info" id="user-info"></div>
            <h1>üîç App ID Analyzer</h1>
            <p>Advanced multi-file Excel analysis with commission calculation and comprehensive reporting.</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <div class="upload-box" id="upload-box-1">
                    <h3>üìÅ Source 1 Files</h3>
                    <p>Select one or more Excel files</p>
                    <input type="file" id="file-input-1" class="file-input" multiple accept=".xlsx,.xls">
                    <button class="upload-btn" id="upload-btn-1">Choose Source 1 Files</button>
                    <div id="file-info-1" class="file-info hidden"></div>
                </div>
                <div class="upload-box" id="upload-box-2">
                    <h3>üìÅ Source 2 Files</h3>
                    <p>Select one or more Excel files</p>
                    <input type="file" id="file-input-2" class="file-input" multiple accept=".xlsx,.xls">
                    <button class="upload-btn" id="upload-btn-2">Choose Source 2 Files</button>
                    <div id="file-info-2" class="file-info hidden"></div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">üìÖ Date Range Filters (UTC-based)</h3>
                <div class="date-filter-grid">
                    <div class="date-filter-group">
                        <label class="date-filter-label">Source 1 Range</label>
                        <div class="date-range">
                            <input type="date" class="date-input" id="dateFrom1">
                            <span>to</span>
                            <input type="date" class="date-input" id="dateTo1">
                        </div>
                    </div>
                    <div class="date-filter-group">
                        <label class="date-filter-label">Source 2 Range</label>
                        <div class="date-range">
                            <input type="date" class="date-input" id="dateFrom2">
                            <span>to</span>
                            <input type="date" class="date-input" id="dateTo2">
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">‚öôÔ∏è Analysis & Commission Options</h3>
                <div class="options-grid">
                    <div class="option-group">
                        <label class="option-label">Payment Filter</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="includeUnpaid1">
                            <label for="includeUnpaid1">Include unpaid from Source 1</label>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">GST Calculation (18%)</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="applyGST">
                            <label for="applyGST">Apply 18% GST to Source 1</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="gstRound">
                            <label for="gstRound">Round GST amounts</label>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Commission Rate (%)</label>
                        <div class="input-group">
                            <input type="number" id="commissionRate" class="commission-input" placeholder="e.g., 5" min="0" max="100" step="0.01">
                            <label>% on paid amounts</label>
                        </div>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Manual Commission Calculator</label>
                        <div class="input-group">
                            <input type="number" id="manualCommissionRate" class="commission-input" placeholder="e.g., 2.5" min="0" max="100" step="0.01">
                            <label>% on taxable value</label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="source1-dynamic"></div>
            <div id="source2-dynamic"></div>

            <div id="validation-status" class="section">
                <h3 class="section-title">üìã Validation Status</h3>
                <div id="validation-items"></div>
            </div>

            <button id="analyze-btn" class="analyze-btn" disabled>Please complete setup</button>

            <div id="error-container"></div>
            <div id="results" class="results hidden"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // === GLOBAL STATE ===
        let source1Files = [];
        let source2Files = [];
        let analysisResults = null;

        // === DOM ELEMENTS ===
        const fileInput1 = document.getElementById('file-input-1');
        const fileInput2 = document.getElementById('file-input-2');
        const analyzeBtn = document.getElementById('analyze-btn');
        const resultsContainer = document.getElementById('results');

        // === UTILITY FUNCTIONS ===
        function safeNumber(val, defaultVal = 0) {
            const num = parseFloat(val);
            return isNaN(num) || !isFinite(num) ? defaultVal : num;
        }

        function safeString(val, defaultVal = '') {
            return (val === null || val === undefined) ? defaultVal : String(val);
        }

        function calculateTaxableValue(amount, hasGST = false) {
            // If amount includes GST, remove it to get taxable value
            return hasGST ? amount / 1.18 : amount;
        }

        // === CORE DATE UTILITIES ===
        const DATE_UTILS = {
            excelSerialToDate(serial) {
                if (typeof serial !== 'number' || !isFinite(serial)) return null;
                return new Date((serial - 25569) * 86400000);
            },
            parseToDate(val) {
                if (!val && val !== 0) return null;
                if (typeof val === 'number') {
                    return val > 60 ? this.excelSerialToDate(val) : null;
                }
                if (typeof val === 'string') {
                    const str = val.trim();
                    if (!str) return null;
                    const d = new Date(str);
                    if (!isNaN(d.valueOf())) return d;
                }
                return null;
            },
            formatDisplay(d) {
                if (!d || isNaN(d.valueOf())) return "";
                const date = new Date(d);
                return `${String(date.getUTCDate()).padStart(2,'0')}-${String(date.getUTCMonth()+1).padStart(2,'0')}-${date.getUTCFullYear()}`;
            },
            parseDateInput: v => v ? new Date(v) : null,
            getEndOfDay(d) {
                if (!d) return null;
                const eod = new Date(d);
                eod.setUTCHours(23, 59, 59, 999);
                return eod;
            }
        };

        // === VALIDATION & UI UPDATE LOGIC ===
        const ValidationState = {
            update() {
                const hasSrc1 = source1Files.length > 0;
                const hasSrc2 = source2Files.length > 0;
                const src1ColsOk = hasSrc1 && source1Files.every(f => f.cols.appId !== null && f.cols.amount !== null);
                const src2ColsOk = hasSrc2 && source2Files.every(f => f.cols.appId !== null && f.cols.amount !== null);
                
                document.getElementById('validation-items').innerHTML = [
                    { text: `Source 1 files selected (${source1Files.length})`, valid: hasSrc1 },
                    { text: `Source 2 files selected (${source2Files.length})`, valid: hasSrc2 },
                    { text: 'Source 1 columns configured', valid: src1ColsOk },
                    { text: 'Source 2 columns configured', valid: src2ColsOk }
                ].map(item => `<div class="validation-item ${item.valid ? 'valid' : 'invalid'}">${item.text}</div>`).join('');
                
                const canAnalyze = hasSrc1 && hasSrc2 && src1ColsOk && src2ColsOk;
                analyzeBtn.disabled = !canAnalyze;
                analyzeBtn.textContent = canAnalyze ? 'üîç Analyze Data' : 'üìã Please complete setup';
            }
        };

        // === FILE PROCESSING & ANALYSIS ===
        function autoDetectColumns(headers, sample) {
            const cols = { appId: null, amount: null, date: null, paid: null, commission: null };
            const lcHeaders = headers.map(h => String(h || '').toLowerCase());
            
            const appIdIdx = lcHeaders.findIndex(h => h.includes('app') && h.includes('id'));
            const amountIdx = lcHeaders.findIndex(h => h.includes('amount') || h.includes('total'));
            const paidIdx = lcHeaders.findIndex(h => h.includes('paid') || h.includes('status'));
            const commissionIdx = lcHeaders.findIndex(h => h.includes('commission') || h.includes('comm'));
            
            cols.appId = appIdIdx !== -1 ? appIdIdx : null;
            cols.amount = amountIdx !== -1 ? amountIdx : null;
            cols.paid = paidIdx !== -1 ? paidIdx : null;
            cols.commission = commissionIdx !== -1 ? commissionIdx : null;
            
            // Find best date column
            const dateScores = Array(headers.length).fill(0);
            sample.slice(0, 15).forEach(row => {
                if (Array.isArray(row)) {
                    row.forEach((cell, i) => {
                        if (DATE_UTILS.parseToDate(cell)) dateScores[i]++;
                    });
                }
            });
            const bestDateIndex = dateScores.indexOf(Math.max(...dateScores));
            if (bestDateIndex > -1 && dateScores[bestDateIndex] > 0) {
                cols.date = bestDateIndex;
            }

            return cols;
        }

        function processFileData(data, cols, source = 1) {
            const processed = [];
            if (!Array.isArray(data) || data.length < 2) return processed;
            
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!Array.isArray(row) || !row[cols.appId]) continue;
                
                const appId = safeString(row[cols.appId]).trim();
                if (!appId) continue;
                
                processed.push({
                    rowNum: i + 1,
                    appId: appId,
                    amount: safeNumber(row[cols.amount]),
                    paid: cols.paid !== null ? safeString(row[cols.paid]) : null,
                    date: cols.date !== null ? DATE_UTILS.parseToDate(row[cols.date]) : null,
                    commission: cols.commission !== null ? safeNumber(row[cols.commission]) : 0,
                    source: source
                });
            }
            return processed;
        }

        function analyzeData() {
            resultsContainer.innerHTML = '<div class="loading">üîÑ Analyzing data...</div>';
            resultsContainer.classList.remove('hidden');
            
            setTimeout(() => {
                try {
                    const filters = {
                        from1: DATE_UTILS.parseDateInput(document.getElementById('dateFrom1').value),
                        to1: DATE_UTILS.getEndOfDay(DATE_UTILS.parseDateInput(document.getElementById('dateTo1').value)),
                        from2: DATE_UTILS.parseDateInput(document.getElementById('dateFrom2').value),
                        to2: DATE_UTILS.getEndOfDay(DATE_UTILS.parseDateInput(document.getElementById('dateTo2').value))
                    };
                    
                    const includeUnpaid = document.getElementById('includeUnpaid1').checked;
                    const applyGST = document.getElementById('applyGST').checked;
                    const roundGST = document.getElementById('gstRound').checked;
                    const commissionRate = safeNumber(document.getElementById('commissionRate').value);
                    const manualCommissionRate = safeNumber(document.getElementById('manualCommissionRate').value);

                    // Process source 1 files
                    let data1 = [];
                    source1Files.forEach((f, fileIndex) => {
                        const processed = processFileData(f.data, f.cols, 1);
                        processed.forEach(item => {
                            item.branding = f.branding;
                            item.fileName = f.file.name;
                        });
                        data1 = data1.concat(processed);
                    });
                    
                    // Process source 2 files
                    let data2 = [];
                    source2Files.forEach((f, fileIndex) => {
                        const processed = processFileData(f.data, f.cols, 2);
                        processed.forEach(item => {
                            item.branding = f.branding;
                            item.fileName = f.file.name;
                        });
                        data2 = data2.concat(processed);
                    });

                    // Apply date filters
                    let filtered1 = (filters.from1 || filters.to1) 
                        ? data1.filter(d => d.date && (!filters.from1 || d.date >= filters.from1) && (!filters.to1 || d.date <= filters.to1)) 
                        : data1;
                    let filtered2 = (filters.from2 || filters.to2) 
                        ? data2.filter(d => d.date && (!filters.from2 || d.date >= filters.from2) && (!filters.to2 || d.date <= filters.to2)) 
                        : data2;

                    // Apply payment filter
                    let final1 = includeUnpaid 
                        ? filtered1 
                        : filtered1.filter(d => String(d.paid || '').toLowerCase() === 'paid');
                    
                    // Apply GST
                    if (applyGST) {
                        final1.forEach(d => {
                            d.originalAmount = d.amount;
                            d.amount = roundGST ? Math.round(d.amount * 1.18) : d.amount * 1.18;
                        });
                    }
                    
                    analysisResults = performComparison(final1, filtered2, {
                        includeUnpaid, applyGST, roundGST, commissionRate, manualCommissionRate
                    });
                    renderResults(analysisResults);
                    showSuccess('Analysis completed successfully!');
                } catch (e) {
                    console.error('Analysis error:', e);
                    showError(`Analysis failed: ${e.message}`);
                    resultsContainer.classList.add('hidden');
                }
            }, 100);
        }

        function performComparison(d1, d2, options) {
            const map1 = _.groupBy(d1, 'appId');
            const map2 = _.groupBy(d2, 'appId');
            const allIds = _.union(Object.keys(map1), Object.keys(map2));
            const results = { 
                matching: [], 
                missing: [], 
                duplicates1: [], 
                duplicates2: [], 
                options, 
                sortState: {},
                commissionData: []
            };
            
            allIds.forEach(id => {
                const items1 = map1[id];
                const items2 = map2[id];
                
                if (items1 && items2) {
                    const amt1 = _.sumBy(items1, 'amount');
                    const amt2 = _.sumBy(items2, 'amount');
                    const diff = Math.abs(amt1 - amt2);
                    
                    results.matching.push({
                        appId: id,
                        amount1: safeNumber(amt1),
                        amount2: safeNumber(amt2),
                        difference: safeNumber(diff),
                        status: diff < 0.01 ? 'Match' : 'Amount Mismatch',
                        branding: items1[0]?.branding || '',
                        date1: items1.find(i => i.date)?.date,
                        date2: items2.find(i => i.date)?.date,
                        fileName1: items1[0]?.fileName || '',
                        fileName2: items2[0]?.fileName || ''
                    });
                } else {
                    const items = items1 || items2;
                    const amount = _.sumBy(items, 'amount');
                    
                    results.missing.push({
                        appId: id,
                        amount: safeNumber(amount),
                        missingFrom: items1 ? 'Source 2' : 'Source 1',
                        branding: items[0]?.branding || '',
                        date: items.find(i => i.date)?.date,
                        paid: items[0]?.paid,
                        fileName: items[0]?.fileName || ''
                    });
                }
            });

            // Find duplicates
            Object.keys(map1).forEach(id => {
                if (map1[id].length > 1) {
                    results.duplicates1.push({
                        appId: id,
                        count: map1[id].length,
                        source: 'Source 1',
                        totalAmount: _.sumBy(map1[id], 'amount')
                    });
                }
            });
            
            Object.keys(map2).forEach(id => {
                if (map2[id].length > 1) {
                    results.duplicates2.push({
                        appId: id,
                        count: map2[id].length,
                        source: 'Source 2',
                        totalAmount: _.sumBy(map2[id], 'amount')
                    });
                }
            });

            // Calculate commission data
            const paidItems1 = d1.filter(d => String(d.paid || '').toLowerCase() === 'paid');
            let totalCommissionFromColumn = 0;
            let totalCommissionCalculated = 0;
            let totalManualCommission = 0;

            paidItems1.forEach(item => {
                // Commission from column
                totalCommissionFromColumn += item.commission || 0;
                
                // Calculated commission on paid amounts
                if (options.commissionRate > 0) {
                    totalCommissionCalculated += (item.amount * options.commissionRate / 100);
                }
                
                // Manual commission on taxable value
                if (options.manualCommissionRate > 0) {
                    const taxableValue = calculateTaxableValue(item.originalAmount || item.amount, options.applyGST);
                    totalManualCommission += (taxableValue * options.manualCommissionRate / 100);
                }
            });

            results.commissionData = {
                fromColumn: totalCommissionFromColumn,
                calculated: totalCommissionCalculated,
                manual: totalManualCommission,
                rate: options.commissionRate,
                manualRate: options.manualCommissionRate,
                paidCount: paidItems1.length
            };
            
            results.stats = {
                total1: safeNumber(_.sumBy(d1, 'amount')),
                total2: safeNumber(_.sumBy(d2, 'amount')),
                matching1: safeNumber(_.sumBy(results.matching, 'amount1')),
                matching2: safeNumber(_.sumBy(results.matching, 'amount2')),
                totalDiff: safeNumber(_.sumBy(results.matching, 'difference')),
                count1: d1.length,
                count2: d2.length,
                unique1: Object.keys(map1).length,
                unique2: Object.keys(map2).length,
                duplicateAmount1: safeNumber(_.sumBy(results.duplicates1, 'totalAmount')),
                duplicateAmount2: safeNumber(_.sumBy(results.duplicates2, 'totalAmount'))
            };
            results.analysisTime = new Date().toISOString();
            return results;
        }

        // === UI RENDERING ===
        function showError(msg) {
            document.getElementById('error-container').innerHTML = `<div class="error-msg">${msg}</div>`;
        }
        
        function showSuccess(msg) {
            document.getElementById('error-container').innerHTML = `<div class="success-msg">${msg}</div>`;
            setTimeout(() => {
                document.getElementById('error-container').innerHTML = '';
            }, 3000);
        }

        function renderColumnSelectors(parent, headers, cols, sourceNum) {
            const headerOptions = headers.map((h, i) => 
                `<option value="${i}" ${cols.appId === i || cols.amount === i || cols.date === i || cols.paid === i || cols.commission === i ? 'selected' : ''}>${h || `Column ${i+1}`}</option>`
            ).join('');
            
            const commissionSelector = sourceNum === 1 ? `
                <div class="option-group">
                    <label class="option-label">Commission Column</label>
                    <select class="col-select" data-col="commission">
                        <option value="">None</option>
                        ${headerOptions}
                    </select>
                </div>` : '';
            
            parent.innerHTML = `
                <div class="options-grid">
                    <div class="option-group">
                        <label class="option-label">App ID Column *</label>
                        <select class="col-select" data-col="appId">
                            <option value="">Select...</option>
                            ${headerOptions}
                        </select>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Amount Column *</label>
                        <select class="col-select" data-col="amount">
                            <option value="">Select...</option>
                            ${headerOptions}
                        </select>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Date Column</label>
                        <select class="col-select" data-col="date">
                            <option value="">None</option>
                            ${headerOptions}
                        </select>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Paid Status Column</label>
                        <select class="col-select" data-col="paid">
                            <option value="">None</option>
                            ${headerOptions}
                        </select>
                    </div>
                    ${commissionSelector}
                </div>`;
            
            // Set correct selected values
            parent.querySelectorAll('.col-select').forEach(select => {
                const col = select.dataset.col;
                if (cols[col] !== null) {
                    select.value = cols[col];
                }
            });
        }

        function renderResults(res) {
            const duplicates = [...res.duplicates1, ...res.duplicates2];
            const comm = res.commissionData;
            
            resultsContainer.innerHTML = `
                <div class="results-header">
                    <h2 class="results-title">üìä Analysis Results</h2>
                    <div class="results-meta">Time: ${new Date(res.analysisTime).toLocaleString('en-GB', { timeZone: 'UTC' })}</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">Rs ${res.stats.total1.toFixed(2)}</div>
                        <div class="stat-label">Total Source 1</div>
                        <div class="stat-meta">${res.stats.count1} entries</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">Rs ${res.stats.total2.toFixed(2)}</div>
                        <div class="stat-label">Total Source 2</div>
                        <div class="stat-meta">${res.stats.count2} entries</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number">${res.matching.length}</div>
                        <div class="stat-label">Matching IDs</div>
                        <div class="stat-meta">Rs ${res.stats.matching1.toFixed(2)} vs Rs ${res.stats.matching2.toFixed(2)}</div>
                    </div>
                    <div class="stat-card ${res.stats.totalDiff > 0.01 ? 'warning' : 'success'}">
                        <div class="stat-number">Rs ${res.stats.totalDiff.toFixed(2)}</div>
                        <div class="stat-label">Total Difference</div>
                        <div class="stat-meta">Amount mismatches</div>
                    </div>
                    <div class="stat-card ${res.missing.length > 0 ? 'danger' : 'success'}">
                        <div class="stat-number">${res.missing.length}</div>
                        <div class="stat-label">Missing IDs</div>
                        <div class="stat-meta">Not found in either source</div>
                    </div>
                    <div class="stat-card ${duplicates.length > 0 ? 'danger' : 'success'}">
                        <div class="stat-number">${duplicates.length}</div>
                        <div class="stat-label">Duplicate IDs</div>
                        <div class="stat-meta">Rs ${(res.stats.duplicateAmount1 + res.stats.duplicateAmount2).toFixed(2)}</div>
                    </div>
                    <div class="stat-card commission">
                        <div class="stat-number">Rs ${comm.fromColumn.toFixed(2)}</div>
                        <div class="stat-label">Commission (Column)</div>
                        <div class="stat-meta">From source 1 data</div>
                    </div>
                    <div class="stat-card commission">
                        <div class="stat-number">Rs ${comm.calculated.toFixed(2)}</div>
                        <div class="stat-label">Commission (${comm.rate}%)</div>
                        <div class="stat-meta">On ${comm.paidCount} paid entries</div>
                    </div>
                    <div class="stat-card commission">
                        <div class="stat-number">Rs ${comm.manual.toFixed(2)}</div>
                        <div class="stat-label">Manual Commission (${comm.manualRate}%)</div>
                        <div class="stat-meta">On taxable value</div>
                    </div>
                </div>
                ${renderTable('matching', res.matching, res.sortState.matching)}
                ${renderTable('missing', res.missing, res.sortState.missing)}
                ${renderTable('duplicates', duplicates, res.sortState.duplicates)}
                <div class="export-section">
                    <button class="export-btn" id="export-excel-btn">üìä Export Full Report (Excel)</button>
                </div>`;
            resultsContainer.classList.remove('hidden');
        }

        function renderTable(type, data, sortState = {}) {
            if (!data.length) return '';
            
            const titles = {
                matching: 'üü¢ Matching App IDs',
                missing: 'üî¥ Missing App IDs',
                duplicates: '‚ö†Ô∏è Duplicate App IDs'
            };
            
            const headers = {
                matching: [
                    {k:'appId', n:'App ID'},
                    {k:'status', n:'Status'},
                    {k:'amount1', n:'Amount (Src 1)'},
                    {k:'amount2', n:'Amount (Src 2)'},
                    {k:'difference', n:'Difference'},
                    {k:'date1', n:'Date (Src 1)'},
                    {k:'date2', n:'Date (Src 2)'},
                    {k:'branding', n:'Source'},
                    {k:'fileName1', n:'File (Src 1)'},
                    {k:'fileName2', n:'File (Src 2)'}
                ],
                missing: [
                    {k:'appId', n:'App ID'},
                    {k:'missingFrom', n:'Missing From'},
                    {k:'amount', n:'Amount'},
                    {k:'date', n:'Date'},
                    {k:'paid', n:'Paid Status'},
                    {k:'branding', n:'Source'},
                    {k:'fileName', n:'File Name'}
                ],
                duplicates: [
                    {k:'appId', n:'App ID'},
                    {k:'source', n:'Source'},
                    {k:'count', n:'Count'},
                    {k:'totalAmount', n:'Total Amount'}
                ]
            };
            
            const rowClass = {
                matching: r => r.status === 'Match' ? 'highlight-match' : 'highlight-mismatch',
                missing: 'highlight-missing',
                duplicates: 'highlight-mismatch'
            };
            
            const headerHtml = headers[type].map(h => {
                const isSorted = sortState.key === h.k;
                const arrow = isSorted ? (sortState.dir === 'asc' ? '‚ñ≤' : '‚ñº') : '';
                return `<th data-type="${type}" data-key="${h.k}" class="${isSorted ? 'sorted' : ''}" title="Click to sort">${h.n} <span class="sort-arrow">${arrow}</span></th>`;
            }).join('');

            const bodyHtml = data.map(r => {
                let rowContent = '';
                const rowClassStr = typeof rowClass[type] === 'function' ? rowClass[type](r) : rowClass[type];
                
                if (type === 'matching') {
                    rowContent = `
                        <td><strong>${safeString(r.appId)}</strong></td>
                        <td><span class="status-badge ${r.status.toLowerCase().replace(' ', '-')}">${r.status}</span></td>
                        <td>Rs ${safeNumber(r.amount1).toFixed(2)}</td>
                        <td>Rs ${safeNumber(r.amount2).toFixed(2)}</td>
                        <td>Rs ${safeNumber(r.difference).toFixed(2)}</td>
                        <td>${DATE_UTILS.formatDisplay(r.date1)}</td>
                        <td>${DATE_UTILS.formatDisplay(r.date2)}</td>
                        <td>${safeString(r.branding)}</td>
                        <td title="${safeString(r.fileName1)}">${safeString(r.fileName1).substring(0, 20)}${r.fileName1 && r.fileName1.length > 20 ? '...' : ''}</td>
                        <td title="${safeString(r.fileName2)}">${safeString(r.fileName2).substring(0, 20)}${r.fileName2 && r.fileName2.length > 20 ? '...' : ''}</td>`;
                } else if (type === 'missing') {
                    rowContent = `
                        <td><strong>${safeString(r.appId)}</strong></td>
                        <td><span class="status-badge missing">${safeString(r.missingFrom)}</span></td>
                        <td>Rs ${safeNumber(r.amount).toFixed(2)}</td>
                        <td>${DATE_UTILS.formatDisplay(r.date)}</td>
                        <td>${r.paid === null || r.paid === undefined ? 'N/A' : safeString(r.paid)}</td>
                        <td>${safeString(r.branding)}</td>
                        <td title="${safeString(r.fileName)}">${safeString(r.fileName).substring(0, 30)}${r.fileName && r.fileName.length > 30 ? '...' : ''}</td>`;
                } else if (type === 'duplicates') {
                    rowContent = `
                        <td><strong>${safeString(r.appId)}</strong></td>
                        <td>${safeString(r.source)}</td>
                        <td>${safeNumber(r.count)}</td>
                        <td>Rs ${safeNumber(r.totalAmount).toFixed(2)}</td>`;
                }
                
                return `<tr class="${rowClassStr}">${rowContent}</tr>`;
            }).join('');

            return `
                <div class="table-container">
                    <div class="table-header">
                        <span class="table-title">${titles[type]} (${data.length})</span>
                        <button class="view-btn" data-view-type="${type}">Open Full View</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead><tr>${headerHtml}</tr></thead>
                            <tbody>${bodyHtml}</tbody>
                        </table>
                    </div>
                </div>`;
        }
        
        // === EXPORT & VIEW ===
        function exportToExcel() {
            if (!analysisResults) return;
            
            try {
                const wb = XLSX.utils.book_new();
                const res = analysisResults;
                const duplicates = [...res.duplicates1, ...res.duplicates2];

                // Summary sheet
                const summaryData = [
                    ['Analysis Summary', ''],
                    ['Generated At', new Date(res.analysisTime).toLocaleString()],
                    ['', ''],
                    ['Source 1 Total', res.stats.total1],
                    ['Source 2 Total', res.stats.total2],
                    ['Source 1 Count', res.stats.count1],
                    ['Source 2 Count', res.stats.count2],
                    ['', ''],
                    ['Matching IDs', res.matching.length],
                    ['Missing IDs', res.missing.length],
                    ['Duplicate IDs', duplicates.length],
                    ['Total Difference', res.stats.totalDiff],
                    ['', ''],
                    ['Commission from Column', res.commissionData.fromColumn],
                    ['Calculated Commission (' + res.commissionData.rate + '%)', res.commissionData.calculated],
                    ['Manual Commission (' + res.commissionData.manualRate + '%)', res.commissionData.manual]
                ];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), 'Summary');

                // Matching sheet
                const matchingData = res.matching.map(r => ({
                    'App ID': r.appId,
                    'Status': r.status,
                    'Amount Source 1': safeNumber(r.amount1),
                    'Amount Source 2': safeNumber(r.amount2),
                    'Difference': safeNumber(r.difference),
                    'Date Source 1': r.date1,
                    'Date Source 2': r.date2,
                    'Source': r.branding,
                    'File Source 1': r.fileName1,
                    'File Source 2': r.fileName2
                }));
                const wsMatching = XLSX.utils.json_to_sheet(matchingData);
                XLSX.utils.book_append_sheet(wb, wsMatching, 'Matching');
                
                // Missing sheet
                const missingData = res.missing.map(r => ({
                    'App ID': r.appId,
                    'Missing From': r.missingFrom,
                    'Amount': safeNumber(r.amount),
                    'Date': r.date,
                    'Paid Status': r.paid || 'N/A',
                    'Source': r.branding,
                    'File Name': r.fileName
                }));
                const wsMissing = XLSX.utils.json_to_sheet(missingData);
                XLSX.utils.book_append_sheet(wb, wsMissing, 'Missing');
                
                // Duplicates sheet
                if (duplicates.length) {
                    const duplicatesData = duplicates.map(r => ({
                        'App ID': r.appId,
                        'Source': r.source,
                        'Count': r.count,
                        'Total Amount': safeNumber(r.totalAmount)
                    }));
                    const wsDuplicates = XLSX.utils.json_to_sheet(duplicatesData);
                    XLSX.utils.book_append_sheet(wb, wsDuplicates, 'Duplicates');
                }

                const timestamp = new Date().toISOString().replace(/[:\-T]/g, '_').slice(0, 17);
                XLSX.writeFile(wb, `AppID_Analysis_${timestamp}.xlsx`);
                showSuccess('Report exported successfully!');
            } catch (error) {
                showError(`Export failed: ${error.message}`);
            }
        }

        function openFullView(type) {
            if (!analysisResults) return;
            
            const res = analysisResults;
            const duplicates = [...res.duplicates1, ...res.duplicates2];
            const dataMap = {
                matching: res.matching,
                missing: res.missing,
                duplicates
            };
            const data = dataMap[type];
            
            if (!data || !data.length) return;

            const tableHtml = renderTable(type, data, res.sortState[type]);
            const newWindow = window.open("", "_blank", "width=1200,height=800");
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                        <head>
                            <title>Full View: ${type.charAt(0).toUpperCase() + type.slice(1)} - App ID Analyzer</title>
                            <style>
                                body { font-family: sans-serif; padding: 20px; margin: 0; }
                                h1 { color: #1e293b; margin-bottom: 20px; }
                                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                                th, td { padding: 12px 8px; border: 1px solid #e2e8f0; text-align: left; font-size: 0.875rem; }
                                th { background: #f8fafc; font-weight: 600; position: sticky; top: 0; cursor: pointer; user-select: none; }
                                th:hover { background: #e2e8f0; }
                                tr:hover { background: #f8fafc; }
                                .highlight-match { background: #f0fdf4; }
                                .highlight-mismatch { background: #fef2f2; }
                                .highlight-missing { background: #fef3c7; }
                                .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
                                .status-badge.match { background: #d1fae5; color: #065f46; }
                                .status-badge.amount-mismatch { background: #fee2e2; color: #991b1b; }
                                .status-badge.missing { background: #fef3c7; color: #92400e; }
                                .print-btn { position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; }
                                @media print { .print-btn { display: none; } }
                            </style>
                        </head>
                        <body>
                            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print</button>
                            <h1>${type.charAt(0).toUpperCase() + type.slice(1)} App IDs - Full View</h1>
                            <p><strong>Total Records:</strong> ${data.length} | <strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                            ${tableHtml}
                            <script>
                                // Add sorting functionality to the new window
                                document.addEventListener('click', function(e) {
                                    const header = e.target.closest('th[data-key]');
                                    if (!header) return;
                                    
                                    const table = header.closest('table');
                                    const tbody = table.querySelector('tbody');
                                    const rows = Array.from(tbody.querySelectorAll('tr'));
                                    const key = header.dataset.key;
                                    const isNumeric = ['amount', 'amount1', 'amount2', 'difference', 'count', 'totalAmount'].includes(key);
                                    
                                    // Toggle sort direction
                                    const currentDir = header.dataset.sortDir || 'asc';
                                    const newDir = currentDir === 'asc' ? 'desc' : 'asc';
                                    header.dataset.sortDir = newDir;
                                    
                                    // Update arrow
                                    table.querySelectorAll('th .sort-arrow').forEach(arrow => arrow.textContent = '');
                                    header.querySelector('.sort-arrow').textContent = newDir === 'asc' ? '‚ñ≤' : '‚ñº';
                                    
                                    // Sort rows
                                    const colIndex = Array.from(header.parentNode.children).indexOf(header);
                                    rows.sort((a, b) => {
                                        let aVal = a.children[colIndex].textContent.trim();
                                        let bVal = b.children[colIndex].textContent.trim();
                                        
                                        if (isNumeric) {
                                            aVal = parseFloat(aVal.replace(/[^0-9.-]/g, '')) || 0;
                                            bVal = parseFloat(bVal.replace(/[^0-9.-]/g, '')) || 0;
                                            return newDir === 'asc' ? aVal - bVal : bVal - aVal;
                                        } else {
                                            return newDir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                                        }
                                    });
                                    
                                    // Re-append sorted rows
                                    rows.forEach(row => tbody.appendChild(row));
                                });
                            </script>
                        </body>
                    </html>`);
                newWindow.document.close();
            }
        }

        // === EVENT LISTENERS SETUP ===
        async function handleFileSelection(files, isSource1) {
            if (!files.length) return;

            const targetId = isSource1 ? '1' : '2';
            const uploadBox = document.getElementById(`upload-box-${targetId}`);
            const fileInfo = document.getElementById(`file-info-${targetId}`);
            const dynamicContainer = document.getElementById(isSource1 ? 'source1-dynamic' : 'source2-dynamic');

            // Update UI
            uploadBox.classList.add('has-files');
            fileInfo.textContent = `${files.length} file(s) selected`;
            fileInfo.classList.remove('hidden');
            dynamicContainer.innerHTML = '<div class="processing">üîÑ Processing files...</div>';

            // Reset data
            if (isSource1) {
                source1Files = [];
            } else {
                source2Files = [];
            }

            try {
                const filePromises = Array.from(files).map((file, index) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const workbook = XLSX.read(event.target.result, { type: 'binary', cellDates: true });
                                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
                                const headers = jsonData[0] || [];
                                const sample = jsonData.slice(1, 16);
                                const cols = autoDetectColumns(headers, sample);
                                
                                resolve({
                                    file,
                                    data: jsonData,
                                    headers,
                                    cols,
                                    branding: String.fromCharCode(65 + index)
                                });
                            } catch (err) {
                                reject(new Error(`Failed to parse ${file.name}: ${err.message}`));
                            }
                        };
                        reader.onerror = () => reject(new Error(`Failed to read ${file.name}`));
                        reader.readAsArrayBuffer(file);
                    });
                });

                const results = await Promise.all(filePromises);
                
                // Clear processing message
                dynamicContainer.innerHTML = '';

                const targetFiles = isSource1 ? source1Files : source2Files;
                
                results.forEach(fileData => {
                    targetFiles.push(fileData);
                    const container = document.createElement('div');
                    container.className = 'section';
                    container.innerHTML = `<h4 class="section-title">üìÑ Column Mapping for ${fileData.file.name}</h4>`;
                    renderColumnSelectors(container, fileData.headers, fileData.cols, isSource1 ? 1 : 2);
                    dynamicContainer.appendChild(container);
                    
                    // Add event listeners
                    container.querySelectorAll('.col-select').forEach(sel => {
                        sel.addEventListener('change', (ev) => {
                            fileData.cols[ev.target.dataset.col] = ev.target.value === '' ? null : parseInt(ev.target.value);
                            ValidationState.update();
                        });
                    });
                });

                if (isSource1) {
                    source1Files = targetFiles;
                } else {
                    source2Files = targetFiles;
                }

                ValidationState.update();
                
            } catch (error) {
                showError(error.message);
                dynamicContainer.innerHTML = '';
                ValidationState.update();
            }
        }

        function setupEventListeners() {
            // File upload buttons
            document.getElementById('upload-btn-1').addEventListener('click', () => fileInput1.click());
            document.getElementById('upload-btn-2').addEventListener('click', () => fileInput2.click());
            
            // Analyze button
            analyzeBtn.addEventListener('click', analyzeData);

            // File inputs
            fileInput1.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files, true);
                }
            });

            fileInput2.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files, false);
                }
            });

            // Results interactions
            resultsContainer.addEventListener('click', (e) => {
                // Table sorting
                const header = e.target.closest('th[data-key]');
                if (header && analysisResults) {
                    const key = header.dataset.key;
                    const type = header.dataset.type;
                    const currentSort = analysisResults.sortState[type] || {};
                    const dir = (currentSort.key === key && currentSort.dir === 'asc') ? 'desc' : 'asc';
                    
                    const dataMap = {
                        matching: analysisResults.matching,
                        missing: analysisResults.missing,
                        duplicates: [...analysisResults.duplicates1, ...analysisResults.duplicates2]
                    };
                    
                    dataMap[type] = _.orderBy(dataMap[type], [key], [dir]);
                    
                    if (type === 'duplicates') {
                        analysisResults.duplicates1 = dataMap.duplicates.filter(d => d.source === 'Source 1');
                        analysisResults.duplicates2 = dataMap.duplicates.filter(d => d.source === 'Source 2');
                    } else {
                        analysisResults[type] = dataMap[type];
                    }

                    analysisResults.sortState[type] = { key, dir };
                    renderResults(analysisResults);
                    return;
                }
                
                // Full view button
                const viewButton = e.target.closest('.view-btn[data-view-type]');
                if (viewButton) {
                    openFullView(viewButton.dataset.viewType);
                    return;
                }
                
                // Export button
                const exportButton = e.target.closest('#export-excel-btn');
                if (exportButton) {
                    exportToExcel();
                    return;
                }
            });
        }
        
        function updateUserInfo() {
            const now = new Date();
            const utcString = now.toISOString().slice(0, 19).replace('T', ' ');
            document.getElementById('user-info').textContent = `User: ksismad | UTC ${utcString}`;
        }

        // === INITIALIZATION ===
        setupEventListeners();
