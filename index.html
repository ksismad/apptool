<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>App ID Analyzer ‚Äì Complete Analysis System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    * { box-sizing:border-box; }
    body {
      margin:0; padding:20px;
      font-family:-apple-system,Segoe UI,sans-serif;
      background:#f3f4f6;
    }
    .container {
      max-width:1400px; margin:0 auto;
      background:#fff; border-radius:16px;
      box-shadow:0 20px 25px rgba(0,0,0,0.1);
      overflow:hidden;
    }
    .header {
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      color:#fff; text-align:center; padding:32px;
      position:relative;
    }
    .header h1 { margin:0 0 12px; font-size:2.25rem; }
    .header p { margin:0; opacity:.9; }
    .user-info {
      position:absolute; top:16px; right:24px;
      background:rgba(255,255,255,0.2); padding:6px 12px;
      border-radius:20px; font-size:.875rem;
      backdrop-filter:blur(8px);
    }
    .main-content { padding:32px; }
    .upload-section { display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:32px; }
    .upload-box {
      background:#f8fafc; border-radius:12px; padding:24px;
      text-align:center; border:2px dashed #cbd5e1; transition:.3s;
    }
    .upload-box:hover { border-color:#6366f1; transform:translateY(-2px); }
    .upload-box.has-files { border-color:#10b981; background:#ecfdf5; }
    .upload-btn {
      margin-top:16px; padding:12px 24px; border:none;
      background:linear-gradient(135deg,#6366f1,#8b5cf6);
      color:#fff; border-radius:8px; cursor:pointer; transition:.2s;
    }
    .upload-btn:hover { transform:translateY(-1px); }
    .file-info {
      display:inline-block; margin-top:12px;
      padding:8px 16px; background:#d1fae5; color:#059669;
      border-radius:6px; font-weight:600;
    }
    .file-input { display:none; }
    .section { background:#f8fafc; padding:24px; margin-bottom:32px; border-radius:12px; border:1px solid #e2e8f0; }
    .section-title {
      font-size:1.125rem; font-weight:600; margin:0 0 16px;
      display:flex; align-items:center; gap:8px;
    }
    .date-filter-grid,
    .options-grid { display:grid; gap:24px; }
    .date-filter-grid { grid-template-columns:1fr 1fr; }
    .options-grid { grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); }
    .option-group,
    .date-filter-group { background:#fff; padding:16px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    .option-label,
    .date-filter-label { display:block; margin-bottom:8px; font-weight:600; color:#374151; }
    .date-range { display:flex; align-items:center; gap:12px; }
    .date-input,
    .col-select,
    .commission-input {
      width:100%; padding:8px 12px; border:1px solid #d1d5db;
      border-radius:6px; font-size:.925rem; background:#fff;
    }
    .checkbox-group,
    .input-group { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .validation-item {
      display:flex; align-items:center; gap:8px; margin-bottom:8px;
      font-size:.875rem;
    }
    .validation-item.valid { color:#059669; }
    .validation-item.invalid { color:#dc2626; }
    .validation-item.valid::before { content:"‚úÖ"; }
    .validation-item.invalid::before { content:"‚ùå"; }
    .analyze-btn {
      width:100%; padding:16px; border:none;
      background:linear-gradient(135deg,#10b981,#059669);
      color:#fff; border-radius:12px; font-size:1.125rem;
      font-weight:700; cursor:pointer; transition:.2s;
    }
    .analyze-btn:disabled { background:#9ca3af; cursor:not-allowed; }
    .analyze-btn:not(:disabled):hover { transform:translateY(-2px); }
    .stats-grid {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px; margin-bottom:32px;
    }
    .stat-card {
      background:#fff; padding:20px; border-radius:12px;
      box-shadow:0 4px 6px rgba(0,0,0,0.1);
      text-align:center; border-left:4px solid #6366f1;
    }
    .stat-card.success { border-left-color:#10b981; }
    .stat-card.warning { border-left-color:#f59e0b; }
    .stat-card.danger { border-left-color:#ef4444; }
    .stat-card.commission { border-left-color:#8b5cf6; }
    .stat-number { font-size:1.875rem; font-weight:700; }
    .stat-label { font-size:.875rem; font-weight:500; text-transform:uppercase; color:#64748b; }
    .stat-meta { font-size:.75rem; color:#94a3b8; margin-top:4px; }
    .table-container {
      background:#fff; border-radius:12px; overflow:hidden;
      box-shadow:0 4px 6px rgba(0,0,0,0.1); margin-bottom:24px;
    }
    .table-header {
      display:flex; justify-content:space-between; align-items:center;
      background:#f8fafc; padding:16px; border-bottom:1px solid #e2e8f0;
    }
    .table-title { font-size:1.125rem; font-weight:600; }
    .table-wrapper { overflow:auto; max-height:400px; }
    table { width:100%; border-collapse:collapse; }
    th, td {
      padding:12px 16px; border-bottom:1px solid #e2e8f0;
      font-size:.875rem; white-space:nowrap;
    }
    th {
      position:sticky; top:0; background:#f8fafc; cursor:pointer;
      user-select:none; font-weight:600; color:#374151;
    }
    th:hover { background:#e2e8f0; }
    .sort-arrow { margin-left:5px; opacity:.5; }
    th.sorted .sort-arrow { opacity:1; }
    tr:hover { background:#f8fafc; }
    .highlight-match { background:#f0fdf4; }
    .highlight-mismatch { background:#fef2f2; }
    .highlight-missing { background:#fef3c7; }
    .status-badge {
      padding:4px 8px; border-radius:6px; font-size:.75rem;
      font-weight:600; text-transform:uppercase;
    }
    .status-badge.match { background:#d1fae5; color:#065f46; }
    .status-badge.amount-mismatch { background:#fee2e2; color:#991b1b; }
    .status-badge.missing { background:#fef3c7; color:#92400e; }
    .export-section { display:flex; justify-content:center; gap:16px; margin-top:32px; }
    .export-btn,
    .view-btn {
      padding:12px 24px; border:none; border-radius:8px;
      background:#1e293b; color:#fff; cursor:pointer;
      transition:.2s; font-weight:600;
    }
    .export-btn:hover,
    .view-btn:hover { background:#334155; transform:translateY(-1px); }
    .view-btn { background:#4f46e5; }
    .error-msg,
    .success-msg {
      margin:16px 0; padding:12px 16px;
      border-left:4px solid; border-radius:8px;
    }
    .error-msg { background:#fef2f2; color:#dc2626; border-color:#dc2626; }
    .success-msg { background:#ecfdf5; color:#059669; border-color:#059669; }
    .loading,
    .processing { text-align:center; padding:40px; color:#6b7280; }
    .hidden { display:none!important; }
    @media(max-width:768px){
      .upload-section,.date-filter-grid,.options-grid{grid-template-columns:1fr;}
      .stats-grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div id="user-info" class="user-info"></div>
      <h1>üîç App ID Analyzer</h1>
      <p>Multi-file Excel analysis with filters, GST, commissions, and export.</p>
    </div>
    <div class="main-content">
      <div class="upload-section">
        <div class="upload-box" id="upload-box-1">
          <h3>üìÇ Source 1 Files</h3>
          <p>Select one or more Excel files</p>
          <input id="file-input-1" type="file" class="file-input" multiple accept=".xlsx,.xls">
          <button id="upload-btn-1" class="upload-btn">Choose Files</button>
          <div id="file-info-1" class="file-info hidden"></div>
        </div>
        <div class="upload-box" id="upload-box-2">
          <h3>üìÇ Source 2 Files</h3>
          <p>Select one or more Excel files</p>
          <input id="file-input-2" type="file" class="file-input" multiple accept=".xlsx,.xls">
          <button id="upload-btn-2" class="upload-btn">Choose Files</button>
          <div id="file-info-2" class="file-info hidden"></div>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">üìÖ Date Range Filters (UTC)</h3>
        <div class="date-filter-grid">
          <div class="date-filter-group">
            <label class="date-filter-label">Source 1 Range</label>
            <div class="date-range">
              <input id="dateFrom1" class="date-input" type="date">
              <span>to</span>
              <input id="dateTo1" class="date-input" type="date">
            </div>
          </div>
          <div class="date-filter-group">
            <label class="date-filter-label">Source 2 Range</label>
            <div class="date-range">
              <input id="dateFrom2" class="date-input" type="date">
              <span>to</span>
              <input id="dateTo2" class="date-input" type="date">
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h3 class="section-title">‚öôÔ∏è Analysis & Commission</h3>
        <div class="options-grid">
          <div class="option-group">
            <label class="option-label">Payment Filter</label>
            <div class="checkbox-group">
              <input id="includeUnpaid1" type="checkbox">
              <label for="includeUnpaid1">Include unpaid (Src1)</label>
            </div>
          </div>
          <div class="option-group">
            <label class="option-label">GST Calculation (18%)</label>
            <div class="checkbox-group">
              <input id="applyGST" type="checkbox">
              <label for="applyGST">Apply GST</label>
            </div>
            <div class="checkbox-group">
              <input id="gstRound" type="checkbox">
              <label for="gstRound">Round Off</label>
            </div>
          </div>
          <div class="option-group">
            <label class="option-label">Commission Rate (%)</label>
            <div class="input-group">
              <input id="commissionRate" type="number" class="commission-input" placeholder="e.g. 5" min="0" max="100" step="0.01">
              <label>% on paid</label>
            </div>
          </div>
          <div class="option-group">
            <label class="option-label">Manual Commission (%)</label>
            <div class="input-group">
              <input id="manualCommissionRate" type="number" class="commission-input" placeholder="e.g. 2.5" min="0" max="100" step="0.01">
              <label>% on taxable</label>
            </div>
          </div>
        </div>
      </div>

      <div id="source1-dynamic"></div>
      <div id="source2-dynamic"></div>

      <div id="validation-status" class="section">
        <h3 class="section-title">üìã Validation</h3>
        <div id="validation-items"></div>
      </div>

      <button id="analyze-btn" class="analyze-btn" disabled>üîç Analyze</button>

      <div id="error-container"></div>
      <div id="results" class="results hidden"></div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // State
    let src1Files = [], src2Files = [], analysisResults = null;

    // Elements
    const in1=document.getElementById('file-input-1'),
          in2=document.getElementById('file-input-2'),
          b1=document.getElementById('upload-btn-1'),
          b2=document.getElementById('upload-btn-2'),
          analyzeBtn=document.getElementById('analyze-btn'),
          resultsDiv=document.getElementById('results');

    // Helpers
    const safeNum=v=>{const n=parseFloat(v);return isNaN(n)?0:n},
          safeStr=v=>v==null?'':String(v),
          excelToDate=s=>new Date((s-25569)*86400000),
          tryParseDate=v=>{
            if(!v&&v!==0) return null;
            if(typeof v==='number'&&v>60) return excelToDate(v);
            const d=new Date(v);return isNaN(d)?null:d;
          },
          toUTC=(d)=>d?`${String(d.getUTCDate()).padStart(2,'0')}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${d.getUTCFullYear()}`:'',
          updateTime=()=>{
            document.getElementById('user-info').textContent=
              'User: ksismad | UTC '+new Date().toISOString().slice(0,19).replace('T',' ');
          };

    function updateValidation(){
      const ok1=src1Files.length>0&&src1Files.every(f=>f.cols.appId!=null&&f.cols.amount!=null),
            ok2=src2Files.length>0&&src2Files.every(f=>f.cols.appId!=null&&f.cols.amount!=null);
      document.getElementById('validation-items').innerHTML=[
        {t:`Src1 files (${src1Files.length})`,v:src1Files.length>0},
        {t:`Src2 files (${src2Files.length})`,v:src2Files.length>0},
        {t:'Src1 cols set',v:ok1},
        {t:'Src2 cols set',v:ok2},
      ].map(x=>`<div class="validation-item ${x.v?'valid':'invalid'}">${x.t}</div>`).join('');
      const can=ok1&&ok2;
      analyzeBtn.disabled=!can;
      analyzeBtn.textContent=can?'üîç Analyze':'üìã Complete setup';
    }

    function autoDetect(headers,sample){
      const lc=headers.map(h=>safeStr(h).replace(/^\uFEFF/,'').trim().toLowerCase());
      const cols={appId:null,amount:null,date:null,paid:null,commission:null};
      const patterns={
        appId:[/\bapp[\s_]*id/,/^id$/],
        amount:[/\b(amount|total|amt)\b/],
        paid:[/\b(paid|status)\b/],
        commission:[/\b(comm(ission)?|fee)\b/]
      };
      for(let key in patterns){
        cols[key]=lc.findIndex(h=>patterns[key].some(re=>re.test(h)));
        if(cols[key]<0) cols[key]=null;
      }
      const scores=Array(headers.length).fill(0);
      sample.slice(0,20).forEach(r=>{
        if(Array.isArray(r))r.forEach((c,i)=>{
          const d=tryParseDate(c);
          if(d) scores[i]++;
        });
      });
      const idx=scores.indexOf(Math.max(...scores));
      if(idx>=0&&scores[idx]>1) cols.date=idx;
      return cols;
    }

    async function handleFiles(files,isSrc1){
      const box=document.getElementById('upload-box-'+(isSrc1?1:2)),
            info=document.getElementById('file-info-'+(isSrc1?1:2)),
            dyn=document.getElementById(isSrc1?'source1-dynamic':'source2-dynamic');
      box.classList.add('has-files');
      info.textContent=files.length+' file(s)';
      info.classList.remove('hidden');
      dyn.innerHTML='<div class="processing">üîÑ Processing...</div>';
      if(isSrc1) src1Files=[]; else src2Files=[];
      try{
        const arr=[];
        for(let i=0;i<files.length;i++){
          const file=files[i];
          const data=await new Promise((res,rej)=>{
            const r=new FileReader();
            r.onload=_=>res(r.result);
            r.onerror=_=>rej('Read error');
            r.readAsArrayBuffer(file);
          });
          const wb=XLSX.read(data,{type:'array',cellDates:true});
          const ws=wb.Sheets[wb.SheetNames[0]];
          const json=XLSX.utils.sheet_to_json(ws,{header:1,raw:false});
          const hdr=json[0]||[], sample=json.slice(1,21);
          const cols=autoDetect(hdr,sample);
          arr.push({file,hdr,cols,data:json,branding:String.fromCharCode(65+i)});
        }
        dyn.innerHTML='';
        arr.forEach(o=>{
          const sec=document.createElement('div');
          sec.className='section';
          sec.innerHTML=`<h4 class="section-title">Map ‚Äì ${o.file.name}</h4>`;
          dyn.appendChild(sec);
          renderMapping(sec,o.hdr,o.cols,isSrc1?1:2);
        });
        if(isSrc1) src1Files=arr; else src2Files=arr;
      }catch(e){
        dyn.innerHTML='';
        showError('Error: '+e);
      }
      updateValidation();
    }

    function renderMapping(container,headers,cols,src){
      const opts=headers.map((h,i)=>`<option value="${i}" ${[cols.appId,cols.amount,cols.date,cols.paid,cols.commission].includes(i)?'selected':''}>${h||'Col '+(i+1)}</option>`).join('');
      const commSel=src===1?`
        <div class="option-group">
          <label class="option-label">Comm Column</label>
          <select class="col-select" data-col="commission"><option value="">None</option>${opts}</select>
        </div>`:'';
      container.innerHTML=`
      <div class="options-grid">
        <div class="option-group"><label class="option-label">App ID *</label><select class="col-select" data-col="appId"><option value="">‚Ä¶</option>${opts}</select></div>
        <div class="option-group"><label class="option-label">Amount *</label><select class="col-select" data-col="amount"><option value="">‚Ä¶</option>${opts}</select></div>
        <div class="option-group"><label class="option-label">Date</label><select class="col-select" data-col="date"><option value="">None</option>${opts}</select></div>
        <div class="option-group"><label class="option-label">Paid Status</label><select class="col-select" data-col="paid"><option value="">None</option>${opts}</select></div>
        ${commSel}
      </div>`;
      container.querySelectorAll('.col-select').forEach(sel=>{
        sel.addEventListener('change',e=>{
          cols[e.target.dataset.col] = e.target.value===''?null:+e.target.value;
          updateValidation();
        });
      });
    }

    function showError(m){
      document.getElementById('error-container').innerHTML=`<div class="error-msg">${m}</div>`;
    }
    function showSuccess(m){
      document.getElementById('error-container').innerHTML=`<div class="success-msg">${m}</div>`;
      setTimeout(_=>document.getElementById('error-container').textContent='',3000);
    }

    function analyze(){
      resultsDiv.innerHTML='<div class="loading">üîÑ Analyzing...</div>';
      resultsDiv.classList.remove('hidden');
      setTimeout(()=>{
        try{
          // gather options
          const f1=parseDate(document.getElementById('dateFrom1').value),
                t1=parseDate(document.getElementById('dateTo1').value),
                f2=parseDate(document.getElementById('dateFrom2').value),
                t2=parseDate(document.getElementById('dateTo2').value);
          const includeUnpaid=document.getElementById('includeUnpaid1').checked;
          const applyGST=document.getElementById('applyGST').checked;
          const roundGST=document.getElementById('gstRound').checked;
          const commRate=safeNum(document.getElementById('commissionRate').value);
          const manualRate=safeNum(document.getElementById('manualCommissionRate').value);

          // process records
          const proc=(arr,src)=>{
            return arr.flatMap(o=>{
              const recs=[];
              for(let i=1;i<o.data.length;i++){
                const row=o.data[i];
                if(!row||!row[o.cols.appId])continue;
                const appId=safeStr(row[o.cols.appId]).trim();
                if(!appId)continue;
                recs.push({
                  appId,amount:safeNum(row[o.cols.amount]),
                  paid:o.cols.paid!=null?safeStr(row[o.cols.paid]):null,
                  date:o.cols.date!=null?tryParseDate(row[o.cols.date]):null,
                  commission:o.cols.commission!=null?safeNum(row[o.cols.commission]):0,
                  branding:o.branding, fileName:o.file.name, src
                });
              }
              return recs;
            });
          };
          let d1=proc(src1Files,1), d2=proc(src2Files,2);

          // apply date filter
          if(f1||t1) d1=d1.filter(d=>d.date && (!f1||d.date>=f1)&&(!t1||d.date<=t1));
          if(f2||t2) d2=d2.filter(d=>d.date && (!f2||d.date>=f2)&&(!t2||d.date<=t2));

          // payment filter & gst
          if(!includeUnpaid) d1=d1.filter(d=>String(d.paid||'').toLowerCase()==='paid');
          if(applyGST) d1.forEach(d=>{
            d.base=d.amount;
            d.amount=roundGST?Math.round(d.amount*1.18):d.amount*1.18;
          });

          // compare
          const m1=_.groupBy(d1,'appId'), m2=_.groupBy(d2,'appId');
          const all=_.union(Object.keys(m1),Object.keys(m2));
          const matching=[], missing=[], dup1=[], dup2=[];
          all.forEach(id=>{
            const a=m1[id], b=m2[id];
            if(a&&b){
              const s1=_.sumBy(a,'amount'), s2=_.sumBy(b,'amount'), diff=Math.abs(s1-s2);
              matching.push({appId:id,amount1:s1,amount2:s2,difference:diff,
                status:diff<0.01?'Match':'Amount Mismatch',
                date1:a.find(x=>x.date)?.date,date2:b.find(x=>x.date)?.date,
                branding:a[0].branding,file1:a[0].fileName,file2:b[0].fileName
              });
            } else {
              const arr=a||b;
              missing.push({
                appId:id,amount:_.sumBy(arr,'amount'),
                missingFrom:a?'Source 2':'Source 1',
                date:arr.find(x=>x.date)?.date,
                paid:arr[0].paid,branding:arr[0].branding,fileName:arr[0].fileName
              });
            }
          });
          Object.keys(m1).forEach(id=>{ if(m1[id].length>1) dup1.push({appId:id,count:m1[id].length,total:_.sumBy(m1[id],'amount')} )});
          Object.keys(m2).forEach(id=>{ if(m2[id].length>1) dup2.push({appId:id,count:m2[id].length,total:_.sumBy(m2[id],'amount')} )});

          // commissions
          const paid1=d1.filter(d=>String(d.paid||'').toLowerCase()==='paid');
          let colC=0,calcC=0,manC=0;
          paid1.forEach(x=>{
            colC+=x.commission||0;
            calcC+=x.amount*(commRate/100);
            const tx=applyGST?(x.base||x.amount)/1.18:(x.base||x.amount);
            manC+=tx*(manualRate/100);
          });

          analysisResults={
            matching,missing,duplicates1:dup1,duplicates2:dup2,
            stats:{
              total1:_.sumBy(d1,'amount'), total2:_.sumBy(d2,'amount'),
              matchCount:matching.length, missingCount:missing.length, dupCount:dup1.length+dup2.length,
              diffTotal:_.sumBy(matching,'difference')
            },
            commission:{col:colC,calc:calcC,man:manC,rate:commRate,manual:manualRate},
            sortState:{}, time:new Date().toISOString()
          };

          renderResults();
          showSuccess('Analysis complete');
        }catch(e){
          showError('Error: '+e.message);
        }
      },100);
    }

    function renderResults(){
      const R=analysisResults, m=R.matching, miss=R.missing, dup=[...R.duplicates1,...R.duplicates2];
      let out=`<div class="results-header">
        <h2 class="results-title">üìä Results</h2>
        <div class="results-meta">UTC ${new Date(R.time).toLocaleString()}</div>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-number">Rs ${R.stats.total1.toFixed(2)}</div><div class="stat-label">Src1 Total</div></div>
        <div class="stat-card"><div class="stat-number">Rs ${R.stats.total2.toFixed(2)}</div><div class="stat-label">Src2 Total</div></div>
        <div class="stat-card success"><div class="stat-number">${R.stats.matchCount}</div><div class="stat-label">Matching IDs</div></div>
        <div class="stat-card warning"><div class="stat-number">Rs ${R.stats.diffTotal.toFixed(2)}</div><div class="stat-label">Total Diff</div></div>
        <div class="stat-card ${R.stats.missingCount>0?'danger':'success'}"><div class="stat-number">${R.stats.missingCount}</div><div class="stat-label">Missing IDs</div></div>
        <div class="stat-card ${R.stats.dupCount>0?'danger':'success'}"><div class="stat-number">${R.stats.dupCount}</div><div class="stat-label">Duplicates</div></div>
        <div class="stat-card commission"><div class="stat-number">Rs ${R.commission.col.toFixed(2)}</div><div class="stat-label">Comm (col)</div></div>
        <div class="stat-card commission"><div class="stat-number">Rs ${R.commission.calc.toFixed(2)}</div><div class="stat-label">Comm ${R.commission.rate}%</div></div>
        <div class="stat-card commission"><div class="stat-number">Rs ${R.commission.man.toFixed(2)}</div><div class="stat-label">Manual ${R.commission.manual}%</div></div>
      </div>`;
      function tbl(type,data){
        if(!data.length) return '';
        const titles={matching:'üü¢ Matching', missing:'üî¥ Missing', duplicates:'‚ö†Ô∏è Duplicates'}[type];
        const hdrs={matching:['App ID','Status','Amt1','Amt2','Diff','D1','D2','Src','File1','File2'],
                    missing:['App ID','From','Amt','Date','Paid','Src','File'],
                    duplicates:['App ID','Src','Count','Total']}[type];
        const th=hdrs.map((h,i)=>`<th data-type="${type}" data-idx="${i}">${h} <span class="sort-arrow"></span></th>`).join('');
        const rows=data.map(r=>{
          if(type==='matching'){
            return `<tr class="${r.status==='Match'?'highlight-match':'highlight-mismatch'}">
              <td>${r.appId}</td><td><span class="status-badge ${r.status==='Match'?'match':'amount-mismatch'}">${r.status}</span></td>
              <td>Rs ${r.amount1.toFixed(2)}</td><td>Rs ${r.amount2.toFixed(2)}</td><td>Rs ${r.difference.toFixed(2)}</td>
              <td>${toUTC(r.date1)}</td><td>${toUTC(r.date2)}</td>
              <td>${r.branding}</td><td>${r.file1}</td><td>${r.file2}</td>
            </tr>`;
          } else if(type==='missing'){
            return `<tr class="highlight-missing">
              <td>${r.appId}</td><td>${r.missingFrom}</td><td>Rs ${r.amount.toFixed(2)}</td>
              <td>${toUTC(r.date)}</td><td>${r.paid||'N/A'}</td><td>${r.branding}</td><td>${r.fileName}</td>
            </tr>`;
          } else {
            return `<tr class="highlight-mismatch">
              <td>${r.appId}</td><td>${r.source}</td><td>${r.count}</td><td>Rs ${r.total.toFixed(2)}</td>
            </tr>`;
          }
        }).join('');
        return `<div class="table-container">
          <div class="table-header">
            <span class="table-title">${titles} (${data.length})</span>
            <button class="view-btn" data-view="${type}">Full View</button>
          </div>
          <div class="table-wrapper">
            <table><thead><tr>${th}</tr></thead><tbody>${rows}</tbody></table>
          </div>
        </div>`;
      }
      out+=tbl('matching',m)+tbl('missing',miss)+tbl('duplicates',dup);
      out+=`<div class="export-section"><button id="export-excel-btn" class="export-btn">üìä Export Excel</button></div>`;
      resultsDiv.innerHTML=out;
    }

    function exportExcel(){
      if(!analysisResults)return;
      const wb=XLSX.utils.book_new(),R=analysisResults;
      // Summary sheet
      const sum=[['Key','Value'],['Generated',new Date(R.time).toLocaleString()]];
      sum.push([],['Src1 Total',R.stats.total1],['Src2 Total',R.stats.total2],
               ['Matching',R.stats.matchCount],['Missing',R.stats.missingCount],
               ['Duplicates',R.stats.dupCount],['Total Diff',R.stats.diffTotal],
               [],['Comm col',R.commission.col],
               [`Comm ${R.commission.rate}%`,R.commission.calc],
               [`Manual ${R.commission.manual}%`,R.commission.man]);
      XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(sum),'Summary');
      // Matching
      const mdata=R.matching.map(r=>({
        'App ID':r.appId,'Status':r.status,'Amt1':r.amount1,'Amt2':r.amount2,
        'Diff':r.difference,'Date1':r.date1,'Date2':r.date2,
        'Src':r.branding,'File1':r.file1,'File2':r.file2
      }));
      XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(mdata),'Matching');
      // Missing
      const misdata=R.missing.map(r=>({
        'App ID':r.appId,'From':r.missingFrom,'Amt':r.amount,
        'Date':r.date,'Paid':r.paid,'Src':r.branding,'File':r.fileName
      }));
      XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(misdata),'Missing');
      // Duplicates
      const dup=[...R.duplicates1,...R.duplicates2].map(r=>({
        'App ID':r.appId,'Src':r.source,'Count':r.count,'Total':r.total
      }));
      if(dup.length) XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(dup),'Duplicates');
      const ts=new Date().toISOString().replace(/[:\-T]/g,'_').slice(0,17);
      XLSX.writeFile(wb,`AppID_Analysis_${ts}.xlsx`);
    }

    function openView(type){
      const R=analysisResults;
      const arr={matching:R.matching,missing:R.missing,duplicates:[...R.duplicates1,...R.duplicates2]}[type];
      if(!arr.length)return;
      const w=window.open('','_blank','width=1200,height=800');
      let html=`<html><head><title>Full ${type}</title>
        <style>body{font-family:sans-serif;padding:20px}table{width:100%;border-collapse:collapse}th,td{padding:8px;border:1px solid #ddd;white-space:nowrap}</style>
      </head><body><h1>Full View: ${type}</h1><table><thead><tr>`;
      const hdrs={matching:['App ID','Status','Amt1','Amt2','Diff','Date1','Date2','Src'],
                  missing:['App ID','From','Amt','Date','Paid','Src'],
                  duplicates:['App ID','Src','Count','Total']}[type];
      hdrs.forEach(h=>html+=`<th>${h}</th>`);
      html+=`</tr></thead><tbody>`;
      arr.forEach(r=>{
        html+='<tr>';
        if(type==='matching'){
          html+=`<td>${r.appId}</td><td>${r.status}</td><td>${r.amount1}</td><td>${r.amount2}</td>
                 <td>${r.difference}</td><td>${toUTC(r.date1)}</td><td>${toUTC(r.date2)}</td><td>${r.branding}</td>`;
        } else if(type==='missing'){
          html+=`<td>${r.appId}</td><td>${r.missingFrom}</td><td>${r.amount}</td>
                 <td>${toUTC(r.date)}</td><td>${r.paid||'N/A'}</td><td>${r.branding}</td>`;
        } else {
          html+=`<td>${r.appId}</td><td>${r.source}</td><td>${r.count}</td><td>${r.total}</td>`;
        }
        html+='</tr>';
      });
      html+=`</tbody></table></body></html>`;
      w.document.write(html);
      w.document.close();
    }

    // Event hookup
    b1.addEventListener('click',()=>in1.click());
    b2.addEventListener('click',()=>in2.click());
    in1.addEventListener('change',e=>handleFiles(e.target.files,true));
    in2.addEventListener('change',e=>handleFiles(e.target.files,false));
    analyzeBtn.addEventListener('click',analyze);
    resultsDiv.addEventListener('click',e=>{
      if(e.target.id==='export-excel-btn') return exportExcel();
      const v=e.target.closest('.view-btn');
      if(v) return openView(v.dataset.view);
    });

    // Initialize
    updateTime();
    setInterval(updateTime,1000);
    updateValidation();
  });
  </script>
</body>
</html>
